<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Undo</title>
  
  <subtitle>Move fast and break things.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="/"/>
  <updated>2019-09-05T08:24:11.832Z</updated>
  <id>/</id>
  
  <author>
    <name>Undo</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>React Hooks + Context 打造简版redux</title>
    <link href="/react-hooks-redux/"/>
    <id>/react-hooks-redux/</id>
    <published>2019-09-04T16:00:00.000Z</published>
    <updated>2019-09-05T08:24:11.832Z</updated>
    
    <content type="html"><![CDATA[<p>React Hooks 在 <a href="mailto:react@10.8" target="_blank" rel="noopener">react@10.8</a> 中已经发布，刚发布的时候自己也进行了简单的学习，之前也写过一篇<a href="https://www.songqibin.cn/react-hooks/" target="_blank" rel="noopener">学习 hooks 基础用法</a>的文章。学习之后用到的场景并不多，最近再次学习并在项目中应用起来，真正体会到它的强大之处。</p><p>本文呢不再是介绍基础的 hooks API 的应用，而是基于hooks如何实现类似 <code>redux</code> 这样的状态管理。<br><a id="more"></a></p><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>做 <code>react</code> 项目，一般按照正常的流程写组件就能满足业务场景，随着业务复杂度的增加，数据交互会变的复杂，会逐渐考虑到使用工具或者库来管理数据，常见的就是 redux、mbox、dva 等。</p><p>使用 <code>react hooks</code> 的时候，我们发现它提供了很多的 api 供我们操作数据，那么如何才能利用这些 api 实现类似 redux 这样的数据管理呢。</p><p><code>redux</code> 集中管理数据，通过 <code>Provider</code> 组件将数据共享给子组件，然后再通过 <code>connect</code> 将 store 与组件进行连接，这是 redux 最核心的功能。</p><p>这里的核心就是实现数据共享，这时我们可以使用 Context 来实现。<code>Context</code> 本意是上下文，它提供一个 <code>Provider</code> 和一个 <code>Consumer</code>，也就是生产者/消费者模式，在某个顶层提供一个 <code>Provider</code> ，下面的子元素通过 <code>Consumer</code> 来消费 <code>Provider</code> 里的数据和方法。 </p><p>通过这个概念，我们把不同层级里的组件共享同一个顶层 <code>Provider</code>，并且组件内部使用 <code>Consumer</code> 来消费共享数据。</p><p>当我们能共享数据后，还剩一个问题就是如何更改 <code>Provider</code> 里的数据呢？答案是：<code>useReducer</code>。</p><p>有了这样的思路，我们一步步来实现它。</p><h3 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h3><h4 id="1-props传递"><a href="#1-props传递" class="headerlink" title="1. props传递"></a>1. props传递</h4><p>如果我们有一个场景，两个字组件需要共享父组件的状态，我们通常的做法是在父组件中定义状态，再通过 <code>props</code>  传递给子组件，实现状态共享。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> colors = [<span class="string">'red'</span>, <span class="string">'blue'</span>]</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;&gt;</span><br><span class="line">            &lt;Child1 color=&#123;colors[<span class="number">0</span>]&#125; /&gt;</span><br><span class="line">            &lt;Child2 color=&#123;colors[<span class="number">1</span>]&#125; /&gt;</span><br><span class="line">        &lt;<span class="regexp">/&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Child1(props) &#123;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">        &lt;div style=&#123;&#123; background: props.color &#125;&#125;&gt;I am &#123;props.color&#125;&lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child2</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div style=&#123;&#123; <span class="attr">background</span>: props.color &#125;&#125;&gt;I am &#123;props.color&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这是最简单的实现方式，子组件可以共享到父组件的状态。但是如果子组件层级加深被嵌套在很深的组件层级中，那么这个状态也需要一层层往下传递，这可能也是我们经常遇到的问题，这也是为什么我们会使用 <code>redux</code> 这种状态管理库的原因。</p><h4 id="2-使用Context"><a href="#2-使用Context" class="headerlink" title="2. 使用Context"></a>2. 使用Context</h4><p>接下来使用 <code>Context</code> ，通过 <code>createContext</code> 创建需要的 <code>Context</code> ，再在子组件中通过 <code>useContext</code> 拿到共享数据。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Context = React.createContext(<span class="literal">null</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> initState = &#123;</span><br><span class="line">        colors: [<span class="string">"red"</span>, <span class="string">"blue"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;Context.Provider value=&#123;initState&#125;&gt;</span><br><span class="line">            &lt;Child1 /&gt;</span><br><span class="line">            &lt;Child2 /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Child1() &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; colors &#125; = React.useContext(Context)</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">        &lt;div style=&#123;&#123; background: colors[0] &#125;&#125;&gt;I am &#123;colors[0]&#125;&lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; colors &#125; = React.useContext(Context)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div style=&#123;&#123; <span class="attr">background</span>: colors[<span class="number">1</span>] &#125;&#125;&gt;I am &#123;colors[<span class="number">1</span>]&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这样我们就摆脱使用 <code>props</code> 传递状态也同样实现共享状态。</p><h4 id="3-更新状态"><a href="#3-更新状态" class="headerlink" title="3. 更新状态"></a>3. 更新状态</h4><p>上面已经能拿到数据，进一步实现点击元素修改颜色，这里就需要使用到 <code>useReducer</code> 来模拟触发改变。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, colors &#125; = action</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'CHANGE_COLOR'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; colors &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个 <code>reducer</code>，是不是很熟悉，和 <code>redux</code> 中的 <code>reducer</code> 几乎一样，这里对 <code>action</code> 做了简化处理。</p><p><code>useReducer</code> 方法会接受一个 <code>reducer</code> 和 <code>state</code>，返回 <code>state</code> 和 <code>dispatch</code> ，我们再把 <code>state</code> 和 <code>dispatch</code> 通过 <code>Provider</code> 共享给子组件使用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> initState = &#123;</span><br><span class="line">        colors: [<span class="string">"red"</span>, <span class="string">"blue"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> [state, dispatch] = React.useReducer(reducer, initState)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;Context.Provider value=&#123;&#123; <span class="attr">colors</span>: state.colors, dispatch&#125;&#125;&gt;</span><br><span class="line">            &lt;Child1 /&gt;</span><br><span class="line">            &lt;Child2 /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>子组件中拿到 <code>dispatch</code> 并改变 <code>colors</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(React.useContext(Context)) <span class="comment">// &#123;colors: Array(2), dispatch: ƒ&#125;</span></span><br><span class="line">    <span class="keyword">const</span> &#123; colors, dispatch &#125; = React.useContext(Context)</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;div style=&#123;&#123; <span class="attr">background</span>: colors[<span class="number">0</span>] &#125;&#125; onClick=&#123;() =&gt; &#123;</span><br><span class="line">            dispatch(&#123;</span><br><span class="line">                type: <span class="string">"CHANGE_COLOR"</span>,</span><br><span class="line">                colors: [<span class="string">"yellow"</span>, <span class="string">"blue"</span>]</span><br><span class="line">              &#125;)</span><br><span class="line">        &#125;&#125;&gt;I am &#123;colors[<span class="number">0</span>]&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这样就基本实现了共享状态，基本实现了不使用 <code>redux</code> 实现状态共享。</p><h4 id="4-抽离Provider-和-获取状态的自定义hook"><a href="#4-抽离Provider-和-获取状态的自定义hook" class="headerlink" title="4. 抽离Provider 和 获取状态的自定义hook"></a>4. 抽离Provider 和 获取状态的自定义hook</h4><p>假如我们是个小型项目，可能会把这个 <code>Provider</code> 放在顶层，也就是进行全局的状态管理，我们将 <code>Provider</code> 抽离出来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// state.js</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; useContext, useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, colors &#125; = action</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'CHANGE_COLOR'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; colors &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">    colors: [<span class="string">"red"</span>, <span class="string">"blue"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AppContext = React.createContext(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">AppProvider</span> (<span class="params">&#123; children &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;AppContext.Provider value=&#123;useReducer(reducer, initState)&#125;&gt;</span><br><span class="line">            &#123;children&#125;</span><br><span class="line">        &lt;<span class="regexp">/AppContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>最后添加一个自定义hook来获取 <code>AppContext</code> 里的状态和方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext, useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AppContext = React.createContext(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useAppState = <span class="function"><span class="params">()</span> =&gt;</span> useContext(AppContext)</span><br></pre></td></tr></table></figure><p>组件中使用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; AppProvider, useAppState &#125; <span class="keyword">from</span> <span class="string">'./state'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;AppProvider&gt;</span><br><span class="line">            &lt;Child1 /&gt;</span><br><span class="line">            &lt;Child2 /&gt;</span><br><span class="line">        &lt;<span class="regexp">/AppProvider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Child1() &#123;</span></span><br><span class="line"><span class="regexp">    const [state, dispatch] = useAppState()</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">        &lt;div style=&#123;&#123; background: state.colors[0] &#125;&#125; onClick=&#123;() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">            dispatch(&#123;</span></span><br><span class="line"><span class="regexp">                type: "CHANGE_COLOR",</span></span><br><span class="line"><span class="regexp">                colors: ["yellow", "blue"]</span></span><br><span class="line"><span class="regexp">              &#125;)</span></span><br><span class="line"><span class="regexp">        &#125;&#125;&gt;I am &#123;state.colors[0]&#125;&lt;/</span>div&gt;</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样基本就实现了状态的共享。但是和我们常用的 <code>redux</code> 还差了点，熟悉 <code>redux</code> 的都知道稍微复杂点的项目都会按模块拆分，拆分成小的 <code>reducer</code> 和 <code>state</code> 最终再通过 <code>combineReducers</code> 合并 <code>reducer</code> 形成一个全局的 <code>store</code> ，那么如何通过 hooks 来实现 <code>reducer</code> 的拆分和合并呢？ </p><h4 id="5-合并reducer"><a href="#5-合并reducer" class="headerlink" title="5. 合并reducer"></a>5. 合并reducer</h4><p>在复杂的业务场景中会按功能模块拆分成多个小的 <code>reducer</code> 最终再进行整合，按照 redux 的思维，我们页可以实现一个  <code>combineReducers</code> 函数来合并它们。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> reducersKey = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">    <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducersKey.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = reducersKey[i]</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">            finalReducers[key] = reducers[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">            <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">            <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">            <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>()</span><br><span class="line">            &#125;</span><br><span class="line">            nextState[key] = nextStateForKey</span><br><span class="line">            hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后再拆分写 <code>action</code> 和 <code>reducer</code> ，这里稍微有些不同，需要将 <code>reducer</code> 中的 <code>state</code> 导出以便进行整合。</p><p>例如：</p><p>home 模块的 <code>action</code> 和 <code>reducer</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// actions/home.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CHANGE_COLOR = <span class="string">'CHANGE_COLOR'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeColor = <span class="function">(<span class="params">dispatch, colors</span>) =&gt;</span> &#123;</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">        type: <span class="string">"CHANGE_COLOR"</span>,</span><br><span class="line">        colors</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducers/home.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; CHANGE_COLOR &#125; <span class="keyword">from</span> <span class="string">'../actions/home'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> homeState = &#123;</span><br><span class="line">    colors: [<span class="string">"red"</span>, <span class="string">"blue"</span>]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> homeReducer = <span class="function">(<span class="params">state = homeState, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, colors &#125; = action</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> CHANGE_COLOR: </span><br><span class="line">            <span class="keyword">return</span> &#123;colors&#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>user 模块的 <code>action</code> 和 <code>reducer</code> </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// actions/user.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CHANGE_USER_NAME = <span class="string">'CHANGE_USER_NAME'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> changeUserName = <span class="keyword">async</span> (dispatch, userName) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> finalName = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(userName === <span class="string">'sqb'</span> ? <span class="string">'Undo'</span> : <span class="string">'sqb'</span>)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    dispatch(&#123;</span><br><span class="line">        type: CHANGE_USER_NAME,</span><br><span class="line">        name: finalName</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reducers/user.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; CHANGE_USER_NAME &#125; <span class="keyword">from</span> <span class="string">'../actions/user'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> userState = &#123;</span><br><span class="line">    name: <span class="string">'sqb'</span>,</span><br><span class="line">    age: <span class="number">27</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> userReducer = <span class="function">(<span class="params">state = userState, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type &#125; = action</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> CHANGE_USER_NAME:</span><br><span class="line">            <span class="keyword">return</span> &#123; ...state, <span class="attr">name</span>: action.name &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为 <code>useReducer</code> 需要传入 <code>reducer</code> 和初始的 <code>state</code> ，那么需要把小的 <code>reducer</code> 中的状态也进行合并。</p><p>整合，同时到处合并后的 <code>reducer</code> 和 初始化的 <code>initState</code> 。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> combineReducers <span class="keyword">from</span> <span class="string">'./combineReducers'</span></span><br><span class="line"><span class="keyword">import</span> &#123; homeState, homeReducer &#125; <span class="keyword">from</span> <span class="string">'./home'</span></span><br><span class="line"><span class="keyword">import</span> &#123; userState, userReducer &#125; <span class="keyword">from</span> <span class="string">'./user'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducer =  combineReducers(&#123;</span><br><span class="line">    home: homeReducer,</span><br><span class="line">    user: userReducer</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> initState = &#123;</span><br><span class="line">    home: homeState,</span><br><span class="line">    user: userState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-构建store"><a href="#6-构建store" class="headerlink" title="6. 构建store"></a>6. 构建store</h4><p>使用 <code>createContext</code> 创建 <code>Context</code> 对象得到 <code>Provider</code> ，通过 <code>useContext</code> 得到全局状态和更新状态的方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useContext, useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; reducer, initState &#125; <span class="keyword">from</span> <span class="string">'./reducer'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> AppContext = React.createContext(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">AppProvider</span> (<span class="params">&#123; children &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        &lt;AppContext.Provider value=&#123;useReducer(reducer, initState)&#125;&gt;</span><br><span class="line">            &#123;children&#125;</span><br><span class="line">        &lt;<span class="regexp">/AppContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">&#125; </span></span><br><span class="line"><span class="regexp">export const useAppState = () =&gt; useContext(AppContext)</span></span><br></pre></td></tr></table></figure><p>子组件中获取 <code>state</code> 和 修改 <code>state</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useAppState &#125; <span class="keyword">from</span> <span class="string">'../store'</span></span><br><span class="line"><span class="keyword">import</span> &#123; changeColor &#125; <span class="keyword">from</span> <span class="string">'../store/actions/home'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child1</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useAppState()</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">home</span>: &#123; colors &#125; &#125; = state</span><br><span class="line">  <span class="keyword">const</span> onClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    changeColor(dispatch, [<span class="string">"yellow"</span>, <span class="string">"blue"</span>])</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div style=&#123;&#123; <span class="attr">background</span>: colors[<span class="number">0</span>] &#125;&#125; onClick=&#123;onClick&#125; &gt;</span><br><span class="line">    I am &#123;colors[<span class="number">0</span>]&#125; </span><br><span class="line">truetrue&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">)</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Child1;</span></span><br></pre></td></tr></table></figure><p>这样基本上就实现了 <code>redux</code> 的雏形，<code>action 、reducer 、store</code> 也保持了基本一致的风格。</p><h4 id="7-优化"><a href="#7-优化" class="headerlink" title="7. 优化"></a>7. 优化</h4><p>我们实现状态共享，在各个组件中打印日志，发现一个问题，该组件不想关的状态更新也会导致组件重新渲染。</p><p>原因是 调用了 <code>useContext</code> 的组件总会在 <code>context</code> 值变化时重新渲染。也就是说只要组件中使用了共享状态，那么 <code>context</code> 中的任何状态发生改变都会触发使用共享状态的组件重新渲染，这会导致很多没必要的性能开销。</p><p>还好 hooks 提供了 <code>useMemo</code> ，可以利用它来优化性能。</p><blockquote><p>把“创建”函数和依赖项数组作为参数传入 <code>useMemo</code>，它仅会在某个依赖项改变时才重新计算 <code>memoized</code> 值。这种优化有助于避免在每次渲染时都进行高开销的计算。</p></blockquote><p>因此改造我们的子组件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useAppState &#125; <span class="keyword">from</span> <span class="string">'../store'</span></span><br><span class="line"><span class="keyword">import</span> &#123; changeColor &#125; <span class="keyword">from</span> <span class="string">'../store/actions/home'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Child1</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useAppState()</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">home</span>: &#123; colors &#125; &#125; = state</span><br><span class="line">  <span class="keyword">return</span> React.useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Child1 render'</span>)</span><br><span class="line">    <span class="keyword">const</span> onClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      changeColor(dispatch, [<span class="string">"yellow"</span>, <span class="string">"blue"</span>])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;div style=&#123;&#123; <span class="attr">background</span>: colors[<span class="number">0</span>] &#125;&#125; onClick=&#123;onClick&#125;&gt;</span><br><span class="line">        I am &#123;colors[<span class="number">0</span>]&#125; </span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;, [colors, dispatch]);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default Child1;</span></span><br></pre></td></tr></table></figure><p>这样改造之后只会在组件的依赖项发生改变的时候才会重新渲染。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这只是利用 react hooks 简单实现了类似 <code>redux</code> 的数据管理，可以不依赖任何库实现状态管理和共享，当然也可以嵌套，可以拆分，可以按模块拆分状态共享，可以在小项目中进行尝试和运用，它会让我们的编码更加的灵活。  </p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;React Hooks 在 &lt;a href=&quot;mailto:react@10.8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;react@10.8&lt;/a&gt; 中已经发布，刚发布的时候自己也进行了简单的学习，之前也写过一篇&lt;a href=&quot;https://www.songqibin.cn/react-hooks/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;学习 hooks 基础用法&lt;/a&gt;的文章。学习之后用到的场景并不多，最近再次学习并在项目中应用起来，真正体会到它的强大之处。&lt;/p&gt;
&lt;p&gt;本文呢不再是介绍基础的 hooks API 的应用，而是基于hooks如何实现类似 &lt;code&gt;redux&lt;/code&gt; 这样的状态管理。&lt;br&gt;
    
    </summary>
    
      <category term="React" scheme="/categories/React/"/>
    
    
      <category term="react" scheme="/tags/react/"/>
    
      <category term="react-hooks-redux" scheme="/tags/react-hooks-redux/"/>
    
  </entry>
  
  <entry>
    <title>URL解析</title>
    <link href="/URL_Analysis/"/>
    <id>/URL_Analysis/</id>
    <published>2019-07-01T16:00:00.000Z</published>
    <updated>2019-07-02T03:03:35.743Z</updated>
    
    <content type="html"><![CDATA[<p>今天上班前的几分钟在掘金上看到一篇文章在讲“有趣的JS特性”,文中讲到利用JS特性解析url,于是乎学习一下做下记录。</p><p>我们为什么需要解析<code>url</code>呢,一版来说,我们需要从<code>url</code>中提取某些重要信息,比如从<code>url</code>中提取<code>host</code>、<code>origin</code>、<code>pathname</code>、<code>protocol</code>、<code>search</code>等信息。</p><a id="more"></a><h3 id="1-window-location"><a href="#1-window-location" class="headerlink" title="1. window.location"></a>1. window.location</h3><p>针对获取当前页面<code>url</code>地址的情况，使用<code>window.location</code>或许是最简单直接的方式了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="built_in">window</span>.location);</span><br><span class="line"><span class="comment">// Location &#123;replace: ƒ, href: "https://juejin.im/post/5d1716e4f265da1bbc6fea1e?utm_source=gold_browser_extension", ancestorOrigins: DOMStringList, origin: "https://juejin.im", protocol: "https:", …&#125;</span></span><br><span class="line"><span class="comment">// ancestorOrigins: DOMStringList &#123;length: 0&#125;</span></span><br><span class="line"><span class="comment">// assign: ƒ assign()</span></span><br><span class="line"><span class="comment">// hash: ""</span></span><br><span class="line"><span class="comment">// host: "juejin.im"</span></span><br><span class="line"><span class="comment">// hostname: "juejin.im"</span></span><br><span class="line"><span class="comment">// href: "https://juejin.im/post/5d1716e4f265da1bbc6fea1e?utm_source=gold_browser_extension"</span></span><br><span class="line"><span class="comment">// origin: "https://juejin.im"</span></span><br><span class="line"><span class="comment">// pathname: "/post/5d1716e4f265da1bbc6fea1e"</span></span><br><span class="line"><span class="comment">// port: ""</span></span><br><span class="line"><span class="comment">// protocol: "https:"</span></span><br><span class="line"><span class="comment">// reload: ƒ reload()</span></span><br><span class="line"><span class="comment">// replace: ƒ ()</span></span><br><span class="line"><span class="comment">// search: "?utm_source=gold_browser_extension"</span></span><br><span class="line"><span class="comment">// toString: ƒ toString()</span></span><br></pre></td></tr></table></figure><p>我们基本可以获取到我们常用的所有信息，只是查询字符串需要我们手动解析。</p><h3 id="2-利用a标签解析-url"><a href="#2-利用a标签解析-url" class="headerlink" title="2. 利用a标签解析 url"></a>2. 利用a标签解析 url</h3><p>这种方案是我今天在掘金上看到的，这个方案是利用了a标签的特性，给href属性赋值url，就可以解析url获得我们想要的信息字段。</p><p>相比于第一种方式，这种可以解析任意的url地址。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseURL</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> a =  <span class="built_in">document</span>.createElement(<span class="string">'a'</span>);</span><br><span class="line">    a.href = url;</span><br><span class="line">    <span class="built_in">console</span>.log(a);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        host: a.hostname,</span><br><span class="line">        port: a.port,</span><br><span class="line">        query: a.search,</span><br><span class="line">        hash: a.hash.replace(<span class="string">'#'</span>,<span class="string">''</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印创建出来的a标签，可以看到a作为dom元素的所有属性，以及url解析后的字段，字段包含 window.location 解析出来的字段。</p><p>但是如果需要解析查询字符串，还是需要手动解析。</p><h3 id="3-new-URL"><a href="#3-new-URL" class="headerlink" title="3. new URL()"></a>3. new URL()</h3><p>还新学习到一种解析 url 的方法。 <code>URL()</code> 构造函数返回一个新创建的 <code>URL</code> 对象，表示由一组参数定义的 URL。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="keyword">new</span> URL(url, [base])</span><br></pre></td></tr></table></figure><p><strong>url</strong>: 是一个表示绝对或相对 URL 的 DOMString。如果url 是相对 URL，则会将 base 用作基准 URL。如果 url 是绝对URL，则将忽略 base，无论是否有给出。<br><strong>base</strong>: 可选，是一个表示基准 URL 的 DOMString，在 url 是相对 URL 时，它才会起效。如果未指定，则默认为’’。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="keyword">new</span> URL(<span class="string">'https://juejin.im/post/5d1716e4f265da1bbc6fea1e?utm_source=gold_browser_extension'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(url);</span><br><span class="line"><span class="comment">// hash: ""</span></span><br><span class="line"><span class="comment">// host: "juejin.im"</span></span><br><span class="line"><span class="comment">// hostname: "juejin.im"</span></span><br><span class="line"><span class="comment">// href: "https://juejin.im/post/5d1716e4f265da1bbc6fea1e?utm_source=gold_browser_extension"</span></span><br><span class="line"><span class="comment">// origin: "https://juejin.im"</span></span><br><span class="line"><span class="comment">// password: ""</span></span><br><span class="line"><span class="comment">// pathname: "/post/5d1716e4f265da1bbc6fea1e"</span></span><br><span class="line"><span class="comment">// port: ""</span></span><br><span class="line"><span class="comment">// protocol: "https:"</span></span><br><span class="line"><span class="comment">// search: "?utm_source=gold_browser_extension"</span></span><br><span class="line"><span class="comment">// searchParams: URLSearchParams &#123;&#125;</span></span><br><span class="line"><span class="comment">// username: ""</span></span><br></pre></td></tr></table></figure><p>可以看到也能正常解析url，但注意观察，生成的 url 对象中多了一个 <code>searchParams</code> 属性，它的值是 <code>URLSearchParams</code>，它是干什么的呢？</p><p>翻看 MDN ，它是这样描述的</p><blockquote><p>URLSearchParams 接口定义了一些实用的方法来处理 URL 的查询字符串。</p></blockquote><p>没错就是用来操作url的查询字符串的，它拥有很强大的功能，可以对查询字符串进行查询、获取、设置、排序等操作。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(URLSearchParams.prototype);</span><br><span class="line"><span class="comment">// append: ƒ append()</span></span><br><span class="line"><span class="comment">// delete: ƒ delete()</span></span><br><span class="line"><span class="comment">// entries: ƒ entries()</span></span><br><span class="line"><span class="comment">// forEach: ƒ forEach()</span></span><br><span class="line"><span class="comment">// get: ƒ ()</span></span><br><span class="line"><span class="comment">// getAll: ƒ getAll()</span></span><br><span class="line"><span class="comment">// has: ƒ has()</span></span><br><span class="line"><span class="comment">// keys: ƒ keys()</span></span><br><span class="line"><span class="comment">// set: ƒ ()</span></span><br><span class="line"><span class="comment">// sort: ƒ sort()</span></span><br><span class="line"><span class="comment">// toString: ƒ toString()</span></span><br><span class="line"><span class="comment">// values: ƒ values()</span></span><br></pre></td></tr></table></figure><p>具体API的使用查看文档既可，这为从url中获取查询字符串中的信息带来了极大的方便。</p><p>另外，在使用 <code>new URL()</code> 的时候有几点需要注意，先看下面几个例子。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> URL(<span class="string">"/"</span>, <span class="string">"https://developer.mozilla.org"</span>); <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/'</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> URL(<span class="string">"https://developer.mozilla.org"</span>);      <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/'</span></span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> URL(<span class="string">'en-US/docs'</span>, b);                      <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/en-US/docs'</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>, b);                     <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/en-US/docs'</span></span><br><span class="line"><span class="keyword">var</span> f = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>, d);                     <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/en-US/docs'</span></span><br><span class="line"><span class="keyword">var</span> g = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>, <span class="string">"https://developer.mozilla.org/fr-FR/toto"</span>);</span><br><span class="line">                                                    <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/en-US/docs'</span></span><br><span class="line"><span class="keyword">var</span> h = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>, a);                     <span class="comment">// Creates a URL pointing to 'https://developer.mozilla.org/en-US/docs'</span></span><br><span class="line"><span class="keyword">var</span> i = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>, <span class="string">''</span>);                    <span class="comment">// Raises a TypeError exception as '' is not a valid URL</span></span><br><span class="line"><span class="keyword">var</span> j = <span class="keyword">new</span> URL(<span class="string">'/en-US/docs'</span>);                        <span class="comment">// Raises a TypeError exception as '/en-US/docs' is not a valid URL</span></span><br><span class="line"><span class="keyword">var</span> k = <span class="keyword">new</span> URL(<span class="string">'http://www.example.com'</span>, <span class="string">'https://developers.mozilla.com'</span>);</span><br><span class="line">                                                    <span class="comment">// Creates a URL pointing to 'http://www.example.com/'</span></span><br><span class="line"><span class="keyword">var</span> l = <span class="keyword">new</span> URL(<span class="string">'http://www.example.com'</span>, b);          <span class="comment">// Creates a URL pointing to 'http://www.example.com/'</span></span><br></pre></td></tr></table></figure><p>不难发现以下规律：</p><ul><li>最终生成的 url = url || base 的 origin + url</li><li>url 和 base 都缺少 origin、host 等信息的时候会报错</li><li>url具备完整url信息的时候base会失效</li></ul><p>关于查询字符串的解析，实现的方式很多，这里不多说了。</p><p>另外再补充一下使用  <code>URL</code> 的静态方法来实现文件下载的方案。</p><p>URL.createObjectURL() 静态方法会创建一个 DOMString，其中包含一个表示参数中给出的对象的URL。这个 URL 的生命周期和创建它的窗口中的 document 绑定。这个新的URL 对象表示指定的 File 对象或 Blob 对象。<br>在每次调用 createObjectURL() 方法时，都会创建一个新的 URL 对象，即使你已经用相同的对象作为参数创建过。当不再需要这些 URL 对象时，每个对象必须通过调用 URL.revokeObjectURL() 方法来释放。浏览器会在文档退出的时候自动释放它们，但是为了获得最佳性能和内存使用状况，应该在安全的时机主动释放掉它们。</p><p>使用 <code>a</code> 标签 配合 <code>URL</code> 对象实现下载保存。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">    method: <span class="string">"get"</span>,</span><br><span class="line">    url: <span class="string">`/download/<span class="subst">$&#123;id&#125;</span>`</span>,</span><br><span class="line">    responseType: <span class="string">"blob"</span>,</span><br><span class="line">&#125;).then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="built_in">document</span>.createElement(<span class="string">"a"</span>);</span><br><span class="line">    <span class="keyword">var</span> url = <span class="built_in">window</span>.URL.createObjectURL(response.data);</span><br><span class="line">    a.href = url;</span><br><span class="line">    a.download = <span class="string">'filename'</span>;</span><br><span class="line">    a.click();</span><br><span class="line">    <span class="built_in">window</span>.URL.revokeObjectURL(url);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;今天上班前的几分钟在掘金上看到一篇文章在讲“有趣的JS特性”,文中讲到利用JS特性解析url,于是乎学习一下做下记录。&lt;/p&gt;
&lt;p&gt;我们为什么需要解析&lt;code&gt;url&lt;/code&gt;呢,一版来说,我们需要从&lt;code&gt;url&lt;/code&gt;中提取某些重要信息,比如从&lt;code&gt;url&lt;/code&gt;中提取&lt;code&gt;host&lt;/code&gt;、&lt;code&gt;origin&lt;/code&gt;、&lt;code&gt;pathname&lt;/code&gt;、&lt;code&gt;protocol&lt;/code&gt;、&lt;code&gt;search&lt;/code&gt;等信息。&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="JS" scheme="/tags/JS/"/>
    
  </entry>
  
  <entry>
    <title>CSS - 媒体查询@media</title>
    <link href="/css_media/"/>
    <id>/css_media/</id>
    <published>2019-03-30T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.248Z</updated>
    
    <content type="html"><![CDATA[<p>记录一次小需求引发的对媒体查询的学习。</p><p>最近接到一个小需求，只做页面重构，本着切图的想法就准备开工了，打开设计给出的设计稿，发现里面有1366px 和 1920px 宽度的两份设计稿和切图，第一想法是按照某一个尺寸来做，经过跟产品和设计确认，是要求适配这两个尺寸。由于之前做这种适配性的页面经验较少，所以刚开始是有点懵的，有点不知所措。</p><p>经过分析，其实就是两种尺寸下，各个元素的大小、字体、间距等的尺寸不同，那么想到的就是在不同的屏幕尺寸下用不同的布局尺寸，自然就想到了媒体查询。<br><a id="more"></a></p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>根据媒体查询，获得浏览器的宽度，根据宽度加载对应的css，具体的实现方式有下面几种：<br>1.直接在CSS中使用<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> screen and (max-width: <span class="number">1919px</span>) &#123;  </span><br><span class="line">true// CSS样式</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">@<span class="keyword">media</span> screen and (min-width: <span class="number">1920px</span>) &#123;  </span><br><span class="line">true// CSS样式</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.在@import中引入<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"screen and (max-width:1919px)"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">import</span> url(<span class="string">"../css/index1366.css"</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">media</span>=<span class="string">"screen and (max-width:1920px)"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">@<span class="keyword">import</span> url(<span class="string">"../css/index1920.css"</span>);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>3.在head中动态引入<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">media</span>=<span class="string">"screen and (max-width: 1919px)"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../css/index1366.css"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">media</span>=<span class="string">"screen and (min-width: 1920px)"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../css/index1920.css"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>在最终选择是第三种方案，这种方案更适合本次的需求，把相同的代码写在公用的文件中，差异的css代码，分别写在对应的css文件中，这样方便管理和修改。第二种方式和第三种其实是一样的但是多用一个 style 标签，第一种是将代码合在一起虽然只管，但是显得比较混乱，不方便分离和管理。</p><h3 id="媒体查询学习"><a href="#媒体查询学习" class="headerlink" title="媒体查询学习"></a>媒体查询学习</h3><p><strong>媒体查询</strong>，添加自CSS3，允许内容的呈现针对一个特定范围的输出设备而进行裁剪，而不必改变内容本身。媒体查询包含一个可选的<a href="https://developer.mozilla.org/en-US/docs/CSS/@media" target="_blank" rel="noopener">媒体类型</a>和媒体特性表达式(0或多个)最终会被解析为<code>true</code>或<code>false</code>。如果媒体查询中指定的媒体类型匹配展示文档所使用的设备类型，并且所有的表达式的值都是<code>true</code>，那么该媒体查询的结果为<code>true</code>。</p><p>当媒体查询未<code>true</code>时，对应的样式就会进行应用。使用 <code>&lt;link&gt;</code> 标签指向的样式表，即使媒体查询为<code>false</code>也会下载但是不会被应用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@media 媒体类型 逻辑操作符 媒体特征</span><br></pre></td></tr></table></figure></p><h4 id="媒体类型"><a href="#媒体类型" class="headerlink" title="媒体类型"></a>媒体类型</h4><p>让我们先了解一下媒体类型，这个大家会比较熟悉一点，我们通常会用到的类型会是<code>all</code> 和<code>screen</code>，然后是<code>print</code>，一些网站会专门通过<code>print</code>类型为页面的打印格式提供更友好的界面。其实，<code>media type</code>有很多种：</p><table><thead><tr><th>类型</th><th>解释</th></tr></thead><tbody><tr><td>all</td><td>所有设备</td></tr><tr><td>braille</td><td>盲文</td></tr><tr><td>embossed</td><td>盲文打印</td></tr><tr><td>handheld</td><td>手持设备</td></tr><tr><td>print</td><td>文档打印或打印预览模式</td></tr><tr><td>projection</td><td>项目演示，比如幻灯</td></tr><tr><td>screen</td><td>彩色电脑屏幕</td></tr><tr><td>speech</td><td>演讲</td></tr><tr><td>tty</td><td>固定字母间距的网格的媒体，比如电传打字机</td></tr><tr><td>tv</td><td>电视</td></tr></tbody></table><h4 id="逻辑操作符"><a href="#逻辑操作符" class="headerlink" title="逻辑操作符"></a>逻辑操作符</h4><p>逻辑操作符包括<code>not</code>、<code>and</code>和<code>only</code>等，构建复杂的媒体查询。<code>and</code>操作符用来把多个媒体属性组合成一条媒体查询，对成链式的特征进行请求，只有当每个属性都为真时，结果才为真。<code>not</code>操作符用来对一条媒体查询的结果进行取反。<code>only</code>操作符仅在媒体查询匹配成功的情况下被用于应用一个样式，这对于防止让选中的样式在老式浏览器中被应用到。若使用了<code>not</code>或<code>only</code>操作符，必须明确指定一个媒体类型。</p><p><strong>and</strong><br><code>and</code>关键字用于合并多个媒体属性或合并媒体属性与媒体类型。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> screen and (min-width: <span class="number">700px</span>) and (max-width: <span class="number">1919px</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p><p>表示在电脑屏幕跨宽度在700-1910之间的时候应用的css样式。</p><p><strong>not</strong><br><code>not</code> 关键字应用于整个媒体查询，在媒体查询为假时返回真 (比如 <code>monochrome</code> 应用于彩色显示设备上或一个600像素的屏幕应用于 <code>min-width: 700px</code> 属性查询上 )。在逗号媒体查询列表中<code>not</code>仅会否定它应用到的媒体查询上而不影响其它的媒体查询。 <code>not</code>关键字仅能应用于整个查询，而不能单独应用于一个独立的查询。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> not all and (monochrome) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p><p>等价于：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> not (all and (monochrome)) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p><p>而不是<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> (not all) and (monochrome) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p><p><strong>only</strong><br><code>only</code>关键字防止老旧的浏览器不支持带媒体属性的查询而应用到给定的样式：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">media</span>=<span class="string">"only screen and (color)"</span> <span class="attr">href</span>=<span class="string">"example.css"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>逗号分隔列表</strong><br>媒体查询中使用逗号分隔效果等同于<code>or</code>逻辑操作符。当使用逗号分隔的媒体查询时，如果任何一个媒体查询返回真，样式就是有效的。逗号分隔的列表中每个查询都是独立的，一个查询中的操作符并不影响其它的媒体查询。这意味着逗号媒体查询列表能够作用于不同的媒体属性、类型和状态。<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">media</span> (min-width: <span class="number">700px</span>), handheld and (orientation: landscape) &#123; ... &#125;</span><br></pre></td></tr></table></figure></p><p>表示在最小宽度为700像素或是横屏的手持设备上应用一组样式。</p><h4 id="媒体特征"><a href="#媒体特征" class="headerlink" title="媒体特征"></a>媒体特征</h4><p>大多数媒体属性可以带有“min-”或“max-”前缀，用于表达“最低…”或者“最高…”。例如，<code>max-width:12450px</code>表示应用其所包含样式的条件最高是宽度为12450px，大于12450px则不满足条件，不会应用此样式。这避免了使用与HTML和XML冲突的“&lt;”和“&gt;”字符。如果你未向媒体属性指定一个值，并且该特性的实际值不为零，则该表达式被解析为真。<br>常用的媒体特征有：</p><table><thead><tr><th>属性</th><th>值</th><th>Min/Max</th><th>描述</th></tr></thead><tbody><tr><td>color</td><td>整数</td><td>yes</td><td>每种色彩的字节数</td></tr><tr><td>color-index</td><td>整数</td><td>yes</td><td>色彩表中的色彩数</td></tr><tr><td>device-aspect-ratio</td><td>整数/整数</td><td>yes</td><td>宽高比例</td></tr><tr><td>device-height</td><td>length</td><td>yes</td><td>设备屏幕的输出高度</td></tr><tr><td>device-width</td><td>length</td><td>yes</td><td>设备屏幕的输出宽度</td></tr><tr><td>grid</td><td>整数</td><td>no</td><td>是否是基于格栅的设备</td></tr><tr><td>height</td><td>length</td><td>yes</td><td>渲染界面的高度</td></tr><tr><td>monochrome</td><td>整数</td><td>yes</td><td>单色帧缓冲器中每像素字节</td></tr><tr><td>resolution</td><td>分辨率(“dpi/dpcm”)</td><td>yes</td><td>分辨率</td></tr><tr><td>scan</td><td>Progressive interlaced</td><td>no</td><td>tv媒体类型的扫描方式</td></tr><tr><td>width</td><td>length</td><td>yes</td><td>渲染界面的宽度</td></tr><tr><td>orientation</td><td>Portrait/landscape</td><td>no</td><td>横屏或竖屏</td></tr></tbody></table><p><strong>max与min</strong></p><table><thead><tr><th>height</th><th>min-height</th><th>max-height</th></tr></thead><tbody><tr><td>device-width</td><td>min-device-width</td><td>max-device-width</td></tr><tr><td>device-height</td><td>min-device-height</td><td>max-device-height</td></tr><tr><td>aspect-ratio</td><td>min-aspect-ratio</td><td>max-aspect-ratio</td></tr><tr><td>device-aspect-ratio</td><td>min-device-aspect-ratio</td><td>max-device-aspect-ratio</td></tr><tr><td>color</td><td>min-color</td><td>max-color</td></tr><tr><td>color-index</td><td>min-color-index</td><td>max-color-index</td></tr><tr><td>Monochrome</td><td>min-monochrome</td><td>max-monochrome</td></tr><tr><td>Resolution</td><td>min-resolution</td><td>max-resolution</td></tr></tbody></table><p><strong>媒体查询浏览器支持度：</strong></p><ul><li>IE 9以下不支持</li><li>Firefox 3.5+(Gecko 1.9.1+)支持</li><li>Opera 9.5+完全支持</li><li>Opera mini 5支持</li><li>webkit 支持大部分属性(<code>safari</code> 3.0的内核版本是522，iPhone 1代的<code>safari</code>的内核版本是524，<code>webkit</code>大概从这个时候开始支持<code>media query</code>，但是对部分属性比如<code>projection</code>支持不好)</li><li>iPhone OS 3.2之前的版本不支持<code>orientation</code>属性，iPad和iPhone 4支持该属性。</li><li>iPhone Safari不支持<code>orientation</code>(iPhone 4支持)</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>CSS3的media query是一个很强大也很好用的工具，它为我们在不同的设备和环境下实现丰富的界面提供了一种快捷方法，虽然现在各个浏览器对它的支持还有些差异，但是大家都在改进，IE 9已经开始支持media query了。不过目前media query的最大舞台是在高端手持设备，相信随着移动互联网的快速发展，media query也会很好发挥自己的作用。</p><p><strong>相关链接：</strong><br><a href="https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Media_queries" target="_blank" rel="noopener">【CSS媒体查询】</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media" target="_blank" rel="noopener">【@media】</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;记录一次小需求引发的对媒体查询的学习。&lt;/p&gt;
&lt;p&gt;最近接到一个小需求，只做页面重构，本着切图的想法就准备开工了，打开设计给出的设计稿，发现里面有1366px 和 1920px 宽度的两份设计稿和切图，第一想法是按照某一个尺寸来做，经过跟产品和设计确认，是要求适配这两个尺寸。由于之前做这种适配性的页面经验较少，所以刚开始是有点懵的，有点不知所措。&lt;/p&gt;
&lt;p&gt;经过分析，其实就是两种尺寸下，各个元素的大小、字体、间距等的尺寸不同，那么想到的就是在不同的屏幕尺寸下用不同的布局尺寸，自然就想到了媒体查询。&lt;br&gt;
    
    </summary>
    
      <category term="CSS" scheme="/categories/CSS/"/>
    
    
      <category term="CSS" scheme="/tags/CSS/"/>
    
      <category term="媒体查询" scheme="/tags/%E5%AA%92%E4%BD%93%E6%9F%A5%E8%AF%A2/"/>
    
      <category term="media" scheme="/tags/media/"/>
    
  </entry>
  
  <entry>
    <title>CSS - 实现优惠券</title>
    <link href="/css_coupon/"/>
    <id>/css_coupon/</id>
    <published>2018-12-19T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.248Z</updated>
    
    <content type="html"><![CDATA[<p>最近在项目开发中遇到一个优惠券需求，与常见的优惠券类似，中部有反向的圆角。</p><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220100120.png?raw=true" alt="1542164268396"></p><p>类似于这样的优惠券，在开发中如何去实现呢。<br><a id="more"></a></p><h4 id="1-使用背景图"><a href="#1-使用背景图" class="headerlink" title="1. 使用背景图"></a>1. 使用背景图</h4><p>我们遇到这样的需求，第一反应可能是使用背景图，要一张白底的带内圆角的背景图，就像下面这样：</p><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220101203.png?raw=true" alt="1542164268396"></p><p>这样当然没有问题，简单，方便，没有兼容性问题，即使在低版本的IE中也没有丝毫的问题，但是如果不考虑低版本浏览器，不考虑兼容性的话，使用css来实现会更好。</p><ol><li>使用css易于控制，如设计有改尺寸，我们只需要更改部分代码就能实现</li><li>不使用图片，减少网络请求，css实现加载起来更快</li></ol><h4 id="2-使用css，内圆角背景与底色一样"><a href="#2-使用css，内圆角背景与底色一样" class="headerlink" title="2. 使用css，内圆角背景与底色一样"></a>2. 使用css，内圆角背景与底色一样</h4><p>如果优惠券的底色是个纯色的，那么其实可以考虑这种很简便的实现方式，即使用两个圆角，背景色与底色相同即可。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrapper1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.wrapper1</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">750px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">250px</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#EA364B</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.wrapper1</span> <span class="selector-class">.coupon</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">710px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">220px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#ffffff</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.wrapper1</span> <span class="selector-class">.coupon</span><span class="selector-pseudo">::before</span>, <span class="selector-class">.wrapper1</span> <span class="selector-class">.coupon</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#EA364B</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.wrapper1</span> <span class="selector-class">.coupon</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">  <span class="attribute">top</span>: -<span class="number">15px</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">520px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.wrapper1</span> <span class="selector-class">.coupon</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">  <span class="attribute">bottom</span>: -<span class="number">15px</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">520px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就能实现以上的效果，但是这样有一个弊端，伪元素before和after，的背景色必须与外层容器的背景色保持一致，而当外层背景色改变或者是渐变的那就会出现无法避免的问题，伪元素的背景色不能与外层背景色很好的衔接。</p><p>所以最理想的状态是内圆角的背景色是透明的即可避免。</p><p>这种方式由于本身背景色是白色，即使伪元素的背景使用 transparent 也会展示成白色，并不能穿透这层白色的背景。</p><h4 id="3-使用css，背景剪切clip"><a href="#3-使用css，背景剪切clip" class="headerlink" title="3. 使用css，背景剪切clip"></a>3. 使用css，背景剪切clip</h4><p>为了实现上面的透明圆角，将优惠券从向内的圆角的中心处分为左右两部分。为了效果明显右半部分先用黑色。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon-left"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon-right"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.coupon</span> &#123;</span></span><br><span class="line"><span class="undefined">    width: 710px;</span></span><br><span class="line"><span class="undefined">    height: 220px;</span></span><br><span class="line"><span class="undefined">    border-radius: 8px;</span></span><br><span class="line"><span class="undefined">    overflow: hidden;</span></span><br><span class="line"><span class="undefined">    display: flex;</span></span><br><span class="line"><span class="undefined">    justify-content: center;</span></span><br><span class="line"><span class="undefined">    align-items: center;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.coupon-left</span> &#123;</span></span><br><span class="line"><span class="undefined">    width: 520px;</span></span><br><span class="line"><span class="undefined">    height: 220px;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#ffffff</span>;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="css">  <span class="selector-class">.coupon-right</span> &#123;</span></span><br><span class="line"><span class="undefined">    width: 190px;</span></span><br><span class="line"><span class="undefined">    height: 220px;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">background</span>: <span class="selector-id">#252525</span>;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220104352.png?raw=true" alt="1542164268396"></p><p>下面就来实现中间看着比较复杂的”凹槽”部分</p><p>我能想到跟圆角相关的有圆角、圆形、径向…这些吧</p><p>有人说<code>svg</code>也可以，确实<code>svg</code>什么都可以做，不光是这种形状，只要画个路径，填充一下就完事，这个比较通用，并不是这个特例，所以在这里不讨论用这个方式。<br>还有一个原因，<code>svg</code>生成的形状也是固定了的，只能等比缩放，不能做其他自适应了。</p><h5 id="实现圆角"><a href="#实现圆角" class="headerlink" title="实现圆角"></a>实现圆角</h5><p>可以先实现一个圆形，背景色默认透明，设置边框，即可得到一个圆形。</p><p>加入将圆的边框设的很大，外层容器超出隐藏就可以得到我们想要的效果。</p><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/4563335-5b515f00da666_articlex.jpg?raw=true" alt="1111111">  <img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/881250682-5b515f00719e0_articlex.jpg?raw=true" alt="2222222">  <img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/1153531229-5b515f006f297_articlex.jpg?raw=true" alt="3333333"></p><p>有了以上的思路我们就可以实现我们的需求了，先实现左边，修改css， 去掉原来的背景色，用边框来实现。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.coupon-left</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">520px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">220px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="comment">/* background: #fff; */</span></span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.coupon-left</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: -<span class="number">575px</span>;</span><br><span class="line">    <span class="attribute">top</span>: -<span class="number">575px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">560px</span> solid <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220110106.png?raw=true" alt="444444444"></p><p>这样就实现了一个右上角的内圆弧，继续按照这个思路实现after元素，定位到右下角，这时候我们发现出现了问题，before元素覆盖了整个的盒子，把右下角的圆角给挡住了。</p><p>这里我们可以使用clip属性来裁剪背景，只需要before占据盒子的上半部分，after占据盒子的下班部分。</p><p>关于<code>clip</code>这里简单介绍一下，我们一般会用到<code>rect</code>这个功能，有四个值，分别是上右下左。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clip</span>: <span class="selector-tag">rect</span>(&lt;<span class="selector-tag">top</span>&gt;, &lt;<span class="selector-tag">right</span>&gt;, &lt;<span class="selector-tag">bottom</span>&gt;, &lt;<span class="selector-tag">left</span>&gt;);</span><br></pre></td></tr></table></figure><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/2954776641-58e49bb2040e4_articlex.jpg?raw=true" alt="cilp"></p><p>因此，我们使用clip来裁剪一下before，修改代码</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.coupon-left</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">top</span>: -<span class="number">575px</span>;</span><br><span class="line">    <span class="attribute">clip</span>: <span class="built_in">rect</span>(575px,575px,685px,55px);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220110917.png?raw=true" alt="clip-before"></p><p>再按照这种思路实现下半部分，调整一下after元素的top值和裁剪的起始值即可。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.coupon-left</span><span class="selector-pseudo">::after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: -<span class="number">575px</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">560px</span> solid <span class="number">#fff</span>;</span><br><span class="line">    <span class="attribute">top</span>: -<span class="number">355px</span>;</span><br><span class="line">    <span class="attribute">clip</span>: <span class="built_in">rect</span>(465px,575px,575px,55px);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终效果如下：</p><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220111258.png?raw=true" alt="clip-left"></p><p>同样按照这样的思路可以实现右边部分。</p><p>完整代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon-left"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"coupon-right"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon</span> &#123;</span></span><br><span class="line"><span class="undefined">      width: 710px;</span></span><br><span class="line"><span class="undefined">      height: 220px;</span></span><br><span class="line"><span class="undefined">      border-radius: 8px;</span></span><br><span class="line"><span class="undefined">      overflow: hidden;</span></span><br><span class="line"><span class="undefined">      display: flex;</span></span><br><span class="line"><span class="undefined">      justify-content: center;</span></span><br><span class="line"><span class="undefined">      align-items: center;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-left</span> &#123;</span></span><br><span class="line"><span class="undefined">      width: 520px;</span></span><br><span class="line"><span class="undefined">      height: 220px;</span></span><br><span class="line"><span class="undefined">      position: relative;</span></span><br><span class="line"><span class="undefined">      overflow: hidden;</span></span><br><span class="line"><span class="css">      <span class="comment">/* background: #fff; */</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-left</span><span class="selector-pseudo">::before</span>, <span class="selector-class">.coupon-left</span><span class="selector-pseudo">::after</span>&#123;</span></span><br><span class="line"><span class="undefined">      content: '';</span></span><br><span class="line"><span class="undefined">      position: absolute;</span></span><br><span class="line"><span class="undefined">      right: -575px;</span></span><br><span class="line"><span class="undefined">      width: 30px;</span></span><br><span class="line"><span class="undefined">      height: 30px;</span></span><br><span class="line"><span class="undefined">      border-radius: 50%;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">border</span>: 560<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#fff</span>;</span></span><br><span class="line"><span class="undefined">    &#125;  </span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-left</span><span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line"><span class="undefined">      top: -575px;</span></span><br><span class="line"><span class="undefined">      clip: rect(575px,575px,685px,55px);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-left</span><span class="selector-pseudo">::after</span> &#123;</span></span><br><span class="line"><span class="undefined">      top: -355px;</span></span><br><span class="line"><span class="undefined">      clip: rect(465px,575px,575px,55px);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-right</span> &#123;</span></span><br><span class="line"><span class="undefined">      width: 190px;</span></span><br><span class="line"><span class="undefined">      height: 220px;</span></span><br><span class="line"><span class="undefined">      position: relative;</span></span><br><span class="line"><span class="undefined">      overflow: hidden;</span></span><br><span class="line"><span class="css">      <span class="comment">/* background: #252525; */</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-right</span><span class="selector-pseudo">::before</span>, <span class="selector-class">.coupon-right</span><span class="selector-pseudo">::after</span> &#123;</span></span><br><span class="line"><span class="undefined">      content: '';</span></span><br><span class="line"><span class="undefined">      position: absolute;</span></span><br><span class="line"><span class="undefined">      right: -105px;</span></span><br><span class="line"><span class="undefined">      width: 30px;</span></span><br><span class="line"><span class="undefined">      height: 30px;</span></span><br><span class="line"><span class="undefined">      border-radius: 50%;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">border</span>: 280<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#252525</span>;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-right</span><span class="selector-pseudo">::before</span> &#123;</span></span><br><span class="line"><span class="undefined">      top: -295px;</span></span><br><span class="line"><span class="undefined">      clip: rect(295px,485px,405px,295px);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="css">    <span class="selector-class">.coupon-right</span><span class="selector-pseudo">::after</span> &#123;</span></span><br><span class="line"><span class="undefined">      top: -75px;</span></span><br><span class="line"><span class="undefined">      clip: rect(185px,485px,295px,295px);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>最终效果</p><p><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220112029.png?raw=true" alt="clip-coupon"></p><p>还有一个分割线，可以用绝对定位来实现。以上就是整个优惠券背景的实现。</p><p>最终效果如下:<br><iframe id="cp_embed_maRrvN" src="//codepen.io/undo03/embed/maRrvN?height=300&theme-id=dark&slug-hash=maRrvN&default-tab=result]" scrolling="no" frameborder="no" height="300" allowtransparency="true" allowfullscreen="true" class="cp_embed_iframe" style="width: 100%; overflow: hidden;"></iframe></p><h4 id="4-相关知识点补充"><a href="#4-相关知识点补充" class="headerlink" title="4. 相关知识点补充"></a>4. 相关知识点补充</h4><p><code>clip</code> 属性支持度，在<a href="https://caniuse.com/#search=clip" target="_blank" rel="noopener"><code>Can I use</code></a> 上查看结果如下<br><img src="https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220142745.png?raw=true" alt="https://caniuse.com/#search=clip"></p><p>在不考虑IE的情况下，使用它是没有太大问题的，移动端可以放心使用。</p><ul><li><code>border-radius</code> 是左上、右上、左下、右下四个方向的复合属性，有两种设值方式<ul><li><code>length</code>  定义圆形半径或椭圆的半长轴，半短轴。<strong>负值无效</strong>。</li><li><code>percentage</code> 使用百分数定义圆形半径或椭圆的半长轴，半短轴。水平半轴相对于盒模型的宽度；垂直半轴相对于盒模型的高度。<strong>负值无效</strong>。</li></ul></li><li><code>clip</code> The <strong>clip</strong> CSS property defines what portion of an element is visible. The <code>clip</code> property applies only to absolutely positioned elements, that is elements with <code>position:absolute</code> or <code>position:fixed</code>. The <code>&lt;top&gt;</code>, <code>&lt;right&gt;</code>, <code>&lt;bottom&gt;</code>, and <code>&lt;left&gt;</code> values may be either a <code>length</code> or <code>auto</code>. If any side’s value is <code>auto</code>, the element is clipped to that side’s <em>inside border edge</em>.</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在项目开发中遇到一个优惠券需求，与常见的优惠券类似，中部有反向的圆角。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://github.com/undo03/Blog_Source/blob/theme_next/source/article_images/CSS/20181220100120.png?raw=true&quot; alt=&quot;1542164268396&quot;&gt;&lt;/p&gt;
&lt;p&gt;类似于这样的优惠券，在开发中如何去实现呢。&lt;br&gt;
    
    </summary>
    
      <category term="CSS" scheme="/categories/CSS/"/>
    
    
      <category term="CSS" scheme="/tags/CSS/"/>
    
      <category term="优惠券" scheme="/tags/%E4%BC%98%E6%83%A0%E5%88%B8/"/>
    
      <category term="CSS-clip" scheme="/tags/CSS-clip/"/>
    
  </entry>
  
  <entry>
    <title>使用webp图片提升前端性能</title>
    <link href="/performance_webp/"/>
    <id>/performance_webp/</id>
    <published>2018-11-21T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.253Z</updated>
    
    <content type="html"><![CDATA[<p>现在我们看到的大多数网站，80%以上都是图片为主，所以图片的优化是前端性能优化的重要手段，也是非常有必要的一种手段。</p><p>我们知道图片的体积越小加载越快，那么图片的优化主要是减小体积或者叫压缩体积，但是压缩体积会造成一定的质量牺牲，那么体积和质量之间怎么均衡呢。<br><a id="more"></a></p><p>在进行具体的方案之前先了解一下几种常见格式的图片特征：</p><h3 id="JPEG-JPG"><a href="#JPEG-JPG" class="headerlink" title="JPEG/JPG"></a>JPEG/JPG</h3><p><strong>优点</strong>：JPG 最大的特点是有损压缩。这种高效的压缩算法使它成为了一种非常轻巧的图片格式。另一方面，即使被称为“有损”压缩，JPG的压缩方式仍然是一种高质量的压缩方式：当我们把图片体积压缩至原有体积的 50% 以下时，JPG 仍然可以保持住 60% 的品质。此外，JPG 格式以 24 位存储单个图，可以呈现多达 1600 万种颜色，足以应对大多数场景下对色彩的要求，这一点决定了它压缩前后的质量损耗并不容易被我们人类的肉眼所察觉。</p><p><strong>缺点</strong>：在处理矢量图形或logo等线条感较强、颜色对比强烈的图像时，人为压缩导致图片模糊相当明显。此外jpeg不支持透明，使用很受局限。</p><p><strong>适用场景</strong>： JPG 适用于呈现色彩丰富的图片，开发中，JPG 图片经常作为大的背景图、轮播图。</p><h3 id="PNG-8-与-PNG-24"><a href="#PNG-8-与-PNG-24" class="headerlink" title="PNG-8 与 PNG-24"></a>PNG-8 与 PNG-24</h3><p><strong>优点</strong>：PNG是一种无损压缩的高保真的图片格式。8 和 24，这里都是二进制数的位数，代表了支持的颜色的种类，24位呈现的色彩更丰富。PNG 图片具有比 JPG 更强的色彩表现力，对线条的处理更加细腻，对透明度有良好的支持。</p><p><strong>缺点</strong>： 唯一的 缺点 就是<strong>体积太大</strong></p><p><strong>使用场景</strong>：logo、小图标、颜色简单、对比度较强的透明小图在 PNG 格式下有着良好的表现。</p><h3 id="SVG"><a href="#SVG" class="headerlink" title="SVG"></a>SVG</h3><p><strong>优点</strong>：<strong>文本文件、体积小、不失真、兼容性好</strong>，SVG 与 PNG 和 JPG 相比，<strong>文件体积更小，可压缩性更强</strong></p><p><strong>特性</strong>：它和之前提及的其它图片种类有着本质的不同：SVG 对图像的处理不是基于像素点，而是是基于对图像的形状描述。作为矢量图，它最显著的优势还是在于<strong>图片可无限放大而不失真</strong>这一点上。SVG 是文本文件。我们既可以像写代码一样定义 SVG，把它写在 HTML 里、成为 DOM 的一部分，也可以把对图形的描述写入以 .svg 为后缀的独立文件（SVG 文件在使用上与普通图片文件无异）。这使得 SVG 文件可以被非常多的工具读取和修改，具有较强的灵活性。</p><p><strong>缺点</strong>：一方面是它的渲染成本比较高，这点对性能来说是很不利的。另一方面，SVG 存在着其它图片格式所没有的学习成本（它是可编程的）。</p><h3 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a>Base64</h3><p>Base64 并非一种图片格式，而是一种编码方式。Base64 和雪碧图一样，是作为小图标解决方案而存在的。</p><p>雪碧图、CSS 精灵、CSS Sprites、图像精灵，说的都是这个东西——一种将小图标和背景图像合并到一张图片上，然后利用 CSS 的背景定位来显示其中的每一部分的技术，大家都非常熟悉了。</p><p>雪碧图的出现是为了从另一个方面进行性能的提升，减少网页图片对服务器的请求次数。</p><p>Base64同样也是为了减少请求次数，降低http的开销。</p><p><strong>Base64 是一种用于传输 8Bit 字节码的编码方式，通过对图片进行 Base64 编码，我们可以直接将编码结果写入 HTML 或者写入 CSS，从而减少 HTTP 请求的次数。</strong></p><p>但是打开一些主流网站我们发现Base64码出现的次数很少，这是因为Base64 编码后，编码的大小会膨胀为原图片的 4/3（这是由 Base64 的编码原理决定的）。如果我们把大图也编码到 HTML 或 CSS 文件中，后者的体积会明显增加，即便我们减少了 HTTP 请求，也无法弥补这庞大的体积带来的性能开销，得不偿失。</p><p>因此，通常我们在开发的时候一般只会将体积非常小的图片进行Base64编码，这个时候Base64 带来的文件体积膨胀、以及浏览器解析 Base64 的时间开销，与它节省掉的 HTTP 请求开销相比，可以忽略不计，这时候才能真正体现出它在性能方面的优势。</p><p>在webpack盛行的情况下，只需要在<a href="https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Fwebpack-contrib%2Furl-loader" target="_blank" rel="noopener">url-loader</a>中稍加配置就可以将一定体积之下的图片编译成Base64码。也有很多线上的编码工具可供使用。</p><h3 id="WebP"><a href="#WebP" class="headerlink" title="WebP"></a>WebP</h3><p>WebP 于 2010 年被提出， 是 Google 专为 Web 开发的一种<strong>旨在加快图片加载速度</strong>的图片格式，它支持有损压缩和无损压缩。它集多种图片文件格式的优点于一身。</p><blockquote><p>与 PNG 相比，WebP 无损图像的尺寸缩小了 26％。在等效的 SSIM 质量指数下，WebP 有损图像比同类 JPEG 图像小 25-34％。 无损 WebP 支持透明度（也称为 alpha 通道），仅需 22％ 的额外字节。对于有损 RGB 压缩可接受的情况，有损 WebP 也支持透明度，与 PNG 相比，通常提供 3 倍的文件大小。</p></blockquote><p>这也许是目前图片优化的最佳方式了。</p><p>可是万恶的兼容性让他的使用受到了局限。</p><p><img src="http://img13.360buyimg.com/uba/jfs/t29299/214/484992014/43062/361fdad1/5bf4cce8Na40450ed.png" alt="1542164268396"></p><p>此外，WebP 还会增加服务器的负担——和编码 JPG 文件相比，编码同样质量的 WebP 文件会占用更多的计算资源。</p><p>webp的应用场景：限制我们使用 WebP 的最大问题不是“这个图片是否适合用 WebP 呈现”的问题，而是“浏览器是否允许 WebP”的问题，即我们上文谈到的兼容性问题。当我们选择适用webp图片，就要考虑在不支持它的浏览器下如何正常显示。</p><p>webp图片方案已经被多数大厂应用到项目中，比如在Chrome中打开京东首页，我们查看网络发现他们也使用了很多的webp格式的图片。</p><p><img src="http://img13.360buyimg.com/uba/jfs/t28183/42/537026357/77280/842d1df/5bf60f8dN2042b016.png" alt="1542852435559"></p><p>再来查看元素，我们发现html是这样的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"//img13.360buyimg.com/mobilecms/s140x140_jfs/t1/4688/27/2880/248823/5b978fe4Eeea92074/5c1ee7f70e8855e9.jpg!q90.webp"</span> <span class="attr">class</span>=<span class="string">"lazyimg_img"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>而在IE浏览器中打开，它的html却是这样的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"lazyimg_img"</span> <span class="attr">src</span>=<span class="string">"//img13.360buyimg.com/mobilecms/s140x140_jfs/t1/4688/27/2880/248823/5b978fe4Eeea92074/5c1ee7f70e8855e9.jpg!q90"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们发现支持webp的浏览器中图片的url地址多了 <code>.webp</code>后缀，而.webp 前面，还跟了一个 .jpg 后缀！</p><p>可以大胆地猜测，这个图片应该至少存在 jpg 和 webp 两种格式，程序会根据浏览器的型号、以及该型号是否支持 WebP 这些信息来决定当前浏览器显示的是 .webp 后缀还是 .jpg 后缀。</p><p>那基于这种猜测我们怎么实现呢？</p><h3 id="根据webp支持度决定请求那种格式的图片"><a href="#根据webp支持度决定请求那种格式的图片" class="headerlink" title="根据webp支持度决定请求那种格式的图片"></a>根据webp支持度决定请求那种格式的图片</h3><p>首先要检测浏览器是否支持webp，下面是网上比较通用的方式。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 给html根节点加上webps类名</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addRootTag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        doc.documentElement.className += <span class="string">"webps"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否有webps=A这个cookie</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/(^|;\s?)webps=A/</span>.test(<span class="built_in">document</span>.cookie)) &#123;</span><br><span class="line">        <span class="keyword">var</span> image = <span class="keyword">new</span> Image();</span><br><span class="line">        <span class="comment">// 图片加载完成时候的操作</span></span><br><span class="line">        image.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 图片加载成功且宽度为1，那么就代表支持webp了，因为这张base64图是webp格式。如果不支持会触发image.error方法</span></span><br><span class="line">            <span class="keyword">if</span> (image.width == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// html根节点添加class，并且埋入cookie</span></span><br><span class="line">                addRootTag();</span><br><span class="line">                <span class="built_in">document</span>.cookie = <span class="string">"webps=A; max-age=31536000; domain=58.com"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 一张支持alpha透明度的webp的图片，使用base64编码</span></span><br><span class="line">        image.src = <span class="string">'data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA=='</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addRootTag();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;(<span class="built_in">document</span>));</span><br></pre></td></tr></table></figure><p>把这段js代码在引入css之前加载进来，如果浏览器支持webp则会给html元素添加webps这个类名。</p><p>接下来在css中如何使用呢，上面在在html元素加了webps这个类，那么在这个类下的元素就可以使用webp格式图片了 。</p><p>比如 </p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.webp-bg</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">620px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">304px</span>;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(assets/img/iweb.png);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.webps</span> <span class="selector-class">.webp-bg</span> &#123;</span><br><span class="line">    <span class="attribute">background-image</span>: <span class="built_in">url</span>(assets/img/iweb.png.webp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果使用了less或sass则更加简单，效率更高</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// less</span></span><br><span class="line"><span class="selector-class">.mixin</span>(<span class="variable">@url</span>) &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: url(<span class="string">@url</span>);</span><br><span class="line">  <span class="selector-class">.webps</span> <span class="selector-tag">&amp;</span> &#123;</span><br><span class="line">      <span class="attribute">background-image</span>: url(<span class="string">'@&#123;url&#125;.webp'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.webp-bg</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">620px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">304px</span>;</span><br><span class="line">  <span class="selector-class">.mixin</span>(<span class="string">'../../asset/img/iweb.png'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个函数，函数中处理图片格式的兼容，在背景图片使用的地方使用函数即可</p><p>sass中实现同理</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@mixin</span> bg($url) &#123;</span><br><span class="line">    <span class="attribute">background-image</span>: url(<span class="string">$url</span>);</span><br><span class="line">    <span class="variable">@at-root</span>(<span class="attribute">with</span>: all) .webps &amp; &#123;</span><br><span class="line">        <span class="attribute">background-image</span>: url(<span class="string">$url + '.webp'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么img标签的url需要检测 document.documentElement.className 中是否包含 webps来决定是否在url后面追加 .webp </p><p>这种方式在调试的时候就需要准备好webp图片，那么怎么得到webp图片呢 ？</p><p>webp图片可以去网站平台或者格式转换工具生成，但是每次都手动去转换显然是很繁琐效率低下的事情，在node中我们可以使用文件系统检测文件的变化，从而根据变化动态生成webp图片。</p><p>实现上述功能需要用到 chokidar 和 webp-converter</p><p>chokidar 可以用于监控文件、文件夹变化，我们可以传入 glob 文件匹配模式，并可以简单实现递归目录监控。chokidar 可以监控各种文件、文件夹变化事件，包含 <code>add</code> , <code>change</code> , <code>unlink</code> , <code>addDir</code> , <code>unlinkDir</code> 等。</p><p>webp-converter 是个webp转换器，用来将图片转换成webp格式，或者由webp转换成其他格式。</p><p>上述功能简单实现如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> chokidar = <span class="built_in">require</span>(<span class="string">'chokidar'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> webp = <span class="built_in">require</span>(<span class="string">'webp-converter'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> imgDir = <span class="string">'img'</span></span><br><span class="line"><span class="keyword">const</span> ignoreFiles = <span class="regexp">/(^\..+)/</span> <span class="comment">// 忽略文件.开头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Watcher = chokidar.watch(imgDir, &#123;</span><br><span class="line">  ignored: <span class="function"><span class="params">path</span> =&gt;</span> ignoreFiles.test(path),</span><br><span class="line">  persistent: <span class="literal">true</span></span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line">Watcher.on(<span class="string">'all'</span>, (event, path) =&gt; &#123;</span><br><span class="line">  <span class="comment">// console.log('event:', event, 'path:', path)</span></span><br><span class="line">  <span class="keyword">switch</span> (event) &#123;</span><br><span class="line">    <span class="comment">// add change unlink </span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'add'</span>: </span><br><span class="line">    <span class="keyword">case</span> <span class="string">'change'</span>:</span><br><span class="line">      createWebp(path)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'unlink'</span>: </span><br><span class="line">      deleteImage(path)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> deleteImage = <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> imgPath = <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="regexp">/\.webp$/</span>.test(path)) &#123;</span><br><span class="line">    imgPath = path.substr(<span class="number">0</span>, path.lastIndexOf(<span class="string">'.'</span>))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    imgPath = path + <span class="string">'.webp'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(imgPath)) &#123;</span><br><span class="line">    fs.unlinkSync(imgPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createWebp = <span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="regexp">/\.webp$/</span>.test(path)) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span>(fs.existsSync(path + <span class="string">'.webp'</span>)) <span class="keyword">return</span></span><br><span class="line">  webp.cwebp(path, path + <span class="string">'.webp'</span>, <span class="string">'-q 75'</span>, (status) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(status)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种方式需要在node环境中运行这个js文件，来检测文件夹变化，可以是一个文件夹，也可以检测多个文件夹的变化，后续可以考虑做成webpack插件，以便在工程化项目中更方便的使用。</p><p>这样我们就可以在开发调试的时候就使用上webp图片，这种方式更容易控制，但是管理起来更加繁琐。</p><p>下面介绍一种结合 Service Workers 的一种实现方案。</p><h3 id="Service-Workers-动态响应webp图片"><a href="#Service-Workers-动态响应webp图片" class="headerlink" title="Service Workers 动态响应webp图片"></a>Service Workers 动态响应webp图片</h3><p>Service Workers 同样也是比较新的技术，兼容性也不是很好，但是这个也是提升前端性能的重要途径，充分体现优雅降级，在支持它的浏览器中性能表现更为优异，不兼容的继续采用之前的方式。</p><p><img src="http://img14.360buyimg.com/uba/jfs/t28330/227/470674840/52834/9532d0e2/5bf4cce8N62374093.png" alt="1542249884726"></p><p>这种方式的的操作比较简单，在项目中的入口html文件中加入以下代码，用于注册Service Worker。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register the service worker</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">    navigator.serviceWorker.register(<span class="string">'./service-worker.js'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">registration</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Registration was successful</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ServiceWorker registration successful with scope: '</span>, registration.scope);</span><br><span class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// registration failed :(</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ServiceWorker registration failed: '</span>, err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果浏览器支持Service Workers 以上代码就会执行，不支持也不会影响项目的正常运行，用户其实是无感知的.</p><p>然后创建Service Worker文件<code>service-worker.js</code>，用于拦截正在传递到服务器的请求。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service-worker.js</span></span><br><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/\.jpe?g$|\.png$/</span>.test(event.request.url)) &#123;</span><br><span class="line">    <span class="keyword">var</span> supportsWebp = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (event.request.headers.has(<span class="string">'accept'</span>)) &#123;</span><br><span class="line">      supportsWebp = event.request.headers.get(<span class="string">'accept'</span>).includes(<span class="string">'webp'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsWebp) &#123;</span><br><span class="line">      <span class="keyword">var</span> req = event.request.clone();</span><br><span class="line">      <span class="keyword">var</span> returnUrl = req.url + <span class="string">'.webp'</span></span><br><span class="line">      event.respondWith(</span><br><span class="line">        fetch(returnUrl, &#123;</span><br><span class="line">          mode: <span class="string">'no-cors'</span></span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Service Worker 服务注册成功之后，给他添加事件监听，监听所有的fetch事件，fetch事件会拦截所有的请求，当请求发生时，先判断请求是否是请求的<code>JPEG/JPG/PNG</code>格式的图片，然后再通过查看请求头中的<code>accept</code>字段，检测是否支持<code>webp</code>格式的图片，支持的话Accept中存在<code>image/webp</code> Mime类型，如果支持则替换成webp图片的url，去请求webp图片，不支持则正常请求 <code>JPEG/JPG/PNG</code> 格式的图片。</p><p><img src="http://img13.360buyimg.com/uba/jfs/t25861/343/2406676566/32025/6d85f77f/5bf4cce8N1317770b.png" alt="1542250706599"></p><p>然后来看一下实际的效果，</p><p><img src="http://img13.360buyimg.com/uba/jfs/t27808/334/1995427189/4031/741665ad/5bf4cce8N1537074a.png" alt="1542250793076"></p><p>html中是去加载这张png格式的图片，然而我们看看实际的网络请求状况：</p><p><img src="http://img30.360buyimg.com/uba/jfs/t28849/219/479875041/14062/53449c0f/5bf4cce7N88d43324.png" alt="1542250942374"></p><p>这就是 Service Worker 的功劳，我们代码中只是需要 png格式图片，Service Worker 却给我们返回了 webp 格式的图片，再回顾一下 webp 格式图片的特点，相同质量下的图片 webp 比 png 小 26%，如果页面中有大量图片的话，带来的性能优化和节省的网络流量还是相当可观的。</p><p>Service Worker 的功能很强大，不仅可以拦截网络请求，还能进行缓存等更强大的功能，所以合理的运用它会给我们的web性能带来更为显著的提升。</p><p>Service Worker 只有在https协议下才能注册成功，因此这种方式仅仅只需要解决线上环境的优化处理，在项目开发阶段无需关心，也就是说我们在开发阶段可以不用考虑webp图片的兼容问题，代码中所有图片都使用常用格式图片。</p><p>那么现在又有一个问题，这些webp格式的图片怎么出现在线上服务器呢？</p><p>有一些线上工具可以进行图片格式的转换，可以寻找到一些解决方案，也可以使用一些插件工具比如谷歌官方的webp生成工具，安装通过命令生成图片，然后将webp格式图片和常用格式图片一并上传至服务器。</p><p>现在webpack已经成为前端开发者项目工程化比不可少的工具了，其实在webpack中配置响应的规则就可以自动化的生成webp的图片，同时配合 url-loader 将一些很小的图片转成 base64 进一步减少图片带来的网络请求。</p><p>说webpack 配置之前先说一个 loader –  multi-loader，它的主要作用简单来说就是同一规则进行了同时用多个loader进行加载编译，同时输出对应的文件或结果。</p><p>那么在 webpack 项目中我们可以只需要将png、jpg、jpeg等常见格式的图片引入项目中，所有的图片地址正常操作，在打包编译的时候，编译输出两张不同格式的图片即可，一张 webp 的，一张常规格式的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multi = <span class="built_in">require</span>(<span class="string">'multi-loader'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 图片加载规则</span></span><br><span class="line">true&#123;</span><br><span class="line">        test: <span class="regexp">/\.(jpg|png|gif|jpeg)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                loader: multi(</span><br><span class="line">                    <span class="string">'url-loader?limit=8192&amp;name=assets/img/[name].[ext].webp!webp-loader?&#123;quality: 75&#125;'</span>,</span><br><span class="line">                    <span class="string">'url-loader?limit=8192&amp;name=assets/img/[name].[ext]'</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>稍作解释，用 url-loader 加载图片，对于小于8kb（大小根据项目而定）的图片进行base64编码；对于大于8kb的图片，编译出正常常规的图片，同时再使用 webp-loader 编译出一张 webp 格式的图片， webp-loader 可以传参数 quality 代码图片的转码的质量，相当于进一步压缩，压缩出来的图片webp 的大小不到原始图片的一半。</p><p>然后配合上面的 service worker工作量很小，但是带来的性能优化却是很可观的。</p><p>上面这种方式确实可以实现从服务器动态加载webp格式的图片，但是我们发现这样去使用的话仅仅只是需要对项目中的静态图片进行拦截，而相关业务的图片加载并不需要拦截，或许服务器上根本就没有配置webp格式的图片，比如接口中返回的图片地址。因此需要对代码稍作调整，对项目开发中的静态图片地址加参数，在 service worker 中匹配图片格式和参数，从而避免一些不必要的拦截。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service-worker.js</span></span><br><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line">self.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="regexp">/(\.jpe?g|\.png)\?iswebp$/</span>.test(event.request.url)) &#123;</span><br><span class="line">    <span class="keyword">var</span> supportsWebp = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (event.request.headers.has(<span class="string">'accept'</span>)) &#123;</span><br><span class="line">      supportsWebp = event.request.headers.get(<span class="string">'accept'</span>).includes(<span class="string">'webp'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (supportsWebp) &#123;</span><br><span class="line">      <span class="keyword">var</span> req = event.request.clone();</span><br><span class="line">      <span class="keyword">var</span> returnUrl = req.url.substr(<span class="number">0</span>, req.url.lastIndexOf(<span class="string">"?"</span>)) + <span class="string">".webp"</span>;</span><br><span class="line">      <span class="comment">// var returnUrl = req.url + '.webp'</span></span><br><span class="line">      event.respondWith(</span><br><span class="line">        fetch(returnUrl, &#123;</span><br><span class="line">          mode: <span class="string">'no-cors'</span></span><br><span class="line">        &#125;)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>webpack 配置中也做一下调整，是打包出来的图片路径拼接上参数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> multi = <span class="built_in">require</span>(<span class="string">'multi-loader'</span>);</span><br><span class="line">...</span><br><span class="line">true&#123;</span><br><span class="line">        test: <span class="regexp">/\.(jpg|png|gif|jpeg)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line"></span><br><span class="line">            &#123;</span><br><span class="line">                loader: multi(</span><br><span class="line">                    <span class="string">'url-loader?limit=8192&amp;name=assets/img/[name].[ext].webp!webp-loader?&#123;quality: 75&#125;'</span>,</span><br><span class="line">                    <span class="string">'url-loader?limit=8192&amp;name=assets/img/[name].[ext]?iswebp'</span></span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这样就可以只对图片 url 中以 .iswebp结尾的请求进行拦截请求webp格式的图片，如果浏览器不支持，就会正常请求相应格式的图片。</p><p>这样做有个好处，除了静态资源上的图片可以这样处理以外，其他动态的接口图片地址根据实际情况也可以实现使用 webp ，因为仅仅只需要在图片url上加上iswebp标识，服务器有对应的webp图片即可。</p><p>这种方案更简单适用性更强，结合 Service Worker 性能上的提升会非常明显。</p><p>更多关于  Service Worker  的文档请移步 <a href="https://lavas.baidu.com/" target="_blank" rel="noopener"> https://lavas.baidu.com/</a></p><p><strong>结语</strong>：webp 格式图片现在呗越来越多的浏览器支持，它小体积高质量的特点使得它越来越受欢迎，我们可以在我们的项目中多使用它，利用它提升前端性能，同时也节省网络流量，webp只是解决方案之一，有更多更好的方案值得我们继续探索。webp 好用但也不是处处可用，项目中根据实际的业务场景和图片特性选择合理的图片格式才能真正体现它们的价值。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;现在我们看到的大多数网站，80%以上都是图片为主，所以图片的优化是前端性能优化的重要手段，也是非常有必要的一种手段。&lt;/p&gt;
&lt;p&gt;我们知道图片的体积越小加载越快，那么图片的优化主要是减小体积或者叫压缩体积，但是压缩体积会造成一定的质量牺牲，那么体积和质量之间怎么均衡呢。&lt;br&gt;
    
    </summary>
    
      <category term="前端新能" scheme="/categories/%E5%89%8D%E7%AB%AF%E6%96%B0%E8%83%BD/"/>
    
    
      <category term="性能优化" scheme="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    
      <category term="webp" scheme="/tags/webp/"/>
    
  </entry>
  
  <entry>
    <title>React Hooks</title>
    <link href="/react-hooks/"/>
    <id>/react-hooks/</id>
    <published>2018-11-20T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.254Z</updated>
    
    <content type="html"><![CDATA[<p>React v16.7.0-alpha 版本中发布了新的提案hook，什么是hook？ 官方给出如下说法。</p><blockquote><p><em>Hooks</em> are a new feature proposal that lets you use state and other React features without writing a class.</p><p>Hook是一项新功能提案，可让您在不编写类的情况下使用状态和其他React功能。</p></blockquote><p>在之前的react版本中，组件大多以Class的方式进行声明，以便处理组件的状态和一些功能特性，其中也有很多坑，很多繁琐的写法，在新的提案中将会简化很多。<br><a id="more"></a></p><p>新的提案中提出了好多Hook</p><ul><li>Basic Hooks<ul><li>useState</li><li>useEffect</li><li>useContext</li></ul></li><li>Additondal Hooks<ul><li>useReducer</li><li>useCallback</li><li>useMemo</li><li>useRef</li><li>useImperativeMethods</li><li>useMutationEffect</li><li>useLayoutEffect</li></ul></li></ul><p>Hooks 使用的前提是 必须在函数中使用，因此使用hooks进行开发意味着所有的组件都将以函数的方式呈现。在函数外使用hooks会报错</p><blockquote><p>Uncaught Error: Hooks can only be called inside the body of a function component.</p></blockquote><h3 id="Basic-Hooks"><a href="#Basic-Hooks" class="headerlink" title="Basic Hooks"></a>Basic Hooks</h3><h4 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h4><p>基础用法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = useState(initialState)</span><br></pre></td></tr></table></figure><p>setState是一个函数，接受一个初始状态，返回一个数组，第一项是state的值，第二项是改变这个state值的方法</p><p>初始状态一般是一个普通的值，但是如果初始的值需要经过复杂的计算得来的话，可以传递函数给它</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [state, setState] = useState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> initState = <span class="built_in">Math</span>.round(<span class="built_in">Math</span>.random() * <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">return</span> initState</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>setState方法用来更新state的，一般情况下传入新的state值即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setState(5)</span><br></pre></td></tr></table></figure><p>如果使用先前状态计算新状态，则可以将函数传递给setState。 该函数将接收先前的值，并返回更新的值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setState(<span class="function"><span class="params">prevState</span> =&gt;</span> prevState + <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>更新状态方法的使用和class方式的组件中的 this.setState 很相似，但是Hooks 中只能更新单一的状态，不支持合并更新状态对象，也就是说，每一个state 都需要通过 useState 进行初始化，每一个状态对应一个值和一个状态更新的方法，一个组件中有多个状态多次调用即可。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> [name, setName] = useState(<span class="string">'sqb'</span>)</span><br></pre></td></tr></table></figure><p>如果想更新多个状态，可以给 useState 传入对象， 更新状态的时候根据函数和扩展语法相结合来实现。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  name: <span class="string">'undo'</span>,</span><br><span class="line">  age: <span class="number">26</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (&#123;initialCount = <span class="number">0</span>&#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(initialCount)</span><br><span class="line">  <span class="keyword">const</span> [option, setOption] = useState(initialState)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Name: &#123; option.name &#125; Age: &#123;option.age&#125; Count: &#123; count &#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; setOption(preState =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        return &#123;...preState, ...&#123;name: 'sqb'&#125;&#125;</span></span><br><span class="line"><span class="regexp">      &#125;)&#125;&gt;setName&lt;/</span>button&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; setCount(<span class="number">0</span>)&#125;&gt;Reset&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; setCount(prevCount =&gt; prevCount + 1)&#125;&gt;+&lt;/</span>button&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; setCount(<span class="function"><span class="params">prevCount</span> =&gt;</span> prevCount - <span class="number">1</span>)&#125;&gt;-<span class="xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>后续可以通过 useReducer 来实现，后面再讲。</p><h4 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h4><p>函数中可以避免之前在 componentDidMount 、 componentDidUpdate 中的订阅，计时器等一些与副作用的操作，这些操作之前都需要在 componentWillUnmount 中取消订阅或者清理定时器，那么这个hook，将可以减少一些重复繁琐的操作。</p><p>相反，使用useEffect。传递给useEffect的函数将在渲染提交到屏幕后运行。将效果视为从React的纯粹功能性世界进入命令式世界的逃脱舱。</p><p>默认情况下，效果在每次完成渲染后运行，但您可以选择仅在某些值发生更改时触发它。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [num, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(num + <span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">2000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Interval Count: &#123; num &#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就实现了一个组件挂载即开启定时器的功能，但是仅仅是这样并不完整，当组件卸载的时候并不会清除定时器，控制台会报错。</p><p>通常，效果会创建在组件离开屏幕之前需要清理的资源，例如订阅或计时器ID。为此，传递给useEffect的函数可能会返回一个清理函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(num + <span class="number">1</span>)</span><br><span class="line">  &#125;, <span class="number">2000</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    clearInterval(timer)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这样在组件卸载的时候就就会清理掉定时器。清除功能在从UI中删除组件之前运行，以防止内存泄漏。此外，如果组件呈现多次（通常如此），则在执行下一个效果之前会清除先前的效果。在示例中，这意味着每次更新都会清理之前的定时器再创建新的定时器，哪怕是一些不相关的state发生变化也会做上面的事。</p><p>但是，在某些情况下，这样做是没必要的，性能是浪费的，例如我们有别的state数据发生更新与这个定时器毫无关系，那么这时候就没必要清理定时器再去重新开启。</p><p>要实现此功能，请将第二个参数传递给useEffect，它是效果所依赖的值数组。只有当数组中的值发生变化了才会使useEffect再次执行。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [num, setCount] = useState(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> [name, setName] = useState(<span class="string">'undo'</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      setCount(num + <span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">5000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'timer'</span>, timer)</span><br><span class="line">      clearInterval(timer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [num])</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Interval Count: &#123; num &#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;p onClick=&#123;()=&gt; &#123;setName(name === 'undo' ? 'sqb' : 'undo')&#125;&#125;&gt;Name: &#123; name &#125;&lt;/</span>p&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这样只有num值发生变化的时候才会重置定时器，当操作那么的时候Effect并不会不行，就可以避免一些不必要的清理，订阅和日志等同理。</p><p>那如果想要只在组件挂载的时候调用，也就是 componentDidMount 相同的功能也非常简单，给useEffect 第二个参数传一个空数组即可，表示告诉React这个效果不依赖于组件中的任何值，因此这个效果只会在组件挂载的时候运行。</p><p>也可以把它作为一个工具函数，在组件挂载和卸载的时候做一些操作的时候能够用到，例如在组件挂载的时候改变页面的标题，卸载的时候再重置到默认标题</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 工具函数</span></span><br><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">useDocumentTitle</span>(<span class="params">title</span>) </span>&#123;</span><br><span class="line">  useEffect(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="built_in">document</span>.title = title;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> (<span class="built_in">document</span>.title = <span class="string">"React App"</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    [title]</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 工具函数在组件中的使用</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; useDocumentTitle &#125; <span class="keyword">from</span> <span class="string">'../utils/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  useDocumentTitle(<span class="string">'Interval'</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;Interval Count&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个组件挂载的时候将页面标题设置为 ‘Interval’, 这个组件 销毁的时候将页面的标题重置回”React App”。</p><h3 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h3><p>接受上下文对象（从React.createContext返回的值）并返回当前上下文值，由给定上下文的最近上下文提供程序给出。有点类似Provider组件的功能。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外层组件</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> DeepChild <span class="keyword">from</span> <span class="string">'./DeepChild'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Context = React.createContext(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> someVal = &#123; <span class="attr">a</span>: <span class="string">'Context-a'</span>, <span class="attr">b</span>: <span class="string">'Context-b'</span> &#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Context.Provider value=&#123;someVal&#125;&gt;</span><br><span class="line">      &lt;DeepChild&gt;<span class="xml"><span class="tag">&lt;/<span class="name">DeepChild</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/Context.Provider&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DeepChild.js 子组件</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; useContext &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Context &#125; <span class="keyword">from</span> <span class="string">'./index'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> aa = useContext(Context)</span><br><span class="line">  <span class="built_in">console</span>.log(aa) <span class="comment">// &#123; a: 'Context-a', b: 'Context-b' &#125;</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;&#123;aa.a&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>在子组件中可以通过 useContext 拿到外层组件中通过上下文定义的数据，后续结合 <code>useReducer</code> 几乎就可以实现 react-redux 的功能了。</p><h2 id="Additondal-Hooks"><a href="#Additondal-Hooks" class="headerlink" title="Additondal Hooks"></a>Additondal Hooks</h2><h3 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h3><p>它是useState的替代方案，和redux的作用几乎一样，用来集中管理状态，而且基本流程和常用语法也是和redux一致的。它是一个函数 接受一个reducer，reducer我们也很熟悉了 （state，action）=&gt; newState ，一个接受当前状态和action指令返回新的状态的函数。</p><p>所以使用起来也是很顺手的，下面就是一个简单的todo的例子。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reducer.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; useReducer &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">const</span> initState = &#123;</span><br><span class="line">  name: <span class="string">'undo'</span>,</span><br><span class="line">  list: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> reducer = <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type &#125; = action</span><br><span class="line">  <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'change_name'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;<span class="attr">name</span>: action.name&#125;)</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'add'</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;<span class="attr">list</span>: [...state.list, action.data]&#125;)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; useReducer(reducer, initState)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// todo.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> todoReducer <span class="keyword">from</span> <span class="string">'./reducer'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = todoReducer()</span><br><span class="line">  <span class="keyword">const</span> &#123;name, list&#125; = state</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        list &amp;&amp; list.length &gt; <span class="number">0</span> &amp;&amp; list.map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> (</span><br><span class="line">          &lt;p key=&#123;index&#125;&gt;待办事项 &#123;item&#125;&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">        ))</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      &lt;p&gt;&#123;name&#125;&lt;/</span>p&gt;</span><br><span class="line">      &lt;button onClick=&#123;() =&gt; &#123;</span><br><span class="line">        dispatch(&#123;<span class="attr">type</span>: <span class="string">'add'</span>, <span class="attr">data</span>: list.length + <span class="number">1</span>&#125;)</span><br><span class="line">      &#125;&#125;&gt;</span><br><span class="line">        Add todo</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        dispatch(&#123;type: 'change_name', name: name === 'songqibin' ? 'undo' : 'songqibin'&#125;)</span></span><br><span class="line"><span class="regexp">      &#125;&#125;&gt;</span></span><br><span class="line"><span class="regexp">        Change name</span></span><br><span class="line"><span class="regexp">      &lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>很简单，和redux的用法几乎一样，useReducer 还支持第三个参数，可以进行一些初始化的操作。就像redux在初始化的时候会先执行一个 init 的action一样。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; useReducer(reducer, initState, &#123;<span class="attr">type</span>: <span class="string">'add'</span>, <span class="attr">data</span>: <span class="number">3</span>&#125;)</span><br></pre></td></tr></table></figure><p>其实如果再写一个合并reducer的函数，那么几乎可以完全实现redux的功能了。</p><h3 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a>useRef</h3><p>useRef返回一个可变的ref对象，其.current属性被初始化为传递的参数（initialValue）。返回的对象将持续整个组件的生命周期。</p><p>初始化传递的参数赋值给了ref对象的current属性，组件挂载完成之后current将指向指定的dom元素。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useRef &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> inputEle = useRef(<span class="literal">null</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(inputEle.current) <span class="comment">// null</span></span><br><span class="line">  <span class="keyword">const</span> onButtonClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(inputEle) <span class="comment">// input</span></span><br><span class="line">    inputEle.current.focus()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> onHandleChange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(inputEle.current.value) </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input ref=&#123;inputEle&#125; type=<span class="string">"text"</span> onChange=&#123;onHandleChange&#125; /&gt;</span><br><span class="line">      &lt;button onClick=&#123;onButtonClick&#125;&gt;Focus the input&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useRef 可以赋值初始值，可以避免直接使用ref方式造成的ref丢失的现象，以后的开发可能需要尽可能的使用它。</p><h3 id="useImperativeMethods"><a href="#useImperativeMethods" class="headerlink" title="useImperativeMethods"></a>useImperativeMethods</h3><p>useImperativeMethods自定义使用ref时公开给父组件的实例值，也就是说通过这个函数可以将子组件的实例提供给父组件访问调用。useImperativeMethods应与forwardRef一起使用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; useRef, useImperativeMethods, forwardRef &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">const</span> FancyInput = <span class="function">(<span class="params">props, ref</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> inputEle = useRef(<span class="literal">null</span>)</span><br><span class="line">  useImperativeMethods(ref, () =&gt; (&#123;</span><br><span class="line">    focus: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      inputEle.current.focus()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;))</span><br><span class="line">  <span class="keyword">const</span> onHandleChange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(inputEle.current.value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;inputEle&#125;</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">onChange</span>=<span class="string">&#123;onHandleChange&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">export default forwardRef(FancyInput)</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 父组件的使用， 在父组件中操作子组件让其聚焦</span></span><br><span class="line"><span class="keyword">import</span> React, &#123; useState, useRef &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> UseImperativeMethods <span class="keyword">from</span> <span class="string">'./UseImperativeMethods'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> fancyInputRef = useRef()</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div className=<span class="string">"App"</span>&gt;</span><br><span class="line">          &lt;UseImperativeMethods ref=&#123;fancyInputRef&#125;&gt;<span class="xml"><span class="tag">&lt;/<span class="name">UseImperativeMethods</span>&gt;</span></span></span><br><span class="line">          &lt;button onClick=&#123;() =&gt; &#123;fancyInputRef.current.focus()&#125;&#125;&gt;Focus child input&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">       </span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="useCallback"><a href="#useCallback" class="headerlink" title="useCallback"></a>useCallback</h3><p>返回一个memoized回调。</p><p>传递内联回调和一组输入。 useCallback将返回一个回忆的memoized版本，该版本仅在其中一个输入发生更改时才会更改。当将回调传递给依赖于引用相等性的优化子组件以防止不必要的渲染（例如，shouldComponentUpdate）时，这非常有用。</p><p>输入数组不作为参数传递给回调。但从概念上讲，这就是它们所代表的内容：回调中引用的每个值也应出现在输入数组中。将来，一个足够先进的编译器可以自动创建这个数组。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> memoizedCallback = useCallback(</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'useCallback'</span>, count)</span><br><span class="line">        <span class="keyword">return</span> count % <span class="number">3</span> === <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    [count],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="useMemo"><a href="#useMemo" class="headerlink" title="useMemo"></a>useMemo</h3><p>返回一个memoized值。和useCallback用法类似。</p><p>传递“创建”功能和输入数组。 useMemo只会在其中一个输入发生更改时重新计算memoized值。此优化有助于避免在每个渲染上进行昂贵的计算。</p><p>如果未提供数组，则只要将新函数实例作为第一个参数传递，就会计算新值。</p><p>输入数组不作为参数传递给函数。但从概念上讲，这就是它们所代表的内容：函数内部引用的每个值也应出现在输入数组中。将来，一个足够先进的编译器可以自动创建这个数组。</p><h3 id="useMutationEffect"><a href="#useMutationEffect" class="headerlink" title="useMutationEffect"></a>useMutationEffect</h3><p>签名与useEffect相同，但在更新兄弟组件之前，它在React执行其DOM突变的同一阶段同步触发。使用它来执行自定义DOM突变。</p><p>在可能的情况下首选标准useEffect以避免阻止视觉更新。</p><p>避免在useMutationEffect中读取DOM。如果这样做，您可以通过引入布局thrash来导致性能问题。在读取计算样式或布局信息时，useLayoutEffect更合适。</p><h3 id="useLayoutEffect"><a href="#useLayoutEffect" class="headerlink" title="useLayoutEffect"></a>useLayoutEffect</h3><p>签名与useEffect相同，但在所有DOM突变后同步触发。使用它来从DOM读取布局并同步重新渲染。在浏览器有机会绘制之前，将在useLayoutEffect内部计划的更新将同步刷新。</p><p>在可能的情况下首选标准useEffect以避免阻止视觉更新。</p><p>如果您正在从类组件迁移代码，则useLayoutEffect会在与componentDidMount和componentDidUpdate相同的阶段触发，因此如果您不确定Hook要使用哪种效果，则可能风险最小。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;React v16.7.0-alpha 版本中发布了新的提案hook，什么是hook？ 官方给出如下说法。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Hooks&lt;/em&gt; are a new feature proposal that lets you use state and other React features without writing a class.&lt;/p&gt;
&lt;p&gt;Hook是一项新功能提案，可让您在不编写类的情况下使用状态和其他React功能。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;在之前的react版本中，组件大多以Class的方式进行声明，以便处理组件的状态和一些功能特性，其中也有很多坑，很多繁琐的写法，在新的提案中将会简化很多。&lt;br&gt;
    
    </summary>
    
      <category term="React" scheme="/categories/React/"/>
    
    
      <category term="react" scheme="/tags/react/"/>
    
      <category term="react-hooks" scheme="/tags/react-hooks/"/>
    
  </entry>
  
  <entry>
    <title>redux源码 - 个人理解</title>
    <link href="/redux_understanding/"/>
    <id>/redux_understanding/</id>
    <published>2018-09-11T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.255Z</updated>
    
    <content type="html"><![CDATA[<p>最近项目中常用到<code>redux</code>，闲暇时间阅读了以下<code>redux</code>源码，结合自己使用的经验和习惯再去看源码以及设计者的设计思想，使得自己对<code>redux</code>的理解更加清晰，同时也对阅读源码有了一定的经验。</p><p>为什么想写这篇文章？</p><p>本来是在新的团队中参与项目开发，但是项目中的<code>redux</code>使用的流程和文件目录划分相对混乱，想结合自己的经验做一些改善，但是发现要做到这一点，需要先对<code>redux</code>有个清晰的认识，才能更好的完成这个目标。</p><a id="more"></a><p>首先看看<code>redux</code>库的<code>index.js</code>文件的导出</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  createStore,</span><br><span class="line">  combineReducers,</span><br><span class="line">  bindActionCreators,</span><br><span class="line">  applyMiddleware,</span><br><span class="line">  compose</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实这样看是很简单的，<code>redux</code>提供的API就这么几个，创建store、合并redudcer、action创造器、应用中间件工具函数compose。</p><p>下面一一来看，先来看一下<code>redux</code>的核心API <code>createStore</code></p><h2 id="1-createStore"><a href="#1-createStore" class="headerlink" title="1. createStore"></a>1. createStore</h2><p>先来说一下这个函数，接受参数是<code>reducer</code>，<code>preloadedState</code>，<code>enhancer</code>。</p><p><code>reducer</code>，是一个函数，传入当前的<code>state</code>和<code>action</code>，返回新的<code>state</code>，后面<code>combineReducers</code>的时候细说。</p><p><code>preloadedState</code>，可以理解为初始化的<code>state</code>。</p><p><code>enhancer</code>是中间件函数，<code>applyMiddleware</code>函数的返回值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 一堆的逻辑</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        dispatch,</span><br><span class="line">        subscribe,</span><br><span class="line">        getState,</span><br><span class="line">        replaceReducer,</span><br><span class="line">        [$$observable]: observable</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实这个函数导出的就是我们要用的<code>store</code>对象，常用的API是<code>dispatch</code>、<code>subscribe</code>、<code>getState</code>。</p><p>下面再继续深挖各个函数 </p><h3 id="1-1-getState"><a href="#1-1-getState" class="headerlink" title="1.1 getState"></a>1.1 getState</h3><p>这个函数很简单，作用就是返回当前的状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> currentState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-dispatch"><a href="#1-2-dispatch" class="headerlink" title="1.2 dispatch"></a>1.2 dispatch</h3><p>先来简单看一下这个函数的骨架</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 很多的错误检测和逻辑优化</span></span><br><span class="line">    <span class="comment">// currentListeners、nextListeners是局部的变量，监听着</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = currentListeners = nextListeners</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这个函数接受一个<code>action</code>，然后执行<code>reducer</code>更新<code>state</code>，然后让每个订阅者执行。</p><h3 id="1-3-subscribe"><a href="#1-3-subscribe" class="headerlink" title="1.3 subscribe"></a>1.3 subscribe</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</span><br><span class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected listener to be a function.'</span>)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">   ensureCanMutateNextListeners()</span><br><span class="line">   nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">       <span class="keyword">return</span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">     ensureCanMutateNextListeners()</span><br><span class="line">     <span class="keyword">const</span> index = nextListeners.indexOf(listener)</span><br><span class="line">     nextListeners.splice(index, <span class="number">1</span>)</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>这个函数是用来订阅<code>state</code>变化的， 接受一个订阅者，然后将该订阅者加入到订阅者列表中。订阅完成后返回一个取消订阅的函数，一般在组件销毁的时候调用，可提高性能。</p><h3 id="1-4-replaceReducer"><a href="#1-4-replaceReducer" class="headerlink" title="1.4 replaceReducer"></a>1.4 replaceReducer</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  currentReducer = nextReducer</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用来更行<code>reducer</code>的，开发中很少用到这个API。</p><p>所以综合以上几个函数，可以将<code>createStore</code>函数的核心简化理解为以下这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化store的action</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ActionTypes = &#123;</span><br><span class="line">  INIT: <span class="string">'@@redux/INIT'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer <span class="comment">// 当前的执行者currentReducer</span></span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState <span class="comment">// 当前的state</span></span><br><span class="line">  <span class="keyword">let</span> currentListeners = []  <span class="comment">// 订阅者列表</span></span><br><span class="line">  <span class="keyword">let</span> nextListeners = currentListeners  <span class="comment">// 新的订阅者列表</span></span><br><span class="line">  <span class="keyword">let</span> isDispatching = <span class="literal">false</span> <span class="comment">// action派发状态，可以优化性能</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新订阅者列表</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 获取当前state</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 订阅</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected listener to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      ensureCanMutateNextListeners()</span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.indexOf(listener)</span><br><span class="line">      nextListeners.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 派发action</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = currentListeners = nextListeners</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 更新reducer</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 初始化store</span></span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数最终返回了一个对象，通常我们会命名为<code>store</code>，<code>store.dispatch()</code>这样去使用。</p><h2 id="2-combineReducers"><a href="#2-combineReducers" class="headerlink" title="2. combineReducers"></a>2. combineReducers</h2><p>开发中统通常我们会把reducer按功能或按模块进行拆分成多个简单的<code>reducer</code>，<code>combineReducers</code> 的功能很简单，把多个简单的<code>reducer</code>进行合并，合并成一个大的<code>reducer</code>，一般的应用中都会用到。</p><p>单一的<code>reducer</code>一般是这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; GET_TASK_LIST &#125; <span class="keyword">from</span> <span class="string">'../actions/taskList'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> initState = &#123;</span><br><span class="line">    taskList: []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (state = initState, action = &#123;&#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type &#125; = action;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> GET_TASK_LIST:</span><br><span class="line">            <span class="keyword">return</span> &#123;...state, <span class="attr">taskList</span>: action.list &#125;; </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>combineReducers</code> 的功能就是把多个这样的<code>reducer</code>进行合并，进行统一管理。</p><p><code>combineReducers</code> 实现的核心代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看出函数接受的是一个<code>reducers</code>对象，每个<code>key</code>代表的是一个小的<code>reducer</code>，<code>combineReducers</code>返回一个新的<code>reducer</code>，每次这个新的<code>reducer</code>执行会遍历key组成的数组，并执行每个<code>key</code>对应的<code>reducer</code>，并将返回的新的<code>state</code>按照<code>key</code>进行合并组装成新的<code>state</code>对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">combineReducers(&#123;</span><br><span class="line">    tranning,</span><br><span class="line">    taskList</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回的state将会是</span></span><br><span class="line">&#123;</span><br><span class="line">    tranning: &#123;&#125;,</span><br><span class="line">    taskList: &#123;&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 要取得对应的state值需要向这样取</span></span><br><span class="line">state.taskList.xxx</span><br><span class="line">state.tranning.xxx</span><br></pre></td></tr></table></figure><p>注意：一般开发的时候会将<code>action</code>和<code>reducer</code>进行对应拆分，这样合并之后就可能会出现<code>action.type</code>重复的现象，导致<code>reducer</code>执行混乱。所以在写<code>action</code>的时候需要按模块名或者功能进行区分</p><h2 id="3-bindActionCreators"><a href="#3-bindActionCreators" class="headerlink" title="3. bindActionCreators"></a>3. bindActionCreators</h2><p>这个API运用场景很少，以至于我也不怎么理解它，官方是这样实现的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(actionCreator(...args))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把<code>action creators</code>转成拥有同名 <code>keys</code> 的对象，使用 <code>dispatch</code> 把每个 <code>action creator</code> 包围起来，这样可以直接调用它们。唯一使用 <code>bindActionCreators</code> 的场景是当你需要把 <code>action creator</code>往下传到一个组件上，却不想让这个组件觉察到 <code>Redux</code> 的存在，而且不希望把 <code>Redux store</code> 或 <code>dispatch</code>传给它。为方便起见，你可以传入一个函数作为第一个参数，它会返回一个函数。</p><h2 id="4-applyMiddleware"><a href="#4-applyMiddleware" class="headerlink" title="4.  applyMiddleware"></a>4.  applyMiddleware</h2><p>这个函数是使用中间件使<code>dispatch</code>函数更加强大，一般在需要在派发墙厚做一些额外操作的时候会用到它，比如<code>dispatch</code>一个函数等。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> (reducer, preloadedState, enhancer) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(reducer, preloadedState, enhancer)</span><br><span class="line">    <span class="keyword">let</span> dispatch = store.dispatch</span><br><span class="line">    <span class="keyword">let</span> chain = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</span><br><span class="line">    &#125;</span><br><span class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它将所有的中间件进行合并，并重写了<code>createStore</code>返回的<code>dispatch</code>函数，然后覆盖掉<code>store</code>的<code>dispatch</code>。</p><p>返回的函数也就是<code>enhancer</code>，传给<code>createStore</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(reducer, preloadedState, enhancer)</span><br></pre></td></tr></table></figure><h2 id="5-compose"><a href="#5-compose" class="headerlink" title="5. compose"></a>5. compose</h2><p>工具函数，将多个相互依赖的函数进行合并，在applyMiddleware函数中有用到。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是<code>redux</code>的核心实现方式，也都是源码中的代码片段，源码中有很多的工具函数和错误类型的判断，以及各种参数类型的兼容，可以在源码中进行查看。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近项目中常用到&lt;code&gt;redux&lt;/code&gt;，闲暇时间阅读了以下&lt;code&gt;redux&lt;/code&gt;源码，结合自己使用的经验和习惯再去看源码以及设计者的设计思想，使得自己对&lt;code&gt;redux&lt;/code&gt;的理解更加清晰，同时也对阅读源码有了一定的经验。&lt;/p&gt;
&lt;p&gt;为什么想写这篇文章？&lt;/p&gt;
&lt;p&gt;本来是在新的团队中参与项目开发，但是项目中的&lt;code&gt;redux&lt;/code&gt;使用的流程和文件目录划分相对混乱，想结合自己的经验做一些改善，但是发现要做到这一点，需要先对&lt;code&gt;redux&lt;/code&gt;有个清晰的认识，才能更好的完成这个目标。&lt;/p&gt;
    
    </summary>
    
      <category term="React" scheme="/categories/React/"/>
    
    
      <category term="redux" scheme="/tags/redux/"/>
    
  </entry>
  
  <entry>
    <title>react-native 文件下载</title>
    <link href="/rn_simple_download_manager/"/>
    <id>/rn_simple_download_manager/</id>
    <published>2018-07-10T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.256Z</updated>
    
    <content type="html"><![CDATA[<p>在做安卓App的时候，遇到一个需求下载pdf，下载完成在通知栏提示，并且能够打开下载的文件。</p><p>其实这个需求是很常见和普通的需求，但是刚做 RN 项目不久，遇到的这类问题也不是很会处理，特此记录一下。</p><p>本次是使用了一个 <code>react-native</code> 包, <strong>react-native-simple-download-manager</strong></p><a id="more"></a><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><p>用以下命令进行包安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-native-simple-download-manager</span><br><span class="line">// or </span><br><span class="line">npm i react-native-simple-download-manager --save</span><br></pre></td></tr></table></figure><p>link 一下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native link react-native-simple-download-manager</span><br></pre></td></tr></table></figure><h3 id="2-android-文件的修改"><a href="#2-android-文件的修改" class="headerlink" title="2. android 文件的修改"></a>2. android 文件的修改</h3><p>link 之后 android 下的文件会做以下改动</p><h4 id="1-android-app-src-main-java-…-MainApplication-java"><a href="#1-android-app-src-main-java-…-MainApplication-java" class="headerlink" title="1. android/app/src/main/java/[…]/MainApplication.java"></a>1. android/app/src/main/java/[…]/MainApplication.java</h4><p>添加 <code>import com.masteratul.downloadmanager.ReactNativeDownloadManagerPackage;</code></p><p>添加 <code>new ReactNativeDownloadManagerPackage()</code> 到 <code>getPackages()</code> 中</p><h4 id="2-android-settings-gradle"><a href="#2-android-settings-gradle" class="headerlink" title="2. android/settings.gradle"></a>2. android/settings.gradle</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">':react-native-simple-download-manager'</span></span><br><span class="line">project(<span class="string">':react-native-simple-download-manager'</span>).projectDir = <span class="keyword">new</span> File(rootProject.projectDir, <span class="string">'../node_modules/react-native-simple-download-manager/android'</span>)</span><br></pre></td></tr></table></figure><h4 id="3-android-app-build-gradle"><a href="#3-android-app-build-gradle" class="headerlink" title="3. android/app/build.gradle"></a>3. android/app/build.gradle</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile project(<span class="string">':react-native-simple-download-manager'</span>)</span><br></pre></td></tr></table></figure><h3 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h3><p>文件下载使用的是 <code>downloadManager.download</code> 方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> downloadManager <span class="keyword">from</span> <span class="string">'react-native-simple-download-manager'</span></span><br><span class="line"></span><br><span class="line">download = <span class="keyword">async</span> (orderId) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">'https://p.upyun.com/docs/cloud/demo.jpg'</span></span><br><span class="line">  <span class="keyword">const</span> headers = &#123;<span class="string">'Authorization'</span>: <span class="string">'Bearer abcsdsjkdjskjdkskjd'</span>&#125;;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    downloadTitle: <span class="string">'图片下载'</span>,</span><br><span class="line">    downloadDescription: <span class="string">'图片下载完成'</span>,</span><br><span class="line">    saveAsName: orderId + <span class="string">'.pdf'</span>,</span><br><span class="line">    allowedInRoaming: <span class="literal">true</span>,</span><br><span class="line">    allowedInMetered: <span class="literal">true</span>,</span><br><span class="line">    showInDownloads: <span class="literal">true</span>,</span><br><span class="line">    external: <span class="literal">false</span>, <span class="comment">// when false basically means use the default Download path (version ^1.3)</span></span><br><span class="line">    path: <span class="string">'Download/'</span> <span class="comment">// if "external" is true then use this path (version ^1.3)</span></span><br><span class="line">  &#125;</span><br><span class="line">  downloadManager.download(url, headers, config).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(url)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Download success!'</span>)</span><br><span class="line">    ToastAndroid.showWithGravity(<span class="string">'图片下载成功'</span>, ToastAndroid.SHORT, ToastAndroid.CENTER)</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">    ToastAndroid.showWithGravity(<span class="string">'图片下载失败，请重新下载'</span>, ToastAndroid.SHORT, ToastAndroid.CENTER)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是简单使用，config 中 external 为 false 时，只会下载，并在通知栏进行通知。</p><p>效果图如下</p><p><img src="https://raw.githubusercontent.com/undo03/undo03.github.io/master/article_images/ReactNative/20180712.gif" alt=""></p><p>配置项解析：</p><ul><li>url： 文件下载地址</li><li>headers： 请求头信息，需要身份认证的可以设置 Cookie</li><li>config： 配置信息<ul><li>downloadTitle： 通知栏通知标题</li><li>downloadDescription： 描述信息</li><li>saveAsName： 文件保存的名字</li><li>external： 是否保存到SD卡</li><li>path： 文件保存的路径，external 为 true 才有效</li></ul></li></ul><p>如果要保存到设备文件管理中，需要添加权限文件读写权限</p><p>需要在 <code>android/app/src/main/AndroidManifest.xml</code> 中添加权限</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;</span><br></pre></td></tr></table></figure><p>使用 PermissionsAndroid 检测是否开启权限</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;PermissionsAndroid&#125; <span class="keyword">from</span> <span class="string">'react-native'</span></span><br><span class="line"><span class="keyword">let</span> authorizedWriteSD = <span class="keyword">await</span> PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.WRITE_EXTERNAL_STORAGE).then(<span class="function"><span class="params">authorized</span> =&gt;</span> authorized)</span><br><span class="line"><span class="keyword">if</span> (authorizedWriteSD !== <span class="string">'granted'</span>) &#123;</span><br><span class="line">  ToastAndroid.showWithGravity(<span class="string">'请开启访问设备上照片、媒体内容和文件权限，否则无法保存文件'</span>, ToastAndroid.SHORT, ToastAndroid.CENTER)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    downloadTitle: <span class="string">'电子发票下载'</span>,</span><br><span class="line">    downloadDescription: <span class="string">'电子发票下载完成'</span>,</span><br><span class="line">    saveAsName: orderId + <span class="string">'.pdf'</span>,</span><br><span class="line">    allowedInRoaming: <span class="literal">true</span>,</span><br><span class="line">    allowedInMetered: <span class="literal">true</span>,</span><br><span class="line">    showInDownloads: <span class="literal">true</span>,</span><br><span class="line">    external: <span class="literal">true</span>, <span class="comment">// when false basically means use the default Download path (version ^1.3)</span></span><br><span class="line">    path: <span class="string">'Download/'</span> <span class="comment">// if "external" is true then use this path (version ^1.3)</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>设置带身份验证的下载</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = CONFIG.PREFIX + <span class="string">`order/download_pdf?order_id=<span class="subst">$&#123;orderId&#125;</span>`</span></span><br><span class="line"><span class="keyword">let</span> userInfoToken = <span class="keyword">await</span> localStorage.getItem(<span class="string">'userInfoToken'</span>)</span><br><span class="line"><span class="keyword">const</span> headers = &#123;<span class="string">'Cookie'</span>: userInfoToken&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="4-其他API"><a href="#4-其他API" class="headerlink" title="4. 其他API"></a>4. 其他API</h3><ul><li>download</li><li>queueDownload</li><li>attachOnCompleteListener</li><li>cancel</li><li>checkStatus</li></ul><p>具体可以查看 <a href="https://github.com/master-atul/react-native-simple-download-manager/blob/master/index.js" target="_blank" rel="noopener">https://github.com/master-atul/react-native-simple-download-manager/blob/master/index.js</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在做安卓App的时候，遇到一个需求下载pdf，下载完成在通知栏提示，并且能够打开下载的文件。&lt;/p&gt;
&lt;p&gt;其实这个需求是很常见和普通的需求，但是刚做 RN 项目不久，遇到的这类问题也不是很会处理，特此记录一下。&lt;/p&gt;
&lt;p&gt;本次是使用了一个 &lt;code&gt;react-native&lt;/code&gt; 包, &lt;strong&gt;react-native-simple-download-manager&lt;/strong&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ReactNative" scheme="/categories/ReactNative/"/>
    
    
      <category term="react-native" scheme="/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>git-flow 工作流程</title>
    <link href="/git_git_flow/"/>
    <id>/git_git_flow/</id>
    <published>2018-07-03T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.254Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p><code>git</code> 最强大的就是其分支功能，但是如何分支才能更有效的提高开发效率，减少因为代码合并带来的问题，需要一个分支模型来规范，其实在<code>git flow</code> 出现之前，已经有分支模型理论流程，当时是根据此理论，手动的按照规范操作分支，<code>git flow</code> 出现之后，将一部分操作流程简化为命令，并没有增加新的功能，只是简化了操作。</p><a id="more"></a><h2 id="二、git-flow-简介"><a href="#二、git-flow-简介" class="headerlink" title="二、git-flow 简介"></a>二、git-flow 简介</h2><p>安装<code>git-flow</code>后，你将会拥有一些扩展命令。这些命令会在一个预定义的顺序下自动执行多个操作。<br><code>git-flow</code> 并不是要替代 Git，它仅仅是非常聪明有效地把标准的 <code>Git</code> 命令用脚本组合了起来。<br>严格来讲，你并不需要安装什么特别的东西就可以使用 <code>git-flow</code> 工作流程。你只需要了解，哪些工作流程是由哪些单独的任务所组成的，并且附带上正确的参数，以及在一个正确的顺序下简单执行那些对应的 Git 命令就可以了。当然，如果你使用 <code>git-flow</code> 脚本就会更加方便了，你就不需要把这些命令和顺序都记在脑子里。</p><h2 id="三、安装"><a href="#三、安装" class="headerlink" title="三、安装"></a>三、安装</h2><p>目前流行的是 avh 版本的<code>git-flow</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 稳定版</span></span><br><span class="line">brew install git-flow-avh</span><br><span class="line"><span class="comment"># 开发板</span></span><br><span class="line">brew install git-flow-avh --HEAD</span><br></pre></td></tr></table></figure></p><h2 id="四、初始化项目"><a href="#四、初始化项目" class="headerlink" title="四、初始化项目"></a>四、初始化项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd /pass/to/your/project</span></span><br><span class="line"><span class="comment"># 执行下面的命令，不需要执行 git init</span></span><br><span class="line">git flow init</span><br></pre></td></tr></table></figure><h2 id="五、分支模型"><a href="#五、分支模型" class="headerlink" title="五、分支模型"></a>五、分支模型</h2><p>用 <code>git flow</code> 初始化工程目录完成后，只能看到两个分支：</p><p>Gitflow使用两个分支来记录项目开发的历史，而不是使用单一的master分支。在Gitflow流程中，master只是用于保存官方的发布历史，而develop分支才是用于集成各种功能开发的分支。使用版本号为master上的所有提交打标签（tag）也很方便。<br><img src="https://github.com/undo03/undo03.github.io/blob/master/article_images/Perphery/2018-07-04_13-04-49.png?raw=true" alt=""><br>事实上，Gitflow流程就是围绕这两个特点鲜明的分支展开的。</p><h3 id="master-分支"><a href="#master-分支" class="headerlink" title="master 分支"></a>master 分支</h3><p>用于上线的分支，保护性分支，只包含经过测试的稳定代码，开发人员不能直接工作在此分支上，也不能直接提交改动到 master 分支上。</p><h3 id="develop分支"><a href="#develop分支" class="headerlink" title="develop分支"></a>develop分支</h3><p>是开发人员进行任何新的开发的基础分支，当开始一个新的feature 分支的时候，要从 develop 分出去；另外此分支也汇集所有的已完成的功能，等待合并到 master 分支上线。</p><p>上面两个分支被称为<strong>长期分支</strong>  ，存在于项目的整个生命周期中，其他分支，是临时性的，根据需要来创建，当完成了自己的任务后，就会被删掉。</p><h3 id="feature-分支"><a href="#feature-分支" class="headerlink" title="feature 分支"></a>feature 分支</h3><p>平常的开发工作使用最频繁的分支。每一个新功能的开发都应该各自使用独立的分支。为了备份或便于团队之间的合作，这种分支也可以被推送到中央仓库。但是，在创建新的功能开发分支时，父分支应该选择develop（而不是master）。当功能开发完成时，改动的代码应该被合并（merge）到develop分支。功能开发永远不应该直接牵扯到master。<br><img src="https://github.com/undo03/undo03.github.io/blob/master/article_images/Perphery/2018-07-04_13-07-31.png?raw=true" alt=""></p><h4 id="1-开始一个feature分支"><a href="#1-开始一个feature分支" class="headerlink" title="1. 开始一个feature分支"></a>1. 开始一个feature分支</h4><p>如下命令会创建一个名为”feature/” 的功能分支，该分支默认从 develop检出，在做功能性开发的时候，检出一个独立的分支，是版本控制中一个重要 的原则。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git-flow 创建 feature 分支</span></span><br><span class="line">$ git flow feature start &lt;branch-name&gt;</span><br></pre></td></tr></table></figure><h4 id="2-完成一个feature分支"><a href="#2-完成一个feature分支" class="headerlink" title="2. 完成一个feature分支"></a>2. 完成一个feature分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git-flow 完成一个 feature 分支 </span></span><br><span class="line">$ git flow feature finish &lt;branch-name&gt;</span><br></pre></td></tr></table></figure><p>该命令会把我们在当前分支的代码整合到‘develop’分支中去，之后，<code>git-flow</code> 会进行清理操作，删除当下完成的功能分支，将分支切换到‘develop’。</p><h3 id="release-分支"><a href="#release-分支" class="headerlink" title="release 分支"></a>release 分支</h3><p>一旦develop分支积聚了足够多的新功能（或者预定的发布日期临近了），你可以基于develop分支建立一个用于产品发布的分支。这个分支的创建意味着一个发布周期的开始，也意味着本次发布不会再增加新的功能——在这个分支上只能修复bug，做一些文档工作或者跟发布相关的任务。在一切准备就绪的时候，这个分支会被合并入master，并且用版本号打上标签。另外，发布分支上的改动还应该合并入develop分支——在发布周期内，develop分支仍然在被使用（一些开发者会把其他功能集成到develop分支）。使用专门的一个分支来为发布做准备的好处是，在一个团队忙于当前的发布的同时，另一个团队可以继续为接下来的一次发布开发新功能。</p><p><img src="https://github.com/undo03/undo03.github.io/blob/master/article_images/Perphery/2018-07-04_13-13-20.png?raw=true" alt=""></p><h4 id="1-创建一个release分支"><a href="#1-创建一个release分支" class="headerlink" title="1.创建一个release分支"></a>1.创建一个release分支</h4><p>当你认为现在在 “develop” 分支的代码已经是一个成熟的 release 版本时，这意味着：第一，它包括所有新的功能和必要的修复；第二，它已经被彻底的测试过了。如果上述两点都满足，那就是时候开始生成一个新的 release 了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git flow release start 1.1.5</span><br><span class="line">Switched to a new branch <span class="string">'release/1.1.5'</span></span><br></pre></td></tr></table></figure><p>请注意，release 分支是使用版本号命名的。这是一个明智的选择，这个命名方案还有一个很好的附带功能，那就是当我们完成了release 后，git-flow 会适当地_自动_去标记那些 release 提交。</p><p>有了一个 release 分支，再完成针对 release 版本号的最后准备工作（如果项目里的某些文件需要记录版本号），并且进行最后的编辑。</p><h4 id="2-完成一个release分支"><a href="#2-完成一个release分支" class="headerlink" title="2. 完成一个release分支"></a>2. 完成一个release分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git flow release finish 1.1.5</span><br></pre></td></tr></table></figure><p>这个命令会完成如下一系列的操作：</p><ol><li>首先，git-flow 会拉取远程仓库，以确保目前是最新的版本。</li><li>然后，release 的内容会被合并到 “master” 和 “develop” 两个分支中去，这样不仅产品代码为最新的版本，而且新的功能分支也将基于最新代码。</li><li>为便于识别和做历史参考，release 提交会被标记上这个 release 的名字（在我们的例子里是 “1.1.5”）。</li><li>清理操作，版本分支会被删除，并且回到 “develop”。</li></ol><p>从 Git 的角度来看，release 版本现在已经完成。依据你的设置，对 “master” 的提交可能已经触发了你所定义的部署流程，或者你可以通过手动部署，来让你的软件产品进入你的用户手中。</p><h3 id="hotfix分支"><a href="#hotfix分支" class="headerlink" title="hotfix分支"></a>hotfix分支</h3><p>发布后的维护工作或者紧急问题的快速修复也需要使用一个独立的分支。这是唯一一种可以直接基于master创建的分支。一旦问题被修复了，所做的改动应该被合并入master和develop分支（或者用于当前发布的分支）。在这之后，master上还要使用更新的版本号打好标签。<br><img src="https://github.com/undo03/undo03.github.io/blob/master/article_images/Perphery/2018-07-04_13-36-09.png?raw=true" alt=""></p><h4 id="1-创建一个hotfix分支"><a href="#1-创建一个hotfix分支" class="headerlink" title="1. 创建一个hotfix分支"></a>1. 创建一个hotfix分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git flow hotfix start missing-link</span><br></pre></td></tr></table></figure><p>这个命令会创建一个名为“hotfix/missing-link” 的分支。因为这是对产品代码进行修复，所以这个hotfix分支是基于“master”分支。</p><p>这也是和 release 分支最明显的区别，release 分支都是基于 “develop” 分支的。因为你不应该在一个还不完全稳定的开发分支上对产品代码进行地修复。</p><p>就像 release 一样，修复这个错误当然也会直接影响到项目的版本号！</p><h4 id="2-完成一个hotfix分支"><a href="#2-完成一个hotfix分支" class="headerlink" title="2.完成一个hotfix分支"></a>2.完成一个hotfix分支</h4><p>在把我们的修复提交到hotfix分支之后，就该去完成它了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git flow hotfix finish missing-link</span><br></pre></td></tr></table></figure><p>这个过程非常类似于发布一个 release 版本：</p><ul><li>完成的改动会被合并到 “master” 中，同样也会合并到 “develop” 分支中，这样就可以确保这个错误不会再次出现在下一个 release 中。</li><li>这个 hotfix 会被标记起来以便于参考。</li><li>这个 hotfix 分支将被删除，然后切换到 “develop” 分支上去。</li></ul><p>还是和产生 release 的流程一样，现在需要编译和部署你的产品（如果这些操作不是自动被触发的话）。</p><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><h4 id="主要分支"><a href="#主要分支" class="headerlink" title="主要分支"></a>主要分支</h4><p><strong>master</strong>: 项目的主要分支，对外的第一门面。所有人浏览项目，使用项目，第一时间看到的是master。永远处在即将发布(production-ready)状态。<br><strong>develop</strong>: 处于功能开发的最前线的版本，查看develop分支就能知道下一个发布版本有哪些功能了。develop一开始是从master里分出来的，并且定期会合并到master里，每一次合并到master，表示我们完成了一个阶段的开发，产生一个稳定版。同样的，develop下也不建议直接开发代码，develop代表的是已经开发好的功能的<strong>回归</strong>版本。最后，在适当的时候，由合适的人，合并到master，作为下一个稳定版本。</p><blockquote><p>feature的作用是为每一个新功能从develop里创建出来的一个分支。例如小明和小白分别做两个不相干的功能，就应该分别创建两个分支，各自开发完以后，先后合并到develop里，这就叫做<strong>回归</strong>。</p></blockquote><h4 id="辅助分支"><a href="#辅助分支" class="headerlink" title="辅助分支"></a>辅助分支</h4><p><strong>feature</strong>: 开发新功能的分支, 基于 develop, 完成后 merge 回 develop<br><strong>release</strong>: 准备要发布版本的分支, 也基于 develop, 完成后 merge 回 develop 和 master<br><strong>hotfix</strong>: 修复 master 上的问题, 等不及 release 版本就必须马上上线. 基于 master, 完成后 merge回 master 和 develop</p><p><strong>本文转载自</strong>: <a href="https://www.lishuaishuai.com/tool/791.html" target="_blank" rel="noopener">https://www.lishuaishuai.com/tool/791.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;一、前言&quot;&gt;&lt;a href=&quot;#一、前言&quot; class=&quot;headerlink&quot; title=&quot;一、前言&quot;&gt;&lt;/a&gt;一、前言&lt;/h2&gt;&lt;p&gt;&lt;code&gt;git&lt;/code&gt; 最强大的就是其分支功能，但是如何分支才能更有效的提高开发效率，减少因为代码合并带来的问题，需要一个分支模型来规范，其实在&lt;code&gt;git flow&lt;/code&gt; 出现之前，已经有分支模型理论流程，当时是根据此理论，手动的按照规范操作分支，&lt;code&gt;git flow&lt;/code&gt; 出现之后，将一部分操作流程简化为命令，并没有增加新的功能，只是简化了操作。&lt;/p&gt;
    
    </summary>
    
      <category term="Git" scheme="/categories/Git/"/>
    
    
      <category term="Git" scheme="/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Promise 简单介绍</title>
    <link href="/js_promise/"/>
    <id>/js_promise/</id>
    <published>2018-06-21T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.250Z</updated>
    
    <content type="html"><![CDATA[<p><code>Promise</code>对于每一个前端工程师来说都不陌生,在项目开发中的使用也是越来越频繁,各大主流浏览器厂商也是对它做了很好的支持. Promise的出现解决了回调地狱的问题, 同时多个异步任务同时执行可以节省时间.</p><a id="more"></a><h3 id="1-Promise简介"><a href="#1-Promise简介" class="headerlink" title="1. Promise简介"></a>1. Promise简介</h3><p><code>Promise</code>本意是承诺，在程序中的意思就是承诺我<code>过一段时间后</code>会给你一个结果。 什么时候会用到过一段时间？答案是异步操作，异步是指可能比较长时间才有结果的才做,常见的比如网络请求、文件读取等.</p><p>传统的异步操作都是传回调函数,异步完成后执行回调,<code>promise</code>就是为了改变这种模式,把异步中使用回调函数的场景改为了<code>.then()</code>、<code>.catch()</code>等函数链式调用的方式,避免回调地狱,基于<code>promise</code>可以把复杂的异步回调处理方式进行模块化.</p><p>以<code>ajax</code>为例,传统的异步写法:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ajax(method, url, successFun, failFun)&#123;</span><br><span class="line">  <span class="keyword">var</span> xmlHttp = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">  xmlHttp.open(method, url)</span><br><span class="line">  xmlHttp.send()</span><br><span class="line">  xmlHttp.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="number">200</span> ) &#123;</span><br><span class="line">      successFun(<span class="keyword">this</span>.response)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      failFun(<span class="keyword">this</span>.statusText)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  xmlHttp.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    failFun(<span class="keyword">this</span>.statusText)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试改写成<code>promise</code>的方式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ajaxPromise(method, url, successFun, failFun)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xmlHttp = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">    xmlHttp.open(method, url)</span><br><span class="line">    xmlHttp.send()</span><br><span class="line">    xmlHttp.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="number">200</span> ) &#123;</span><br><span class="line">        resolve(<span class="keyword">this</span>.response)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(<span class="keyword">this</span>.statusText)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    xmlHttp.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      reject(<span class="keyword">this</span>.statusText)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就可以链式使用了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ajaxPromise(<span class="string">'get'</span>,<span class="string">'www.xxx.com'</span>).then(successFun, failFun)</span><br></pre></td></tr></table></figure><h3 id="2-Promise原理分析"><a href="#2-Promise原理分析" class="headerlink" title="2. Promise原理分析"></a>2. Promise原理分析</h3><p><code>promise</code>原理并不难,它内部有三个状态，分别是<code>pending</code>,<code>fulfilled</code>和<code>rejected</code> .</p><ul><li><code>Pending</code> Promise对象实例创建时候的初始状态</li><li><code>Fulfilled</code> 可以理解为成功的状态</li><li><code>Rejected</code> 可以理解为失败的状态</li></ul><p><code>pending</code>是对象创建后的初始状态,当对象<code>fulfill（成功）</code>时变为<code>fulfilled</code>,当对象<code>reject（失败）</code>时变为<code>rejected</code>.且只能从<code>pengding</code>变为<code>fulfilled</code>或<code>rejected</code>,之后就不会再次发生变化 ,不能逆向或从<code>fulfilled</code>变为<code>rejected</code> 、从<code>rejected</code>变为<code>fulfilled</code>.</p><blockquote><p><code>then</code> 方法就是用来指定<code>Promise</code>对象的状态改变时确定执行的操作,<code>resolve</code> 时执行第一个函数<code>onFulfilled</code>,<code>reject</code> 时执行第二个函数<code>onRejected</code></p></blockquote><h3 id="3-Promise-简单模拟"><a href="#3-Promise-简单模拟" class="headerlink" title="3. Promise 简单模拟"></a>3. Promise 简单模拟</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Promise</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(fn) &#123;</span><br><span class="line">        fn(<span class="function">(<span class="params">data</span>)=&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.success(data)</span><br><span class="line">        &#125;, (error)=&gt; &#123;</span><br><span class="line">            <span class="keyword">this</span>.error()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    resolve(data) &#123;</span><br><span class="line">        <span class="keyword">this</span>.success(data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reject(error) &#123;</span><br><span class="line">        <span class="keyword">this</span>.error(error)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    then(success, error) &#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success</span><br><span class="line">        <span class="keyword">this</span>.error = error</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-Promise基本用法"><a href="#4-Promise基本用法" class="headerlink" title="4. Promise基本用法"></a>4. Promise基本用法</h3><p><code>Promise</code>对象拥有两个实例方法<code>then()</code>,<code>catch()</code> 和 <code>finally</code>,<code>then</code>方法返回新的<code>promise</code>,因此支持链式写法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> flag = <span class="built_in">Math</span>.random()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">            resolve(<span class="string">'success'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="string">'fail'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">500</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;) <span class="comment">// 0.5s后这里的输出可能是fail也可能是success</span></span><br></pre></td></tr></table></figure><p>构造函数<code>Promise</code>的参数时一个函数,这个函数接收来两个参数<code>resolve</code>和<code>reject</code>,<code>resolve</code>和<code>reject</code>同时也是函数,<code>resolve</code>会在<code>promise</code>从<code>pending</code>转换成 <code>Fulfilled</code>时执行, <code>reject</code>会在<code>promise</code>从<code>pending</code>转换成 <code>Rejected</code>时执行.</p><h4 id="4-1-Promise-prototype-catch"><a href="#4-1-Promise-prototype-catch" class="headerlink" title="4.1 Promise.prototype.catch()"></a>4.1 Promise.prototype.catch()</h4><p><code>then()</code>方法会返回一个新的<code>promise</code>,<code>then</code>方法将上一步的返回结果获取过来进行后续的处理,它接受两个函数作为参数，第一个函数是用来处理<code>resolve</code>的结果，第二个是可选的，用来处理<code>reject</code>的结果,<code>then</code>对应的参数不为函数时,会将前一<code>promise</code>的状态和值传递下去.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    reject(<span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p1 = p.then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value) </span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p2 = p1.then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fulfill '</span> + value)</span><br><span class="line">&#125;, (reason) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'reject '</span> + reason)   <span class="comment">// reject 5</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="number">5</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p1 = p.then(<span class="literal">undefined</span>, (value) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value) </span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">let</span> p2 = p1.then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fulfill '</span> + value)   <span class="comment">// fulfill 5</span></span><br><span class="line">&#125;, (reason) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'reject '</span> + reason)   </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="4-2-Promise-prototype-catch"><a href="#4-2-Promise-prototype-catch" class="headerlink" title="4.2 Promise.prototype.catch()"></a>4.2 Promise.prototype.catch()</h4><p><code>catch()</code>方法其实是<code>then</code>方法的一种语法糖,当<code>then</code>方法第一个参数传<code>undefined</code> 或者 <code>null</code>即可达到<code>catch</code>的目的</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> flag = <span class="built_in">Math</span>.random()</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(flag &gt; <span class="number">0.5</span>) &#123;</span><br><span class="line">            resolve(<span class="string">'success'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            reject(<span class="string">'fail'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">500</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// then处理resolve和reject的结果</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// then处理resolve,catch处理reject的结果</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;).catch( <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用then的方式实现catch功能</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;).then(<span class="literal">null</span>, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用then的方式实现catch功能,捕获then中的错误异常</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(result)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'then Error'</span>)</span><br><span class="line">&#125;).then(<span class="literal">null</span>, (err)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="4-3-Promise-prototype-finally"><a href="#4-3-Promise-prototype-finally" class="headerlink" title="4.3 Promise.prototype.finally()"></a>4.3 Promise.prototype.finally()</h4><p><code>finally()</code> 方法返回一个<code>Promise</code>,在执行<code>then()</code>和<code>catch()</code>后,都会执行<code>finally</code>指定的回调函数.避免同样的语句需要在<code>then()</code>和<code>catch()</code>中各写一次的情况.</p><p><code>finally()</code> 虽然与 <code>.then(onFinally, onFinally)</code> 类似,它们不同的是:</p><ul><li>调用内联函数时,不需要多次声明该函数或为该函数创建一个变量保存它.</li><li>由于无法知道<code>promise</code>的最终状态,所以<code>finally</code>的回调函数中不接收任何参数,它仅用于无论最终结果如何都要执行的情况.</li><li>与<code>Promise.resolve(2).then(() =&gt; {}, () =&gt; {})</code> （<code>resolved</code>的结果为<code>undefined</code>）不同,<code>Promise.resolve(2).finally(() =&gt; {})</code> <code>resolved</code>的结果为 <code>2</code>.</li><li>同样,<code>Promise.reject(3).then(() =&gt; {}, () =&gt; {})</code> (<code>resolved</code> 的结果为<code>undefined</code>), <code>Promise.reject(3).finally(() =&gt; {})</code> rejected 的结果为 <code>3</code>.</li></ul><h3 id="5-Promise-API"><a href="#5-Promise-API" class="headerlink" title="5. Promise  API"></a>5. Promise  API</h3><p><code>Promise</code>还有四个静态方法，分别是<code>resolve</code>、<code>reject</code>、<code>all</code>、<code>race</code>,下面一一介绍.</p><p>除了通过<code>new Promise()</code>的方式，我们还有两种创建<code>Promise</code>对象的方法,分别是<code>Promise.resolve()</code> 和 <code>Promise.reject()</code></p><h4 id="5-1-Promise-resolve"><a href="#5-1-Promise-resolve" class="headerlink" title="5.1 Promise.resolve"></a>5.1 Promise.resolve</h4><p><code>Promise.resolve()</code> 它相当于创建了一个立即<code>resolve</code>的<code>promise</code>对象,这个对象处于<code>resolve</code>状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p1 = <span class="built_in">Promise</span>.resolve(<span class="string">'resolve'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">'resolve'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p1.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res) <span class="comment">// resolve</span></span><br><span class="line">&#125;)</span><br><span class="line">p2.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res) <span class="comment">// resolve</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="5-2-Promise-reject"><a href="#5-2-Promise-reject" class="headerlink" title="5.2 Promise.reject"></a>5.2 Promise.reject</h4><p><code>Promise.reject()</code> 很明显它相当于创建了一个立即<code>reject</code>的<code>promise</code>对象,这个对象处于<code>reject</code>状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.reject(<span class="string">'err'</span>).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err) <span class="comment">// err</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="5-3-Promise-all"><a href="#5-3-Promise-all" class="headerlink" title="5.3 Promise.all"></a>5.3 Promise.all</h4><p><code>Promise.all()</code> 它接收一个promise对象组成的数组作为参数，并返回一个新的<code>promise</code>对象</p><p>当数组中所有的对象都<code>resolve</code>时，<code>promise</code>对象状态变为<code>fulfilled</code>，所有对象的<code>resolve</code>的<code>value</code>依次添加组成一个新的数组，并以新的数组作为新<code>promise</code>对象<code>resolve</code>的<code>value</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([<span class="built_in">Promise</span>.resolve(<span class="string">'p1'</span>),</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="string">'p2'</span>),</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="string">'p3'</span>)]).then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fulfill'</span>, value)  <span class="comment">// fulfill [ 'p1', 'p2', 'p3' ]</span></span><br><span class="line">&#125;, (reason) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'reject'</span>,reason)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>当数组中有一个对象<code>reject</code>时，<code>promise</code>对象状态变为<code>rejected</code>，并以当前对象<code>reject</code>的<code>reason</code>作为新<code>promise</code>对象<code>reject</code>的<code>reason</code></p><p>当数组中传入了非promise对象,会依次把它们添加到新<code>promise</code>对象<code>resolve</code>时传递的数组中.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.all([<span class="built_in">Promise</span>.resolve(<span class="number">5</span>),</span><br><span class="line">    <span class="number">6</span>,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    <span class="string">'test'</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    &#123;<span class="attr">a</span>:<span class="number">1</span>&#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;,</span><br><span class="line">    <span class="built_in">Promise</span>.resolve(<span class="string">'end'</span>)</span><br><span class="line">]).then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fulfill'</span>, value)  <span class="comment">// fulfill [ 5, 6, true, 'test', undefined, null, &#123; a: 1 &#125;, [Function], 'end' ]</span></span><br><span class="line">&#125;, (reason) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'reject'</span>, reason)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>数组中的多个<code>promise</code>对象几乎是同时执行的,总的时间略大于用时最长的一个对象<code>resolve</code>的时间</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> timeout = <span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(time)</span><br><span class="line">        &#125;, time)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'promise'</span>)</span><br><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">    timeout(<span class="number">10</span>),</span><br><span class="line">    timeout(<span class="number">60</span>),</span><br><span class="line">    timeout(<span class="number">100</span>)</span><br><span class="line">]).then(<span class="function">(<span class="params">values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(values) <span class="comment">//[10, 60, 100]</span></span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'promise'</span>)   <span class="comment">// promise: 101.875ms</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>Promise.all()</code>中即使前面<code>reject</code>了,所有的对象也都会执行完毕.规范中<code>promise</code>对象执行是不可以中断的.</p><h4 id="5-4-Promise-race"><a href="#5-4-Promise-race" class="headerlink" title="5.4 Promise.race"></a>5.4 Promise.race</h4><p><code>Promise.race()</code> 它同样接收一个<code>promise</code>对象组成的数组作为参数,并返回一个新的<code>promise</code>对象</p><p>与<code>Promise.all()</code>不同的是,它是在数组中有一个对象（最早改变状态）<code>resolve</code>或<code>reject</code>时,就改变自身的状态,并执行相应的回调.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> timeout = <span class="function">(<span class="params">time</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve(time)</span><br><span class="line">        &#125;, time)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.time(<span class="string">'promise'</span>)</span><br><span class="line"><span class="built_in">Promise</span>.race([</span><br><span class="line">    timeout(<span class="number">10</span>),</span><br><span class="line">    timeout(<span class="number">60</span>),</span><br><span class="line">    timeout(<span class="number">100</span>)</span><br><span class="line">]).then(<span class="function">(<span class="params">values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(values); [<span class="number">10</span>, <span class="number">60</span>, <span class="number">100</span>]</span><br><span class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'promise'</span>);   <span class="comment">// promise: 11.330ms</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.race([timeout(<span class="number">10</span>), timeout(<span class="number">60</span>), <span class="built_in">Promise</span>.reject(<span class="string">'error'</span>)])</span><br><span class="line">.then(<span class="function">(<span class="params">values</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(values)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err) <span class="comment">// error</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>当数组中有非异步<code>Promise</code>对象或有数字、boolean、字符串、undefined、null、{a:1}、function(){}等非<code>Promise</code>对象时，都会直接以第一个值<code>resolve</code>,立即改变为<code>Fulfilled</code>状态</p><p>注意:</p><blockquote><p><code>promise</code>对象即使立马改变状态,它也是异步执行的</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">5</span>).then(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'test'</span>, value)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'先打出来'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先打出来</span></span><br><span class="line"><span class="comment">// 后打出来 5</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Promise&lt;/code&gt;对于每一个前端工程师来说都不陌生,在项目开发中的使用也是越来越频繁,各大主流浏览器厂商也是对它做了很好的支持. Promise的出现解决了回调地狱的问题, 同时多个异步任务同时执行可以节省时间.&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="JS" scheme="/tags/JS/"/>
    
      <category term="promise" scheme="/tags/promise/"/>
    
      <category term="ES6" scheme="/tags/ES6/"/>
    
  </entry>
  
  <entry>
    <title>React Native Modal组件 Android覆盖状态栏</title>
    <link href="/rn_modal/"/>
    <id>/rn_modal/</id>
    <published>2018-06-13T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.255Z</updated>
    
    <content type="html"><![CDATA[<p>在App开发中经常需要做模态框，我们第一时间就会想到 React Native 的 Modal 组件，确实Modal组件很方便。但也有一些不尽人意的地方，在安卓App开发的过程中发现，Modal不会覆盖状态栏，就会导致Modal的背景色和状态栏的颜色不一致，即使是设置了沉浸式状态栏，这样破坏了App的整体性和美观。</p><a id="more"></a><h3 id="Modal组件基本用法"><a href="#Modal组件基本用法" class="headerlink" title="Modal组件基本用法"></a>Modal组件基本用法</h3><blockquote><p>属性介绍</p></blockquote><ul><li>animationType: [‘none’, ‘slide’, ‘fade’] Modal展示和收起时的动画效果</li><li>onRequestClose: Platform.OS === ‘android’ ? PropTypes.func.isRequired : PropTypes.func 安卓物理返回回调，安卓必传</li><li>onShow: func Modal组件展开完成时调用</li><li>transparent: bool Modal背景色是否透明</li><li>visible: bool 控制Modal的展开与收起</li></ul><blockquote><p>基本用法</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModalDemo</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    state = &#123;<span class="attr">visible</span>: <span class="literal">false</span>&#125;</span><br><span class="line">    </span><br><span class="line">    close() &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;<span class="attr">visible</span>: <span class="literal">false</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;&#123;<span class="attr">flex</span>: <span class="number">1</span>&#125;&#125;&gt;</span><br><span class="line">                &lt;Modal</span><br><span class="line">                    animationType=<span class="string">'slide'</span></span><br><span class="line">                    transparent</span><br><span class="line">                    visible=&#123;<span class="keyword">this</span>.state.visible&#125;</span><br><span class="line">                    onRequestClose=&#123;() =&gt; &#123; <span class="keyword">this</span>.close() &#125;&#125;&gt;</span><br><span class="line"></span><br><span class="line">                    &lt;Text&gt;Modal Demo&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>Modal&gt;</span><br><span class="line">                &lt;TouchableOpacity onPress=&#123;()=&gt;&#123;<span class="keyword">this</span>.setState(&#123;<span class="attr">visible</span>: <span class="literal">true</span>&#125;)&#125;&#125;&gt;</span><br><span class="line">                    &lt;Text&gt;show&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>TouchableOpacity&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="简单实现Modal覆盖状态栏"><a href="#简单实现Modal覆盖状态栏" class="headerlink" title="简单实现Modal覆盖状态栏"></a>简单实现Modal覆盖状态栏</h3><p>其实实现很简单，在Modal组件外面包一层View，设置View绝对定位，宽高‘100%’，这样View会占据整个屏幕，再设置背景，Modal透明就可以了，这个View的渲染和Modal的visible属性用同一个state来控制即可。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.visible ?</span><br><span class="line">        &lt;View style=&#123;&#123;<span class="attr">position</span>: <span class="string">'absolute'</span>, <span class="attr">width</span>: <span class="string">'100%'</span>, <span class="attr">height</span>: <span class="string">'100%'</span>, <span class="attr">backgroundColor</span>: <span class="string">'rgba(0,0,0,0.5)'</span>&#125;&#125;&gt;</span><br><span class="line">            &lt;Modal</span><br><span class="line">                animationType=<span class="string">'slide'</span></span><br><span class="line">                transparent</span><br><span class="line">                visible=&#123;<span class="keyword">this</span>.state.visible&#125;</span><br><span class="line">                onRequestClose=&#123;() =&gt; &#123; <span class="keyword">this</span>.close() &#125;&#125;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;Text&gt;Modal Demo&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>Modal&gt;</span><br><span class="line">        &lt;<span class="regexp">/View&gt; : null</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>这样只是实现了覆盖状态栏，还需要对各个View层的点击事件作处理，以至于达到与原始Modal组件相同的效果。</p><h3 id="基于Modal封装覆盖状态栏的Modal"><a href="#基于Modal封装覆盖状态栏的Modal" class="headerlink" title="基于Modal封装覆盖状态栏的Modal"></a>基于Modal封装覆盖状态栏的Modal</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;TouchableOpacity activeOpacity=&#123;<span class="number">1</span>&#125; onPress=&#123;() =&gt; &#123;<span class="keyword">this</span>.close()&#125;&#125; style=&#123;&#123; <span class="attr">position</span>: <span class="string">'absolute'</span>,<span class="attr">width</span>: <span class="string">'100%'</span>,<span class="attr">zIndex</span>: <span class="number">999</span>,<span class="attr">height</span>: <span class="string">'100%'</span>,<span class="attr">backgroundColor</span>: <span class="string">'rgba(0, 0, 0, 0.5)'</span>&#125;&#125;&gt;</span><br><span class="line">    &lt;Modal</span><br><span class="line">        animationType=<span class="string">'slide'</span></span><br><span class="line">        transparent</span><br><span class="line">        visible=&#123;<span class="keyword">this</span>.state.visible&#125;</span><br><span class="line">        onRequestClose=&#123;() =&gt; &#123; <span class="keyword">this</span>.close() &#125;&#125;&gt;</span><br><span class="line">        &lt;TouchableOpacity onPress=&#123;() =&gt; &#123;<span class="keyword">this</span>.close()&#125;&#125; activeOpacity=&#123;<span class="number">1</span>&#125;&gt;</span><br><span class="line">            &lt;TouchableWithoutFeedback onPress=&#123;() =&gt; &#123;&#125;&#125;&gt;</span><br><span class="line">    &lt;Text&gt;内容&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>TouchableWithoutFeedback&gt;</span><br><span class="line">        &lt;<span class="regexp">/TouchableOpacity&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Modal&gt;</span><br><span class="line">&lt;<span class="regexp">/TouchableOpacity&gt;</span></span><br></pre></td></tr></table></figure><p>这是我在开发中使用的一种实现方式，原理简单，实现比较啰嗦。</p><p>当然也可以使用大神们的组件，也有大神从安卓底层做了封装</p><p>比如这个：<a href="https://blog.csdn.net/u014041033/article/details/79322866" target="_blank" rel="noopener">react native modal android实现全屏</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在App开发中经常需要做模态框，我们第一时间就会想到 React Native 的 Modal 组件，确实Modal组件很方便。但也有一些不尽人意的地方，在安卓App开发的过程中发现，Modal不会覆盖状态栏，就会导致Modal的背景色和状态栏的颜色不一致，即使是设置了沉浸式状态栏，这样破坏了App的整体性和美观。&lt;/p&gt;
    
    </summary>
    
      <category term="ReactNative" scheme="/categories/ReactNative/"/>
    
    
      <category term="react-native" scheme="/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>react-native开发常见问题</title>
    <link href="/rn_common_problem/"/>
    <id>/rn_common_problem/</id>
    <published>2018-06-11T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.256Z</updated>
    
    <content type="html"><![CDATA[<p>react-native开发中常见的问题汇总，以下是我最近在项目开发中遇到的常见的问题，做以下记录以便后续项目中使用。</p><a id="more"></a><h3 id="1-监听网状连接状态的变化"><a href="#1-监听网状连接状态的变化" class="headerlink" title="1. 监听网状连接状态的变化"></a>1. 监听网状连接状态的变化</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">componentDidMount () &#123;</span><br><span class="line">  NetInfo.addEventListener(<span class="string">'change'</span>, <span class="keyword">this</span>.handleConnectivityChange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillUnmount() &#123;</span><br><span class="line">  NetInfo.removeEventListener(<span class="string">'change'</span>, <span class="keyword">this</span>.handleConnectivityChange);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handleConnectivityChange() &#123;</span><br><span class="line">  NetInfo.isConnected.fetch().then(<span class="function"><span class="params">netConnected</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (netConnected) &#123;</span><br><span class="line">      ToastAndroid.show(<span class="string">'网络已连接'</span>, ToastAndroid.SHORT, ToastAndroid.BOTTOM)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ToastAndroid.show(<span class="string">'请检查网络连接'</span>, ToastAndroid.SHORT, ToastAndroid.BOTTOM)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-处理特殊页面的回退按钮和物理回退事件"><a href="#2-处理特殊页面的回退按钮和物理回退事件" class="headerlink" title="2. 处理特殊页面的回退按钮和物理回退事件"></a>2. 处理特殊页面的回退按钮和物理回退事件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// navigation 的 didFocus willBlur事件</span></span><br><span class="line"><span class="comment">// BackHandler 的 hardwareBackPress 事件</span></span><br><span class="line"><span class="comment">// this.props.navigation.replace(RouterName) 路由替换</span></span><br><span class="line"><span class="comment">// this.props.navigation.isFocused() 路由激活状态</span></span><br><span class="line"> _didFocusSubscription;</span><br><span class="line"> _willBlurSubscription;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">constructor</span> (props) &#123;</span><br><span class="line">   <span class="keyword">super</span>(props)</span><br><span class="line">     <span class="keyword">this</span>._didFocusSubscription = props.navigation.addListener(<span class="string">'didFocus'</span>, payload =&gt;</span><br><span class="line">     BackHandler.addEventListener(<span class="string">'hardwareBackPress'</span>, <span class="keyword">this</span>.onBackButtonPressAndroid))</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> componentDidMount () &#123;</span><br><span class="line">     <span class="keyword">this</span>._willBlurSubscription = <span class="keyword">this</span>.props.navigation.addListener(<span class="string">'willBlur'</span>, payload =&gt; &#123;</span><br><span class="line">     BackHandler.removeEventListener(<span class="string">'hardwareBackPress'</span>, <span class="keyword">this</span>.onBackButtonPressAndroid)</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> componentWillUnmount () &#123;</span><br><span class="line">   <span class="keyword">this</span>._didFocusSubscription &amp;&amp; <span class="keyword">this</span>._didFocusSubscription.remove()</span><br><span class="line">   <span class="keyword">this</span>._willBlurSubscription &amp;&amp; <span class="keyword">this</span>._willBlurSubscription.remove()</span><br><span class="line">   BackHandler.removeEventListener(<span class="string">'hardwareBackPress'</span>, <span class="keyword">this</span>.onBackButtonPressAndroid)</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> onBackButtonPressAndroid = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.toRouterName) &#123;</span><br><span class="line">     <span class="keyword">this</span>.props.navigation.replace(<span class="keyword">this</span>.toRouterName)</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure><h3 id="3-createStackNavigator-createBottomTabNavigator-路由嵌套-StackNavigator的跳转问题"><a href="#3-createStackNavigator-createBottomTabNavigator-路由嵌套-StackNavigator的跳转问题" class="headerlink" title="3. createStackNavigator, createBottomTabNavigator 路由嵌套 StackNavigator的跳转问题"></a>3. createStackNavigator, createBottomTabNavigator 路由嵌套 StackNavigator的跳转问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要给TabNavigator 重新传navigation属性 重新定义TabNavigator容器组件的router为TabNavigator的router</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainView</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> navigationOptions = &#123;</span><br><span class="line">    header: <span class="literal">null</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; isMask &#125; = <span class="keyword">this</span>.props.global</span><br><span class="line">    <span class="keyword">const</span> &#123; cartCount &#125; = <span class="keyword">this</span>.props</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View&gt;</span><br><span class="line">        &lt;AppTabNavigator navigation=&#123;<span class="keyword">this</span>.props.navigation&#125;/&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">MainView.router = AppTabNavigator.router</span></span><br></pre></td></tr></table></figure><h3 id="4-tabBarOnPress-拦截tab导航的tab点击事件"><a href="#4-tabBarOnPress-拦截tab导航的tab点击事件" class="headerlink" title="4. tabBarOnPress 拦截tab导航的tab点击事件"></a>4. tabBarOnPress 拦截tab导航的tab点击事件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> navigationOptions: <span class="function">(<span class="params">&#123;navigation, screenProps&#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  title: <span class="string">'我的'</span>,</span><br><span class="line">  tabBarIcon: <span class="function">(<span class="params">&#123;focused&#125;</span>) =&gt;</span> (</span><br><span class="line">    &lt;Image</span><br><span class="line">      source=&#123;focused ? <span class="built_in">require</span>(<span class="string">'../images/ic_mine_checked.png'</span>) : <span class="built_in">require</span>(<span class="string">'../images/ic_mine.png'</span>)&#125;</span><br><span class="line">      style=&#123;styles.tabIcon&#125;</span><br><span class="line">    /&gt;</span><br><span class="line">  ),</span><br><span class="line">  tabBarOnPress: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!screenProps.netConnected) &#123;</span><br><span class="line">      navigation.navigate(<span class="string">'Home'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="5-解决锁定屏幕方向-还有键盘顶起tab导航等问题"><a href="#5-解决锁定屏幕方向-还有键盘顶起tab导航等问题" class="headerlink" title="5. 解决锁定屏幕方向 还有键盘顶起tab导航等问题"></a>5. 解决锁定屏幕方向 还有键盘顶起tab导航等问题</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name=<span class="string">".MainActivity"</span></span><br><span class="line">    android:label=<span class="string">"@string/app_name"</span></span><br><span class="line">    android:configChanges=<span class="string">"keyboard|keyboardHidden|orientation|screenSize"</span>&gt;</span><br><span class="line">    </span><br><span class="line">    添加一行：android:screenOrientation=<span class="string">"portrait"</span></span><br><span class="line">    设置为portrait是锁定竖向，landscape是锁定横向</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">// screenProps  tab导航中动态渲染数据 对象中的值可以绑定redux中的值</span></span><br><span class="line">&lt;AppTabNavigator screenProps=&#123;&#123;<span class="attr">cartCount</span>: cartCount&#125;&#125; navigation=&#123;<span class="keyword">this</span>.props.navigation&#125;/&gt;</span><br></pre></td></tr></table></figure><h3 id="6-监听路由事件，可以用来做双击物理回退按钮退出App等其他功能"><a href="#6-监听路由事件，可以用来做双击物理回退按钮退出App等其他功能" class="headerlink" title="6. 监听路由事件，可以用来做双击物理回退按钮退出App等其他功能"></a>6. 监听路由事件，可以用来做双击物理回退按钮退出App等其他功能</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStackNavigator, NavigationActions &#125; <span class="keyword">from</span> <span class="string">'react-navigation'</span></span><br><span class="line"><span class="keyword">import</span> &#123; ToastAndroid, BackHandler &#125; <span class="keyword">from</span> <span class="string">'react-native'</span></span><br><span class="line"><span class="keyword">const</span> AppNavigator = createStackNavigator(routes, stackConfig)<span class="keyword">const</span> defaultStateAction = AppNavigator.router.getStateForAction</span><br><span class="line"><span class="keyword">let</span> lastBackPressed = <span class="number">0</span></span><br><span class="line">AppNavigator.router.getStateForAction = <span class="function">(<span class="params">action, state</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> backRouteName = state &amp;&amp; state.routes[state.routes.length - <span class="number">1</span>].routeName</span><br><span class="line">  <span class="keyword">if</span> (state &amp;&amp; (action.type === NavigationActions.BACK) &amp;&amp; (backRouteName === <span class="string">'MainView'</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((lastBackPressed + <span class="number">2000</span>) &lt; <span class="built_in">Date</span>.now()) &#123;</span><br><span class="line">      ToastAndroid.show(<span class="string">'再按一次退出'</span>, ToastAndroid.SHORT)</span><br><span class="line">      lastBackPressed = <span class="built_in">Date</span>.now()</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    BackHandler.exitApp()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> defaultStateAction(action, state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-解决-isMounted-…-is-deprecated-warning"><a href="#7-解决-isMounted-…-is-deprecated-warning" class="headerlink" title="7. 解决 isMounted(…) is deprecated warning"></a>7. 解决 isMounted(…) is deprecated warning</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; YellowBox &#125; <span class="keyword">from</span> <span class="string">'react-native'</span></span><br><span class="line">YellowBox.ignoreWarnings([<span class="string">'Warning: isMounted(...) is deprecated'</span>, <span class="string">'Module RCTImageLoader'</span>])</span><br></pre></td></tr></table></figure><h3 id="8-合理使用-componentWillReceiveProps，-shouldComponentUpdate"><a href="#8-合理使用-componentWillReceiveProps，-shouldComponentUpdate" class="headerlink" title="8. 合理使用 componentWillReceiveProps， shouldComponentUpdate"></a>8. 合理使用 componentWillReceiveProps， shouldComponentUpdate</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">componentWillReceiveProps (nextProps) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!nextProps.xxx) &#123;</span><br><span class="line">    dosomething</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> shouldComponentUpdate (newProps, newState) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.props.navigation.isFocused()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span> <span class="comment">// render</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// not render</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-工具类logger-和-创建store"><a href="#9-工具类logger-和-创建store" class="headerlink" title="9. 工具类logger 和 创建store"></a>9. 工具类logger 和 创建store</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware, compose &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> screenTracking <span class="keyword">from</span> <span class="string">'./screenTrackingMiddleware'</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'../reducers'</span></span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'redux-logger'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middlewares = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">  middlewares.push(logger)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">middlewares.push(screenTracking)</span><br><span class="line"><span class="keyword">const</span> store = compose(applyMiddleware(...middlewares))(createStore)(reducer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br></pre></td></tr></table></figure><h3 id="10-比较好用的第三方组件"><a href="#10-比较好用的第三方组件" class="headerlink" title="10. 比较好用的第三方组件"></a>10. 比较好用的第三方组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">react-native-swiper swiper组件</span><br><span class="line">react-native-linear-gradient        渐变组件</span><br><span class="line">react-native-swipe-list-view侧滑组件</span><br><span class="line">react-native-image-crop-picker   图片裁剪、调用相机和手机相册</span><br><span class="line">react-native-cookies管理Cookie</span><br></pre></td></tr></table></figure><h3 id="11-ScrollView-组件监听滚动到底部"><a href="#11-ScrollView-组件监听滚动到底部" class="headerlink" title="11. ScrollView 组件监听滚动到底部"></a>11. ScrollView 组件监听滚动到底部</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_contentViewScroll (e) &#123;</span><br><span class="line">  <span class="keyword">let</span> offsetY = e.nativeEvent.contentOffset.y <span class="comment">// 滑动距离</span></span><br><span class="line">  <span class="keyword">let</span> contentSizeHeight = e.nativeEvent.contentSize.height <span class="comment">// scrollView contentSize高度</span></span><br><span class="line">  <span class="keyword">let</span> oriageScrollHeight = e.nativeEvent.layoutMeasurement.height <span class="comment">// scrollView高度</span></span><br><span class="line">  <span class="keyword">if</span> (offsetY + oriageScrollHeight &gt;= contentSizeHeight) &#123;</span><br><span class="line">  <span class="comment">// do something  </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;ScrollView </span><br><span class="line">      onMomentumScrollEnd=&#123;<span class="keyword">this</span>._contentViewScroll.bind(<span class="keyword">this</span>)&#125;</span><br><span class="line">      showsVerticalScrollIndicator=&#123;<span class="literal">false</span>&#125;&gt; </span><br><span class="line">&lt;<span class="regexp">/ScrollView&gt;</span></span><br></pre></td></tr></table></figure><h3 id="12-Image-使图片按宽度或者高度自适应"><a href="#12-Image-使图片按宽度或者高度自适应" class="headerlink" title="12. Image 使图片按宽度或者高度自适应"></a>12. Image 使图片按宽度或者高度自适应</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageAdaptive</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    width: <span class="number">0</span>,</span><br><span class="line">    height: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount () &#123;</span><br><span class="line">    Image.getSize(<span class="keyword">this</span>.props.uri, (width, height) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> h = <span class="number">330</span> * height / width</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;<span class="attr">height</span>: h&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Image source=&#123;&#123;<span class="attr">uri</span>: <span class="keyword">this</span>.props.uri&#125;&#125; style=&#123;[&#123;<span class="attr">width</span>: D(<span class="number">330</span>), <span class="attr">height</span>: D(<span class="keyword">this</span>.state.height)&#125;, <span class="keyword">this</span>.props.style]&#125; /&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-根据Swiper组件改装的图片预览组件"><a href="#13-根据Swiper组件改装的图片预览组件" class="headerlink" title="13. 根据Swiper组件改装的图片预览组件"></a>13. 根据Swiper组件改装的图片预览组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;Swiper</span><br><span class="line">  loop=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">  index=&#123;initialSlide&#125;</span><br><span class="line">  renderPagination=&#123;(index, total) =&gt; (</span><br><span class="line">    &lt;View style=&#123;styles.paginationStyle&#125;&gt;</span><br><span class="line">      &lt;Text style=&#123;styles.paginationText&#125;&gt;&#123;index + <span class="number">1</span>&#125;/&#123;total&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">      &#123;</span></span><br><span class="line"><span class="regexp">        delImage</span></span><br><span class="line"><span class="regexp">          ? &lt;TouchableOpacity onPress=&#123;() =&gt; &#123; delImage &amp;&amp; delImage(index) &#125;&#125; style=&#123;styles.del&#125;&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Image source=&#123;require('../</span>../images/personal/ic_preview_delete.png<span class="string">')&#125; style=&#123;styles.imageDel&#125; /&gt;</span></span><br><span class="line"><span class="string">          &lt;/TouchableOpacity&gt; : null</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &lt;/View&gt;</span></span><br><span class="line"><span class="string">  )&#125;&gt;</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    images &amp;&amp; images.map((image, index) =&gt; (</span></span><br><span class="line"><span class="string">      &lt;TouchableOpacity style=&#123;styles.imagesItemWrapper&#125; key=&#123;index&#125; activeOpacity=&#123;1&#125; onPress=&#123;this.closeModal&#125;&gt;</span></span><br><span class="line"><span class="string">        &lt;Image resizeMode='</span>contain<span class="string">' style=&#123;styles.imagesItem&#125; source=&#123;&#123; uri: image &#125;&#125; /&gt;</span></span><br><span class="line"><span class="string">      &lt;/TouchableOpacity&gt;</span></span><br><span class="line"><span class="string">    ))</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&lt;/Swiper&gt;</span></span><br></pre></td></tr></table></figure><h3 id="14-StatusBar-currentHeight-可以从纯前端的角度兼容刘海屏沉浸式状态栏"><a href="#14-StatusBar-currentHeight-可以从纯前端的角度兼容刘海屏沉浸式状态栏" class="headerlink" title="14. StatusBar.currentHeight 可以从纯前端的角度兼容刘海屏沉浸式状态栏"></a>14. StatusBar.currentHeight 可以从纯前端的角度兼容刘海屏沉浸式状态栏</h3>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;react-native开发中常见的问题汇总，以下是我最近在项目开发中遇到的常见的问题，做以下记录以便后续项目中使用。&lt;/p&gt;
    
    </summary>
    
      <category term="ReactNative" scheme="/categories/ReactNative/"/>
    
    
      <category term="react-native" scheme="/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>react-native android状态栏</title>
    <link href="/rn_statusbar/"/>
    <id>/rn_statusbar/</id>
    <published>2018-06-11T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.255Z</updated>
    
    <content type="html"><![CDATA[<p>react-native 开发App的时候难免会遇到状态栏的背景颜色和字体颜色与App内容页面色调适配，间言之就是将状态栏颜色与App颜色一致，使用户界面更加整体。</p><a id="more"></a><h2 id="react-native-android状态栏"><a href="#react-native-android状态栏" class="headerlink" title="react-native android状态栏"></a>react-native android状态栏</h2><h3 id="1-android设备系统元素"><a href="#1-android设备系统元素" class="headerlink" title="1.android设备系统元素"></a>1.android设备系统元素</h3><ul><li>导航栏：就是设备顶部的网络、时间、电量等信息栏</li><li>ActionBar: 返回按钮以及系统默认的header区域，RN开发中一般不会用到，RN中在navigation中进行定制 </li><li>导航栏: 设备下方的物理返回、回桌面、选择应用程序等系统导航栏</li></ul><h3 id="2-状态栏的呈现形式"><a href="#2-状态栏的呈现形式" class="headerlink" title="2.状态栏的呈现形式"></a>2.状态栏的呈现形式</h3><ul><li>默认展示，一直显示手机系统的状态栏</li><li>透明状态栏，状态栏背景颜色透明，状态栏颜色与App颜色一致，用户界面更加整体。</li><li>隐藏状态栏(沉浸式)，状态栏完全隐藏，类似于全屏游戏、视频播放器的效果</li></ul><h4 id="2-1-默认展示"><a href="#2-1-默认展示" class="headerlink" title="2.1 默认展示"></a>2.1 默认展示</h4><p>系统默认状态栏样式，无法改变</p><h4 id="2-2-透明状态栏"><a href="#2-2-透明状态栏" class="headerlink" title="2.2 透明状态栏"></a>2.2 透明状态栏</h4><p>透明状态栏很常见，大多数的App都是使用这种模式，使得状态栏颜色与App颜色一致，使用户界面更加整体，整个应用看起来更加美观。</p><p>实现透明的状态栏的方式很多：</p><blockquote><p>一、使用App的主题进行配置,在app/main/res/values/styles.xml中设置主题</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;resources&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Base application theme. --&gt;</span><br><span class="line">    &lt;style name=<span class="string">"AppTheme"</span> parent=<span class="string">"Theme.AppCompat.Light.NoActionBar"</span>&gt;</span><br><span class="line">        &lt;item name=<span class="string">"android:windowTranslucentStatus"</span>&gt;<span class="literal">true</span>&lt;<span class="regexp">/item&gt; /</span><span class="regexp">/ 设置状态栏不占据空间</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ &lt;item name="android:windowLightStatusBar"&gt;true&lt;/i</span>tem&gt; <span class="comment">// 设置状态栏字体颜色</span></span><br><span class="line">    &lt;<span class="regexp">/style&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>resources&gt;</span><br></pre></td></tr></table></figure><p>这种方式支持api19, 即Android4.4及以上，会在App启动的时候就生效, 在App启动时有权限确认、系统弹窗等也不受影响，在弹出modal之类的深色蒙层时状态栏字体会变成成浅色</p><p>只设置<code>&lt;item name=&quot;android:windowTranslucentStatus&quot;&gt;true&lt;/item&gt;</code>这种方式设置的透明状态栏，状态栏字体默认白色，无法再动态通过StatusBar改变状态栏的背景颜色,在做需要改变状态栏背景颜色的时候就比较尴尬了</p><p>再加一个<code>&lt;item name=&quot;android:windowLightStatusBar&quot;&gt;true&lt;/item&gt;</code>这样设置状态栏字体颜色之后，在深色modal弹出的时候字体不会动态改变成白色，但可以通过StatusBar设置barStyle来改变，实际上也不是很方便</p><blockquote><p>二、android原生设置,在MainActivity的onCreate中进行设置</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected <span class="keyword">void</span> onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">// 设置透明状态栏</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">        View decorView = getWindow().getDecorView();</span><br><span class="line">        int option = View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">                | View.SYSTEM_UI_FLAG_LAYOUT_STABLE;</span><br><span class="line">        decorView.setSystemUiVisibility(option);</span><br><span class="line">        getWindow().setStatusBarColor(Color.TRANSPARENT);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置透明状态栏和透明导航栏</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">21</span>) &#123;</span><br><span class="line">true    View decorView = getWindow().getDecorView();</span><br><span class="line">true    int option = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION</span><br><span class="line">true            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</span><br><span class="line">true            | View.SYSTEM_UI_FLAG_LAYOUT_STABLE;</span><br><span class="line">true    decorView.setSystemUiVisibility(option);</span><br><span class="line">true    getWindow().setNavigationBarColor(Color.TRANSPARENT);</span><br><span class="line">true    getWindow().setStatusBarColor(Color.TRANSPARENT);</span><br><span class="line">true&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>透明式状态栏，只有5.0及以上系统才支持，因此这里先进行了一层if判断，只有系统版本大于或等于5.0的时候才会执行下面的代码。<br>接下来我们使用了<code>SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN</code>和<code>SYSTEM_UI_FLAG_LAYOUT_STABLE</code>，注意两个Flag必须要结合在一起使用，表示会让应用的主体内容占用系统状态栏的空间，也就是说状态栏不再占据空间。最后再调用Window的setStatusBarColor()方法将状态栏设置成透明色就可以了。</p><blockquote><p>三、使用RN的StatusBar来设置，在App首次加载的页面中对状态栏进行设置</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;StatusBar backgroundColor=<span class="string">'transparent'</span> translucent barStyle=&#123;<span class="string">'dark-content'</span>&#125; /&gt;</span><br></pre></td></tr></table></figure><p>这种方式，会在App刚启动的时候和App启动时有权限确认、系统弹窗等会先试用系统的默认状态栏，加载App页面之后再改变成上面设置的样式。<br>好处在于可以动态进行设置状态栏的样式。</p><p>StatusBar属性简介：</p><ul><li>animated: bool 指定状态栏的变化是否应以动画形式呈现。目前支持这几种样式：backgroundColor, barStyle和hidden</li><li>hidden: bool 是否隐藏状态栏。</li><li>backgroundColor: 状态栏的背景色。</li><li>translucent: bool 指定状态栏是否透明。设置为true时，应用会在状态栏之下绘制（即所谓“沉浸式”——被状态栏遮住一部分）。常和带有半透明背景色的状态栏搭配使用。</li><li>barStyle: enum(‘default’, ‘light-content’, ‘dark-content’) 设置状态栏文本的颜色。</li></ul><p>以上几种方式都会有一个问题，状态栏不再占据空间，因此在页面布局的时候需要加 paddingTop 值为状态栏的高度。</p><p>纯前端就可以实现，这也是适配目前主流刘海屏的一种方式，利用StatusBar.currentHeight可以获取到设备状态栏的高度。</p><h4 id="2-3-隐藏-状态栏-和-导航栏"><a href="#2-3-隐藏-状态栏-和-导航栏" class="headerlink" title="2.3 隐藏 状态栏 和 导航栏"></a>2.3 隐藏 状态栏 和 导航栏</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">setContentView(R.layout.activity_main);</span><br><span class="line">View decorView = getWindow().getDecorView();</span><br><span class="line">int option = View.SYSTEM_UI_FLAG_HIDE_NAVIGATION | View.SYSTEM_UI_FLAG_FULLSCREEN;</span><br><span class="line">decorView.setSystemUiVisibility(option);</span><br><span class="line">ActionBar actionBar = getSupportActionBar();</span><br><span class="line">actionBar.hide();</span><br></pre></td></tr></table></figure><h3 id="3-浅色状态栏的兼容性配置"><a href="#3-浅色状态栏的兼容性配置" class="headerlink" title="3. 浅色状态栏的兼容性配置"></a>3. 浅色状态栏的兼容性配置</h3><p>目前市面上的浅色状态栏基本都是 白底黑字, 支持这种设置的有Android6.0及其以上; MIUI v6及以上, Flyme 4.0及以上</p><p>具体兼容方案如下：</p><blockquote><p>Flyme 4.0及以上</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="keyword">static</span> boolean FlymeSetStatusBarLightMode(Window <span class="built_in">window</span>, boolean dark) &#123;</span><br><span class="line">    boolean result = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WindowManager.LayoutParams lp = <span class="built_in">window</span>.getAttributes();</span><br><span class="line">            Field darkFlag = WindowManager.LayoutParams.class</span><br><span class="line">                    .getDeclaredField(<span class="string">"MEIZU_FLAG_DARK_STATUS_BAR_ICON"</span>);</span><br><span class="line">            Field meizuFlags = WindowManager.LayoutParams.class</span><br><span class="line">                    .getDeclaredField(<span class="string">"meizuFlags"</span>);</span><br><span class="line">            darkFlag.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            meizuFlags.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            int bit = darkFlag.getInt(<span class="literal">null</span>);</span><br><span class="line">            int value = meizuFlags.getInt(lp);</span><br><span class="line">            <span class="keyword">if</span> (dark) &#123;</span><br><span class="line">                value |= bit;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value &amp;= ~bit;</span><br><span class="line">            &#125;</span><br><span class="line">            meizuFlags.setInt(lp, value);</span><br><span class="line">            <span class="built_in">window</span>.setAttributes(lp);</span><br><span class="line">            result = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Android6.0及以上</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> public <span class="keyword">static</span> <span class="keyword">void</span> setAndroidNativeLightStatusBar(Activity activity, boolean dark) &#123;</span><br><span class="line">    <span class="comment">//状态栏字体图标颜色</span></span><br><span class="line">    View decor = activity.getWindow().getDecorView();</span><br><span class="line">    <span class="keyword">if</span> (dark) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            decor.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR <span class="comment">//浅色状态栏(字体图标白色)</span></span><br><span class="line">                    | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN <span class="comment">//contentView 全屏(置于statusbar之下)</span></span><br><span class="line">                    | View.SYSTEM_UI_FLAG_LAYOUT_STABLE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        decor.setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>MIUI v6及以上</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> boolean MIUISetStatusBarLightMode(Activity activity, boolean dark) &#123;</span><br><span class="line">    <span class="keyword">if</span>(Build.VERSION.SDK_INT &gt;= <span class="number">24</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean result = <span class="literal">false</span>;</span><br><span class="line">    Window <span class="built_in">window</span>=activity.getWindow();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        Class clazz = <span class="built_in">window</span>.getClass();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            int darkModeFlag = <span class="number">0</span>;</span><br><span class="line">            Class layoutParams = Class.forName(<span class="string">"android.view.MiuiWindowManager$LayoutParams"</span>);</span><br><span class="line">            Field field = layoutParams.getField(<span class="string">"EXTRA_FLAG_STATUS_BAR_DARK_MODE"</span>);</span><br><span class="line">            darkModeFlag = field.getInt(layoutParams);</span><br><span class="line">            Method extraFlagField = clazz.getMethod(<span class="string">"setExtraFlags"</span>, int.class, int.class);</span><br><span class="line">            <span class="keyword">if</span>(dark)&#123;</span><br><span class="line">                extraFlagField.invoke(<span class="built_in">window</span>,darkModeFlag,darkModeFlag);<span class="comment">//状态栏透明且黑色字体</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                extraFlagField.invoke(<span class="built_in">window</span>, <span class="number">0</span>, darkModeFlag);<span class="comment">//清除黑色字体</span></span><br><span class="line">            &#125;</span><br><span class="line">            result=<span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">                <span class="comment">//开发版 7.7.13 及以后版本采用了系统API，旧方法无效但不会报错，所以两个方式都要加上</span></span><br><span class="line">                <span class="keyword">if</span>(dark)&#123;</span><br><span class="line">                    activity.getWindow().getDecorView().setSystemUiVisibility( View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN| View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    activity.getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_VISIBLE);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在MainActivity的onCreate中调用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LightStatusBarUtil.FlymeSetStatusBarLightMode(<span class="keyword">this</span>.getWindow(), <span class="literal">false</span>);</span><br><span class="line">LightStatusBarUtil.MIUISetStatusBarLightMode(<span class="keyword">this</span>, <span class="literal">false</span>);   </span><br><span class="line">LightStatusBarUtil.setAndroidNativeLightStatusBar(<span class="keyword">this</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>实现透明状态栏，以上方案都没有完全兼容android 4.4以下版本，个人觉得比较合适的做法是 android设置透明状态栏 + 浅色状态栏的兼容性配置 + StatusBar 来配合控制</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;react-native 开发App的时候难免会遇到状态栏的背景颜色和字体颜色与App内容页面色调适配，间言之就是将状态栏颜色与App颜色一致，使用户界面更加整体。&lt;/p&gt;
    
    </summary>
    
      <category term="ReactNative" scheme="/categories/ReactNative/"/>
    
    
      <category term="react-native" scheme="/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>类数组转化成数组</title>
    <link href="/js_list_to_array/"/>
    <id>/js_list_to_array/</id>
    <published>2017-08-19T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.251Z</updated>
    
    <content type="html"><![CDATA[<p>类数组是很常见的一种数据结构, 它与数组的结构非常相似, 同时有着数组的很多特性, 很多时候会想着按数组的处理方式来使用他们, 但是我们都知道数组的方法都是封装在 <code>Array.prototype</code> 上的, 所以类数组是无法直接使用数组原型上的方法的, 要达到这样的目的, 就需要将类数组转化成数组.</p><p>常见的类数组有: <code>arguments</code>、<code>HTMLCollection</code> 的实例、<code>NodeList</code>的实例…</p><a id="more"></a><p>类数组虽然结构特点无限接近数组,但是并不是 <code>Array</code>的实例,所以也是无法调取数组原型上的那些方法的,想要调取的话有以下三种方案：</p><h3 id="1-把类数组转化为数组"><a href="#1-把类数组转化为数组" class="headerlink" title="1. 把类数组转化为数组"></a>1. 把类数组转化为数组</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listToArray</span>(<span class="params">likeAry</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ary = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = likeAry.length; i &lt; len; i++) &#123;</span><br><span class="line">        ary[ary.length] = likeAry[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过这种方式将类数组移植成数组的实例, 就可以愉快使用数组的各种方法了</p><h3 id="2-直接借用数组原型上的方法-call-apply"><a href="#2-直接借用数组原型上的方法-call-apply" class="headerlink" title="2. 直接借用数组原型上的方法(call/apply)"></a>2. 直接借用数组原型上的方法(call/apply)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>);</span><br><span class="line">    <span class="comment">//arguments.slice(); // Uncaught TypeError: arguments.slice is not a function</span></span><br><span class="line">    <span class="built_in">console</span>.log([].slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">    <span class="built_in">console</span>.log([].slice.apply(<span class="built_in">arguments</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">Array</span>.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>));</span><br><span class="line">&#125;</span><br><span class="line">fn(<span class="number">12</span>, <span class="number">23</span>, <span class="number">34</span>);</span><br></pre></td></tr></table></figure><p>利用 <code>call/apply</code> 借用数组原型上的方法也可以达到同样的效果</p><p><strong>注意</strong>: <code>IE8</code> 及以下浏览器中，DOM对象组成的类数组通过call调用slice方法没有遵循标准行为, 因此DOM元素组成的类数组无法直接通过借用slice方法转换成数组</p><p>以上两种可以做个兼容处理, 合成一种兼容比较好的函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listToArray</span>(<span class="params">likeAry</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ary = [];</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ary = <span class="built_in">Array</span>.prototype.slice.call(likeAry);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = likeAry.length; i &lt; len; i++) &#123;</span><br><span class="line">            ary[ary.length] = likeAry[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-使用中间继承改变原型指向"><a href="#3-使用中间继承改变原型指向" class="headerlink" title="3. 使用中间继承改变原型指向"></a>3. 使用中间继承改变原型指向</h3><p>从其它角度理解, 为什么arguments不能直接调取数组的方法: 一个真正的数组的<code>__proto__</code> 指向的是 <code>Array.prototype</code>, 所以可以调取这里的方法, 而<code>arguments.__proto__ === Object.prototype</code>, 所以只能调取对象基类原型上的方法</p><p>那么可以通过这一特性强行改变类数组实例的 <code>__proto__</code> 的指向, 使其指向数组的原型</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">arguments</span>.__proto__ = <span class="built_in">Array</span>.prototype;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">arguments</span>.reverse());</span><br><span class="line">&#125;</span><br><span class="line">fn(<span class="number">12</span>, <span class="number">23</span>, <span class="number">34</span>);</span><br></pre></td></tr></table></figure><p><strong>注意</strong>: 在IE浏览器中,为了防止用户恶意修改内置对象的原型指向,是禁止使用<strong>proto</strong>这个属性的, 所以这只能算是一种 <strong>奇技淫巧</strong>, 了解就好<br>但是在移动端开发中,不需要考虑IE,使用这种方式还是非常方便的</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;类数组是很常见的一种数据结构, 它与数组的结构非常相似, 同时有着数组的很多特性, 很多时候会想着按数组的处理方式来使用他们, 但是我们都知道数组的方法都是封装在 &lt;code&gt;Array.prototype&lt;/code&gt; 上的, 所以类数组是无法直接使用数组原型上的方法的, 要达到这样的目的, 就需要将类数组转化成数组.&lt;/p&gt;
&lt;p&gt;常见的类数组有: &lt;code&gt;arguments&lt;/code&gt;、&lt;code&gt;HTMLCollection&lt;/code&gt; 的实例、&lt;code&gt;NodeList&lt;/code&gt;的实例…&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="JS" scheme="/tags/JS/"/>
    
      <category term="类数组" scheme="/tags/%E7%B1%BB%E6%95%B0%E7%BB%84/"/>
    
  </entry>
  
  <entry>
    <title>DOM映射、回流和重绘</title>
    <link href="/js_dom_mapping_backflow/"/>
    <id>/js_dom_mapping_backflow/</id>
    <published>2017-08-17T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.249Z</updated>
    
    <content type="html"><![CDATA[<p><strong>DOM映射</strong>: 通过DOM方法获取的一个元素集合(类数组),这个集合仍然和页面的元素保持着联系,并且这个元素集合会随着页面元素的增加而增加,减少而减少,即使把这个数组转为一个数组,每个元素仍然和页面有联系,这就叫做”DOM映射”</p><p><strong>回流</strong>: 网页内的元素的增加和删除，元素的位置的改变都会引起我们的DOM回流</p><p><strong>重绘</strong>: 元素样式发生改变,就会把当前这个元素重新渲染一遍,进行重绘</p><a id="more"></a><h3 id="1-DOM映射"><a href="#1-DOM映射" class="headerlink" title="1. DOM映射"></a>1. DOM映射</h3><p><strong>DOM映射</strong>: 通过DOM方法获取的一个元素集合(类数组), 这个集合仍然和页面的元素保持着联系, 并且这个元素集合会随着页面元素的增加而增加, 减少而减少, 即使把这个数组转为一个数组, 每个元素仍然和页面有联系,这就叫做”DOM映射”</p><p>更通俗的讲就是, 页面中的标签和js中获取到的元素对象或者元素集合是紧紧的绑定在一起的页面中html结构改变了, js中不需要重新获取, 集合里面的内容也会跟着自动改变</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>189<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>18<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>28<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> list = <span class="built_in">document</span>.getElementById(<span class="string">"list"</span>);</span><br><span class="line"><span class="comment">//  js获取到的元素集合</span></span><br><span class="line"><span class="keyword">var</span> olis = list.getElementsByTagName(<span class="string">"li"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(olis.length); <span class="comment">// 4</span></span><br><span class="line"><span class="keyword">var</span> li = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">list.appendChild(li);</span><br><span class="line"><span class="comment">// 增加一个li后,元素集合自动改变,不需要重新获取</span></span><br><span class="line"><span class="built_in">console</span>.log(olis.length); <span class="comment">// 5</span></span><br><span class="line"><span class="comment">//需要注意的是,如果将集合变成数组,这个将失效,如这里将 olis = Array.prototype.slice.call(olis);这样的话,后面的就还是4</span></span><br></pre></td></tr></table></figure><h3 id="2-回流与重绘"><a href="#2-回流与重绘" class="headerlink" title="2. 回流与重绘"></a>2. 回流与重绘</h3><p>当render tree中的一部分(或全部)因为元素的规模尺寸，布局，隐藏等改变而需要重新构建。这就称为回流(reflow)。每个页面至少需要一次回流，就是在页面第一次加载的时候。在回流的时候，浏览器会使渲染树中受到影响的部分失效，并重新构造这部分渲染树，完成回流后，浏览器会重新绘制受影响的部分到屏幕中，该过程成为重绘。</p><p>当render tree中的一些元素需要更新属性，而这些属性只是影响元素的外观，风格，而不会影响布局的，比如background-color。则就叫称为重绘。</p><p><strong>回流必将引起重绘，而重绘不一定会引起回流。</strong></p><p><strong>回流何时发生：</strong><br>当页面布局和几何属性改变时就需要回流。下述情况会发生浏览器回流：</p><ol><li>添加或者删除可见的DOM元素；</li><li>元素位置改变；</li><li>元素尺寸改变——边距、填充、边框、宽度和高度</li><li>内容改变——比如文本改变或者图片大小改变而引起的计算值宽度和高度改变；</li><li>页面渲染初始化；</li><li>浏览器窗口尺寸改变——resize事件发生时；</li></ol><p><strong>如何减少回流、重绘</strong></p><ol><li>直接改变className，如果动态改变样式，则使用cssText（考虑没有优化的浏览器）</li><li>让要操作的元素进行”离线处理”,处理完后一起更新<ul><li>使用DocumentFragment进行缓存操作,引发一次回流和重绘；</li><li>使用display:none技术，只引发两次回流和重绘；</li><li>使用cloneNode(true or false) 和 replaceChild 技术，引发一次回流和重绘；</li></ul></li><li>不要经常访问会引起浏览器flush队列的属性，如果你确实要访问，利用缓存</li><li>让元素脱离动画流，减少回流的Render Tree的规模</li></ol><h3 id="3-几种动态改变DOM结构的方式"><a href="#3-几种动态改变DOM结构的方式" class="headerlink" title="3. 几种动态改变DOM结构的方式"></a>3. 几种动态改变DOM结构的方式</h3><h4 id="3-1-利用动态创建元素节点和把它追加到页面中的方式实现数据绑定"><a href="#3-1-利用动态创建元素节点和把它追加到页面中的方式实现数据绑定" class="headerlink" title="3.1 利用动态创建元素节点和把它追加到页面中的方式实现数据绑定"></a>3.1 利用动态创建元素节点和把它追加到页面中的方式实现数据绑定</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ary.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> cur = ary[i];</span><br><span class="line">    <span class="keyword">var</span> oLi = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">    oLi.innerHTML = <span class="string">"&lt;span&gt;"</span> + (i + <span class="number">4</span>) + <span class="string">"&lt;/span&gt;"</span> + cur.title;</span><br><span class="line">    oUl.appendChild(oLi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>优势</strong>：把需要动态绑定的内容一个个的追加到页面中,对原来的元素没有任何的影响<br><strong>弊端</strong>：每当创建一个li,我们就添加到页面中,引发一次DOM的回流,最后引发回流的次数过多，影响性能</p><h4 id="3-2-字符串拼接的方式"><a href="#3-2-字符串拼接的方式" class="headerlink" title="3.2 字符串拼接的方式"></a>3.2 字符串拼接的方式</h4><p>字符串拼接绑定数据是工作中最常用的一种绑定数据的方式, 首先循环需要绑定的数据，然后把需要动态绑定的标签以字符串的方式拼接到一起，拼接完成后，最后统一的添加到页面中<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ary.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> cur = ary[i];</span><br><span class="line">    str += <span class="string">"&lt;li&gt;"</span>;</span><br><span class="line">    str += <span class="string">"&lt;span&gt;"</span> + (i + <span class="number">4</span>) + <span class="string">"&lt;/span&gt;"</span>;</span><br><span class="line">    str += cur.title;</span><br><span class="line">    str += <span class="string">"&lt;/li&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">oUl.innerHTML += str;</span><br><span class="line"><span class="comment">// oUl.innerHTML=oUl.innerHTML(把之前的三个li以字符串的方式获取到)+str;(拼接完成的整体还是字符串,最后在把字符串统一的添加到页面中，浏览器还需要把字符串渲染成为对应的标签)</span></span><br></pre></td></tr></table></figure></p><p><strong>弊端</strong>：把新拼接的字符串添加到 <code>#ul1</code>中,原有标签绑定的事件也都消失了<br><strong>优势</strong>：事先把内容拼接好,最后统一添加到页面中,只引发一次回流</p><h4 id="3-3-文档碎片"><a href="#3-3-文档碎片" class="headerlink" title="3.3 文档碎片"></a>3.3 文档碎片</h4><p>创建一个文档碎片,相当于临时创建了一个容器, 先在这个容器中进行DOM结构的变化,最后将这个容器当成一个子元素插入到 html 中</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> frg = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ary.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> cur = ary[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> oLi = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">    oLi.innerHTML = <span class="string">"&lt;span&gt;"</span> + (i + <span class="number">4</span>) + <span class="string">"&lt;/span&gt;"</span> + cur.title;</span><br><span class="line">    frg.appendChild(oLi);</span><br><span class="line">&#125;</span><br><span class="line">oUl.appendChild(frg);</span><br><span class="line">frg = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p><strong>弊端</strong>：我们把新拼接的字符串添加到<code>#ul1</code>中, 新增加的没有绑定事件<br><strong>优势</strong>：事先把内容拼接好,最后统一添加到页面中,也只引发一次回流, 原有的三个<code>li</code>绑定的事件还在</p><p>以上几种方式都会导致新增的元素绑定的事件失效, 这是因为绑定事件是给每个元素单独绑定的, 要实现子元素无论怎么改变只需要绑定一次事件, 需要用到 <code>事件委托</code> 或者 <code>事件代理</code></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;DOM映射&lt;/strong&gt;: 通过DOM方法获取的一个元素集合(类数组),这个集合仍然和页面的元素保持着联系,并且这个元素集合会随着页面元素的增加而增加,减少而减少,即使把这个数组转为一个数组,每个元素仍然和页面有联系,这就叫做”DOM映射”&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;回流&lt;/strong&gt;: 网页内的元素的增加和删除，元素的位置的改变都会引起我们的DOM回流&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;重绘&lt;/strong&gt;: 元素样式发生改变,就会把当前这个元素重新渲染一遍,进行重绘&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="JS" scheme="/tags/JS/"/>
    
      <category term="DOM" scheme="/tags/DOM/"/>
    
  </entry>
  
  <entry>
    <title>css 布局技巧</title>
    <link href="/css_layout_skills/"/>
    <id>/css_layout_skills/</id>
    <published>2017-07-22T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.248Z</updated>
    
    <content type="html"><![CDATA[<p>在写<code>HTML</code>页面的时候难免会遇到一些奇奇怪怪的现象，合理使用 <code>Css</code> 的属性就能达到我们想要的样式效果。</p><p>这篇文章目的在于记录开发中遇到的比较常见但又有些小窍门的一些布局技巧。</p><a id="more"></a><h3 id="1-父设置了overflow-hidden子如何不受影响"><a href="#1-父设置了overflow-hidden子如何不受影响" class="headerlink" title="1. 父设置了overflow: hidden子如何不受影响"></a>1. 父设置了<code>overflow: hidden</code>子如何不受影响</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=<span class="string">"width: 200px;height: 200px;padding:30px;margin: 30px auto;border: 1px solid #000;overflow: hidden;"</span>&gt;</span><br><span class="line">    &lt;div style=<span class="string">"width: 300px;height: 300px;background: #df3434;"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure><p>给子元素一个<code>position: absolute;</code>定位即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=<span class="string">"width: 200px;height: 200px;padding:30px;margin: 30px auto;border: 1px solid #000;overflow: hidden;"</span>&gt;</span><br><span class="line">    &lt;div style=<span class="string">"position:absolute;width: 300px;height: 300px;background: #df3434;"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在写&lt;code&gt;HTML&lt;/code&gt;页面的时候难免会遇到一些奇奇怪怪的现象，合理使用 &lt;code&gt;Css&lt;/code&gt; 的属性就能达到我们想要的样式效果。&lt;/p&gt;
&lt;p&gt;这篇文章目的在于记录开发中遇到的比较常见但又有些小窍门的一些布局技巧。&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="CSS" scheme="/tags/CSS/"/>
    
      <category term="布局技巧" scheme="/tags/%E5%B8%83%E5%B1%80%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>升级本地已安装的 Node 和 npm 版本</title>
    <link href="/node_npm_update/"/>
    <id>/node_npm_update/</id>
    <published>2017-07-17T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.252Z</updated>
    
    <content type="html"><![CDATA[<p><code>Mac</code>升级本地已经安装的<code>NodeJs</code>和<code>Npm</code>到最新版,可以使用一下方式进行升级和更新。</p><p>其实<code>windos</code>上升级<code>nodejs</code>也很简单，只需在<code>nodejs</code>官网下载安装最新的<code>msi</code>即可。</p><p>值得注意的是安装时需要按原<code>nodejs</code>安装路径路径安装，不能安装到新的路径。</p><a id="more"></a><h3 id="1-Node-版本升级"><a href="#1-Node-版本升级" class="headerlink" title="1. Node 版本升级"></a>1. Node 版本升级</h3><p><strong>step1：</strong> 查看本机当前 <code>node</code> 版本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><p><strong>step2：</strong> 清除<code>nodejs</code>的 <code>cache</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm cache clean -f</span><br></pre></td></tr></table></figure><p><strong>step3：</strong> 安装<code>node</code>管理工具 <code>n</code></p><p>这个工具是专门用来管理<code>nodejs</code>版本的，别怀疑这个工具的名字, 他的名字就是 <code>&quot;n&quot;</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g n</span><br></pre></td></tr></table></figure><p><strong>step4：</strong> 安装不同版本的 <code>nodejs</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装最新版本</span></span><br><span class="line">n latest</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安装稳定版本</span></span><br><span class="line">n stable</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安装或使用某一个版本</span></span><br><span class="line">n <span class="number">8.2</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除某个版本</span></span><br><span class="line">n rm <span class="number">6.7</span><span class="number">.0</span></span><br></pre></td></tr></table></figure><p><strong>step5：</strong> 再次查看 <code>node</code> 版本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure><h3 id="2-更新-npm-到最新版本"><a href="#2-更新-npm-到最新版本" class="headerlink" title="2. 更新 npm 到最新版本"></a>2. 更新 <code>npm</code> 到最新版本</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install npm@latest -g</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Mac&lt;/code&gt;升级本地已经安装的&lt;code&gt;NodeJs&lt;/code&gt;和&lt;code&gt;Npm&lt;/code&gt;到最新版,可以使用一下方式进行升级和更新。&lt;/p&gt;
&lt;p&gt;其实&lt;code&gt;windos&lt;/code&gt;上升级&lt;code&gt;nodejs&lt;/code&gt;也很简单，只需在&lt;code&gt;nodejs&lt;/code&gt;官网下载安装最新的&lt;code&gt;msi&lt;/code&gt;即可。&lt;/p&gt;
&lt;p&gt;值得注意的是安装时需要按原&lt;code&gt;nodejs&lt;/code&gt;安装路径路径安装，不能安装到新的路径。&lt;/p&gt;
    
    </summary>
    
      <category term="NodeJS" scheme="/categories/NodeJS/"/>
    
    
      <category term="node" scheme="/tags/node/"/>
    
      <category term="npm" scheme="/tags/npm/"/>
    
  </entry>
  
  <entry>
    <title>Git 常用遇到的问题</title>
    <link href="/git_common_problem/"/>
    <id>/git_common_problem/</id>
    <published>2017-07-11T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.254Z</updated>
    
    <content type="html"><![CDATA[<p>开发中经常遇到一些奇奇怪怪的状况，以下是记录工作中遇到过的 <code>Git</code> 使用出现的问题，做以下记录</p><h3 id="常遇到的问题"><a href="#常遇到的问题" class="headerlink" title="常遇到的问题"></a>常遇到的问题</h3><h4 id="1-git-add-，-git-commit-添加错文件-撤销"><a href="#1-git-add-，-git-commit-添加错文件-撤销" class="headerlink" title="1. git add ， git commit 添加错文件 撤销"></a>1. git add ， git commit 添加错文件 撤销</h4><a id="more"></a><p><code>git add</code> 添加 多余文件</p><p><code>git status</code> 先看一下add 中的文件<br><code>git reset HEAD</code> 如果后面什么都不跟的话 就是上一次add 里面的全部撤销了<br><code>git reset HEAD xxx/xxx/xxx.js</code> 就是对某个文件进行撤销了</p><p><code>git commit</code> 错误</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git log <span class="comment">// 查看节点 </span></span><br><span class="line">commit xxxxxxxxxxxxxxxxxxxxxxxxxx </span><br><span class="line">git reset commit_id</span><br></pre></td></tr></table></figure><h4 id="2-撤销修改"><a href="#2-撤销修改" class="headerlink" title="2. 撤销修改"></a>2. 撤销修改</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout . </span><br><span class="line">git checkout file</span><br></pre></td></tr></table></figure><h4 id="3-Git：refname’master’是不明确的"><a href="#3-Git：refname’master’是不明确的" class="headerlink" title="3. Git：refname’master’是不明确的"></a>3. Git：refname’master’是不明确的</h4><p><code>warning: refname &#39;branch-name&#39; is ambiguous</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout RELEASE</span><br><span class="line">warning: refname <span class="string">'RELEASE'</span> is ambiguous.</span><br><span class="line">Switched to branch <span class="string">'RELEASE'</span></span><br><span class="line">Your branch is up to date <span class="keyword">with</span> <span class="string">'origin/RELEASE'</span>.</span><br></pre></td></tr></table></figure><p>解决方案</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git tag tag-master master</span><br><span class="line">git tag -d master</span><br></pre></td></tr></table></figure><p>原文: <a href="https://codeday.me/bug/20171218/110944.html" target="_blank" rel="noopener">Git：refname’master’是不明确的</a></p><h4 id="4-HEAD-detached-at-head"><a href="#4-HEAD-detached-at-head" class="headerlink" title="4. HEAD detached at head"></a>4. HEAD detached at head</h4><p>HEAD 没有指到某个分支的時候，它会呈现 detached 状态。事实上，更正确的说，应该是「当 HEAD 没有指到某个『本地』的分支」就会呈现这种状态</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout  origin/TEST</span><br><span class="line">Note: checking out <span class="string">'origin/TEST'</span>.</span><br><span class="line"></span><br><span class="line">You are <span class="keyword">in</span> <span class="string">'detached HEAD'</span> state. You can look around, make experimental</span><br><span class="line">changes and commit them, and you can discard any commits you make <span class="keyword">in</span> <span class="keyword">this</span></span><br><span class="line">state without impacting any branches by performing another checkout.</span><br><span class="line"></span><br><span class="line">If you want to create a <span class="keyword">new</span> branch to retain commits you create, you may</span><br><span class="line"><span class="keyword">do</span> so (now or later) by using -b <span class="keyword">with</span> the checkout command again. Example:</span><br><span class="line"></span><br><span class="line">  git checkout -b &lt;<span class="keyword">new</span>-branch-name&gt;</span><br><span class="line"></span><br><span class="line">HEAD is now at e53d4cba update</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line">* (HEAD detached at origin/TEST)</span><br><span class="line">  RELEASE</span><br><span class="line">  dev_register_sqb</span><br><span class="line">  master</span><br></pre></td></tr></table></figure><p>要切换到远端分支而不呈现 detached HEAD 状态，可以加上 –track 或 -t 参数, -t 参数是指会在本地建立一个名为追踪分支（tracking branch）的东西</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -t origin/TEST</span><br><span class="line">Branch <span class="string">'TEST'</span> set up to track remote branch <span class="string">'TEST'</span> <span class="keyword">from</span> <span class="string">'origin'</span>.</span><br><span class="line">Switched to a <span class="keyword">new</span> branch <span class="string">'TEST'</span></span><br><span class="line"></span><br><span class="line">$ git branch</span><br><span class="line">  RELEASE</span><br><span class="line">* TEST</span><br><span class="line">  dev_register_sqb</span><br><span class="line">  master</span><br></pre></td></tr></table></figure><p>参考文章:<br><a href="https://gitbook.tw/chapters/faq/detached-head.html" target="_blank" rel="noopener">斷頭（detached HEAD）是怎麼一回事？</a><br><a href="https://www.jianshu.com/p/ae4857d2f868" target="_blank" rel="noopener">如何从detached HEAD状态解救出来</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;开发中经常遇到一些奇奇怪怪的状况，以下是记录工作中遇到过的 &lt;code&gt;Git&lt;/code&gt; 使用出现的问题，做以下记录&lt;/p&gt;
&lt;h3 id=&quot;常遇到的问题&quot;&gt;&lt;a href=&quot;#常遇到的问题&quot; class=&quot;headerlink&quot; title=&quot;常遇到的问题&quot;&gt;&lt;/a&gt;常遇到的问题&lt;/h3&gt;&lt;h4 id=&quot;1-git-add-，-git-commit-添加错文件-撤销&quot;&gt;&lt;a href=&quot;#1-git-add-，-git-commit-添加错文件-撤销&quot; class=&quot;headerlink&quot; title=&quot;1. git add ， git commit 添加错文件 撤销&quot;&gt;&lt;/a&gt;1. git add ， git commit 添加错文件 撤销&lt;/h4&gt;
    
    </summary>
    
      <category term="Git" scheme="/categories/Git/"/>
    
    
      <category term="Git" scheme="/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Git 常用操作</title>
    <link href="/git_basis/"/>
    <id>/git_basis/</id>
    <published>2017-07-10T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.254Z</updated>
    
    <content type="html"><![CDATA[<p><code>Git</code> 是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。</p><p><code>Git</code> 不仅仅是个版本控制系统，它也是个内容管理系统(CMS),工作管理系统等。</p><p><code>Git</code> 是 <code>Linus Torvalds</code> 为了帮助管理 <code>Linux</code> 内核开发而开发的一个开放源码的版本控制软件。<br><a id="more"></a><br><code>Git</code> 与常用的版本控制工具 <code>CVS</code>, <code>Subversion</code> 等不同，它采用了分布式版本库的方式，不必服务器端软件支持。</p><h3 id="1-安装和配置"><a href="#1-安装和配置" class="headerlink" title="1. 安装和配置"></a>1. 安装和配置</h3><p>在使用<code>Git</code>前需要先安装 <code>Git</code>。<code>Git</code> 目前支持 <code>Linux/Unix</code>、<code>Solaris</code>、<code>Mac</code>和 <code>Windows</code> 平台上运行。</p><p><code>Git</code> 各平台安装包下载地址为：<a href="http://git-scm.com/downloads" target="_blank" rel="noopener">http://git-scm.com/downloads</a></p><p>配置个人的用户名称和电子邮件地址:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">"undo"</span></span><br><span class="line">git config --global user.email myundo@<span class="number">163.</span>com</span><br></pre></td></tr></table></figure><p>要检查已有的配置信息，可以使用 <code>git config --list</code> 命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git config --list</span><br><span class="line"></span><br><span class="line">user.name=undo</span><br><span class="line">user.email=myundo@163.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="2-Git-工作流程"><a href="#2-Git-工作流程" class="headerlink" title="2. Git 工作流程"></a>2. Git 工作流程</h3><p>一般工作流程如下：</p><ul><li>克隆 Git 资源作为工作目录。</li><li>在克隆的资源上添加或修改文件。</li><li>如果其他人修改了，你可以更新资源。</li><li>在提交前查看修改。</li><li>提交修改。</li><li>在修改完成后，如果发现错误，可以撤回提交并再次修改并提交。</li></ul><p><img src="https://github.com/undo03/undo03.github.io/blob/master/article_images/Perphery/gitworkflow.png?raw=true" alt=""></p><h3 id="3-Git-工作区、暂存区和版本库"><a href="#3-Git-工作区、暂存区和版本库" class="headerlink" title="3. Git 工作区、暂存区和版本库"></a>3. Git 工作区、暂存区和版本库</h3><ul><li><strong>工作区</strong>：就是你在电脑里能看到的目录。</li><li><strong>暂存区</strong>：英文叫stage, 或index。一般存放在”git目录”下的index文件中，所以我们把暂存区有时也叫作索引（index）。</li><li><strong>版本库</strong>：工作区有一个隐藏目录.git，这个不算工作区，而是Git的版本库。</li></ul><h3 id="4-Git-基本操作"><a href="#4-Git-基本操作" class="headerlink" title="4. Git 基本操作"></a>4. Git 基本操作</h3><h4 id="4-1-创建仓库"><a href="#4-1-创建仓库" class="headerlink" title="4.1 创建仓库"></a>4.1 创建仓库</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在已有项目目录下</span></span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定仓库目录</span></span><br><span class="line">git init newrepo</span><br><span class="line"></span><br><span class="line"><span class="comment">// 克隆项目并重新命名</span></span><br><span class="line">git clone [url] rename</span><br></pre></td></tr></table></figure><h4 id="4-2-工作流程"><a href="#4-2-工作流程" class="headerlink" title="4.2 工作流程"></a>4.2 工作流程</h4><p>大致流程使用如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir proDemo</span><br><span class="line">cd proDemo</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">'commit'</span></span><br></pre></td></tr></table></figure><p><code>git add</code> 提交缓存，后面加 <code>.</code> 或者 <code>-a</code>， 表示全部缓存，也可以 <code>git add file</code> 提交文件， 多个文件用空格隔开</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git add file</span><br><span class="line">git add flieA fileB</span><br></pre></td></tr></table></figure><p><code>git commit</code> 为本次提交添加备注, <code>-m</code> 选项在命令行中提供提交注释, 没有设置 <code>-m</code> 选项，<code>Git</code> 会尝试为你打开一个编辑器以填写提交信息.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -m <span class="string">'commit'</span></span><br></pre></td></tr></table></figure><p><code>git add</code> 和 <code>git commit</code> 可以合并为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -am <span class="string">'commit'</span></span><br></pre></td></tr></table></figure><p><code>git reset HEAD</code> 命令用于取消缓存已缓存的内容</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD <span class="comment">// 撤销本次提交</span></span><br><span class="line">git reset HEAD -- hello.js <span class="comment">// 撤销单个文件的提交</span></span><br></pre></td></tr></table></figure><p><code>git rm</code> 将文件从缓存区中移除,默认情况下,<code>git rm file</code> 会将文件从缓存区和你的硬盘中（工作目录）删除。 如果要在工作目录中留着该文件，可以使用命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rm hello.js --cached</span><br></pre></td></tr></table></figure><h3 id="5-Git-分支管理"><a href="#5-Git-分支管理" class="headerlink" title="5. Git 分支管理"></a>5. Git 分支管理</h3><p><strong>查看分支</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure><p><strong>新建分支</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git branch (branchname)</span><br><span class="line">git checkout -b (branchname)</span><br></pre></td></tr></table></figure><p><strong>切换分支</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout (branchname)</span><br></pre></td></tr></table></figure><p><strong>删除分支</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d (branchname)</span><br></pre></td></tr></table></figure><p><strong>分支合并</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge (branchname)</span><br></pre></td></tr></table></figure><p><strong>合并冲突</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git merge test</span><br><span class="line">CONFLICT (content): Merge conflict <span class="keyword">in</span> test.txt</span><br></pre></td></tr></table></figure><p><code>CONFLICT</code>表示合并冲突就出现了,需要手动去修改它, 用 <code>git add</code> 告诉 <code>Git</code> 文件冲突已经解决, 然后继续 <code>commit</code></p><p><strong>查看提交历史</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure><p>用 <code>--oneline</code> 选项来查看历史记录的简洁的版本,  <code>--graph</code> 选项,查看历史中什么时候出现了分支、合并, 用 <code>--reverse</code> 参数来逆向显示所有日志, <code>--author</code> 查找指定用户的提交日志</p><p>指定日期: <code>--since</code> 和 <code>--before</code>，也可以用 <code>--until</code> 和 <code>--after</code></p><p><code>--no-merges</code> 选项以隐藏合并提交</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git log --oneline</span><br><span class="line">git log --oneline --graph</span><br><span class="line">git log --reverse --oneline</span><br><span class="line">git log --author=Linus --oneline</span><br><span class="line">git log --oneline --before=&#123;<span class="number">3.</span>weeks.ago&#125; --after=&#123;<span class="number">2017</span><span class="number">-06</span><span class="number">-18</span>&#125; --no-merges</span><br></pre></td></tr></table></figure><h3 id="6-Git-管理远程分支"><a href="#6-Git-管理远程分支" class="headerlink" title="6. Git 管理远程分支"></a>6. Git 管理远程分支</h3><p><strong>查看远程连接</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote</span><br></pre></td></tr></table></figure><p><code>-v</code> 参数可以看到每个别名的实际链接地址</p><p><strong>添加远程连接</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add [shortname] [url]</span><br></pre></td></tr></table></figure><p><code>shortname</code> 添加一个新的远程仓库，可以指定一个简单的名字，以便将来引用</p><p><strong>提取远程仓库</strong></p><p><code>git fetch</code> 从远程仓库下载新分支与数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br></pre></td></tr></table></figure><p><code>git pull</code> 从远端仓库提取数据并尝试合并到当前分支, <code>[shortname/branchname]</code> 参数可以将指定连接的指定分支代码合并到当前分支</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull [shortname/branchname]</span><br></pre></td></tr></table></figure><p><code>git merge</code> 加参数 <code>shortname/branchname</code>,也会合并远程分支到当前本地分支</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge [shortname/branchname]</span><br></pre></td></tr></table></figure><p><strong>推送到远程仓库</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push [shortname] [branch]</span><br></pre></td></tr></table></figure><p><strong>删除远程仓库</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote rm [shortname]</span><br></pre></td></tr></table></figure><p><strong>删除远程分支和tag</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git push origin --<span class="keyword">delete</span> &lt;branchName&gt;</span><br><span class="line">git push origin --<span class="keyword">delete</span> tag &lt;tagname&gt;</span><br></pre></td></tr></table></figure><p>否则，可以使用这种语法，推送一个空分支到远程分支，其实就相当于删除远程分支,删除tag的方法，推送一个空tag到远程tag</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git push origin :<span class="xml"><span class="tag">&lt;<span class="name">branchName</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line">git tag -d &lt;tagname&gt;</span><br><span class="line">git push origin :refs/tags/&lt;tagname&gt;</span><br></pre></td></tr></table></figure><p>删除不存在对应远程分支的本地分支</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch -p</span><br></pre></td></tr></table></figure><p>重命名远程分支</p><p>在git中重命名远程分支，其实就是先删除远程分支，然后重命名本地分支，再重新提交一个远程分支</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git push --<span class="keyword">delete</span> origin devel</span><br><span class="line"></span><br><span class="line">git branch -m devel develop</span><br><span class="line"></span><br><span class="line">git branch -m devel develop</span><br></pre></td></tr></table></figure><p><strong>参考链接</strong><br><a href="https://www.w3cschool.cn/git/" target="_blank" rel="noopener">W3Cschool Git教程</a><br><a href="http://blog.zengrong.net/post/1746.html" target="_blank" rel="noopener">Git查看、删除、重命名远程分支和tag</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Git&lt;/code&gt; 是一个开源的分布式版本控制系统，用于敏捷高效地处理任何或小或大的项目。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Git&lt;/code&gt; 不仅仅是个版本控制系统，它也是个内容管理系统(CMS),工作管理系统等。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Git&lt;/code&gt; 是 &lt;code&gt;Linus Torvalds&lt;/code&gt; 为了帮助管理 &lt;code&gt;Linux&lt;/code&gt; 内核开发而开发的一个开放源码的版本控制软件。&lt;br&gt;
    
    </summary>
    
      <category term="Git" scheme="/categories/Git/"/>
    
    
      <category term="Git" scheme="/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>原生JS实现jQuery中的DOM操作</title>
    <link href="/js_jQuery_dom/"/>
    <id>/js_jQuery_dom/</id>
    <published>2017-06-24T16:00:00.000Z</published>
    <updated>2019-07-02T01:35:56.250Z</updated>
    
    <content type="html"><![CDATA[<p><code>jQuery</code> 是一个 <code>“写的更少，但做的更多”</code> 的轻量级 <code>JavaScript</code> 库.</p><p>基本上，学习到如何选取 <code>HTML</code> 元素,以及如何对它们执行类似隐藏、移动以及操作其内容等任务.</p><p>这篇文章用原生JS实现<code>jQuery</code>中大部分的<code>DOM操作</code>的方法.</p><a id="more"></a><p>为了方便判断浏览器兼容性, 用一下 <code>flag</code> 的值代表是否是 <code>IE8</code>以上浏览器</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> flag = <span class="string">'getComputedStyle'</span> <span class="keyword">in</span> <span class="built_in">window</span>;</span><br></pre></td></tr></table></figure><h3 id="1-win-操作浏览器盒子模型"><a href="#1-win-操作浏览器盒子模型" class="headerlink" title="1. win 操作浏览器盒子模型"></a>1. win 操作浏览器盒子模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//-&gt;win:一个有关于操作浏览器盒子模型的方法</span></span><br><span class="line"><span class="comment">//如果只传递了attr没有传递value,默认的意思是“获取”</span></span><br><span class="line"><span class="comment">//如果两个参数都传递了,意思是“设置”</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">win</span>(<span class="params">attr, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.documentElement[attr] || <span class="built_in">document</span>.body[attr];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">document</span>.documentElement[attr] = value;</span><br><span class="line">    <span class="built_in">document</span>.body[attr] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-offset-获取元素相对于body的偏移量"><a href="#2-offset-获取元素相对于body的偏移量" class="headerlink" title="2. offset 获取元素相对于body的偏移量"></a>2. offset 获取元素相对于body的偏移量</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* offset：Gets the offset of the current element distance BODY</span></span><br><span class="line"><span class="comment">* @parameter：</span></span><br><span class="line"><span class="comment">*   curEle[object]：current element</span></span><br><span class="line"><span class="comment">* @return：</span></span><br><span class="line"><span class="comment">*   [object]：&#123;top:xxx,left:xxx&#125;</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-23 16:43</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">offset</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> par = curEle.offsetParent, totalLeft = curEle.offsetLeft, totalTop = curEle.offsetTop;</span><br><span class="line">    <span class="keyword">while</span> (par) &#123;</span><br><span class="line">        <span class="keyword">if</span> (navigator.userAgent.indexOf(<span class="string">'MSIE 8.0'</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">            totalLeft += par.clientLeft;</span><br><span class="line">            totalTop += par.clientTop;</span><br><span class="line">        &#125;</span><br><span class="line">        totalLeft += par.offsetLeft;</span><br><span class="line">        totalTop += par.offsetTop;</span><br><span class="line"></span><br><span class="line">        par = par.offsetParent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="attr">left</span>: totalLeft, <span class="attr">top</span>: totalTop&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>offset</code>: 等同于<code>jQuery</code>中的<code>offset</code>方法,实现获取页面中任意一个元素,距离body的偏移(包含左偏移和上偏移),不管当前元素的父级参照物是谁,获取的结果是一个对象 <code>{left:距离BODY的左偏移,top:距离BODY的上偏移}</code></p><p>在标准的<code>IE8浏览器</code>中,使用<code>offsetLeft/offsetTop</code>其实是把父级参照物的边框已经算在内了,所以我们不需要自己在单独的加边框了</p><h3 id="3-getCss-获取元素的style属性"><a href="#3-getCss-获取元素的style属性" class="headerlink" title="3. getCss 获取元素的style属性"></a>3. getCss 获取元素的style属性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* getCss：Gets the value of the specific style property for the current element</span></span><br><span class="line"><span class="comment">* @parameter：</span></span><br><span class="line"><span class="comment">*   curEle[object]：current element</span></span><br><span class="line"><span class="comment">*   attr[string]：style properties of elements</span></span><br><span class="line"><span class="comment">* @return：</span></span><br><span class="line"><span class="comment">*   Style attribute values for elements</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-23 12:29</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCss</span>(<span class="params">curEle, attr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> val = <span class="literal">null</span>, reg = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'getComputedStyle'</span> <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">        val = <span class="built_in">window</span>.getComputedStyle(curEle, <span class="literal">null</span>)[attr];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">//IE6~8</span></span><br><span class="line">        <span class="keyword">switch</span> (attr) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'filter'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'opacity'</span>:</span><br><span class="line">                val = curEle.currentStyle[<span class="string">'filter'</span>];</span><br><span class="line">                <span class="comment">//reg = /^alpha\(opacity=(\d+(?:\.\d+)?)\)$/i;</span></span><br><span class="line">                reg = <span class="regexp">/^alpha\(opacity=(.+)\)$/i</span>;</span><br><span class="line">                val = reg.test(val) ? <span class="built_in">RegExp</span>.$<span class="number">1</span> / <span class="number">100</span> : <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span> :</span><br><span class="line">                val = curEle.currentStyle[attr];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    reg = <span class="regexp">/^(?:-?\d+(?:\.\d+)?)(?:px|pt|rem|em)?$/i</span>;</span><br><span class="line">    <span class="keyword">return</span> reg.test(val) ? <span class="built_in">parseFloat</span>(val) : val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是兼容写法, 新版浏览器支持<code>getComputedStyle</code>获取更方便, <code>currentStyle</code> 需要对透明度做特殊处理, 最后为了和<code>jQuery</code>保持一致去单位</p><h3 id="4-setCss-为元素设置style属性"><a href="#4-setCss-为元素设置style属性" class="headerlink" title="4. setCss 为元素设置style属性"></a>4. setCss 为元素设置style属性</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setCss</span>(<span class="params">curEle, attr, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (attr === <span class="string">'opacity'</span>) &#123;</span><br><span class="line">        curEle.style[<span class="string">'opacity'</span>] = value;</span><br><span class="line">        curEle.style[<span class="string">'filter'</span>] = <span class="string">'alpha(opacity='</span> + value * <span class="number">100</span> + <span class="string">')'</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (attr === <span class="string">'float'</span>) &#123;</span><br><span class="line">        curEle.style[<span class="string">'cssFloat'</span>] = value;</span><br><span class="line">        curEle.style[<span class="string">'styleFloat'</span>] = value;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//给部分样式属性做特殊处理,如果传递进来的样式属性值没有加单位,我们默认给补充px单位</span></span><br><span class="line">    <span class="keyword">var</span> reg = <span class="regexp">/^(?:width|height|(?:(?:margin|padding)?(?:top|right|bottom|left)))$/i</span>;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(attr)) &#123;</span><br><span class="line">        !<span class="built_in">isNaN</span>(value) ? value += <span class="string">'px'</span> : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    curEle.style[attr] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样为了兼容各个浏览器需要对 <code>opacity</code>,<code>float</code>做特殊处理,需要对带单位的属性值添加单位</p><h3 id="5-setGroupCss-为元素设置一组style"><a href="#5-setGroupCss-为元素设置一组style" class="headerlink" title="5. setGroupCss 为元素设置一组style"></a>5. setGroupCss 为元素设置一组style</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setGroupCss</span>(<span class="params">curEle, styleCollection</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//循环传递进来的样式集合,调取SETCSS方法,给当前元素逐一设置样式即可</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> styleCollection) &#123;</span><br><span class="line">        <span class="keyword">if</span> (styleCollection.hasOwnProperty(key)) &#123;</span><br><span class="line">            setCss(curEle, key, styleCollection[key]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-css"><a href="#6-css" class="headerlink" title="6. css"></a>6. css</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">css</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">        setCss.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">2</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">1</span>] === <span class="string">'object'</span>) &#123;</span><br><span class="line">        setGroupCss.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getCss.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 getCss setCss setGroupCss 整合 , 达到<code>jQuery</code>中<code>css</code>相同的效果</p><h3 id="7-children-获取元素的子元素"><a href="#7-children-获取元素的子元素" class="headerlink" title="7. children 获取元素的子元素"></a>7. children 获取元素的子元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">children</span>(<span class="params">curEle, tagName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ary = [];</span><br><span class="line">    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeList = curEle.childNodes;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="built_in">arguments</span>.length; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> curNode = <span class="built_in">arguments</span>[i];</span><br><span class="line">            curNode.nodeType === <span class="number">1</span> ? ary[ary.length] = curNode : <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nodeList = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ary = <span class="built_in">Array</span>.prototype.slice.call(curEle.children);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tagName === <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; ary.length; j++) &#123;</span><br><span class="line">            <span class="keyword">var</span> curEleNode = ary[j];</span><br><span class="line">            <span class="keyword">if</span> (curEleNode.nodeName !== tagName.toUpperCase()) &#123;</span><br><span class="line">                ary.splice(j, <span class="number">1</span>);</span><br><span class="line">                j--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-prev-获取元素的上一个哥哥元素"><a href="#8-prev-获取元素的上一个哥哥元素" class="headerlink" title="8. prev 获取元素的上一个哥哥元素"></a>8. prev 获取元素的上一个哥哥元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* prev：获取当前元素的上一个哥哥元素节点(兼容所有浏览器)</span></span><br><span class="line"><span class="comment">* @parameter</span></span><br><span class="line"><span class="comment">*       curEle:current element 当前操作的元素</span></span><br><span class="line"><span class="comment">* @return</span></span><br><span class="line"><span class="comment">*       上一个哥哥元素节点或者是null(没有返回null)</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-08 11:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prev</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="keyword">return</span> curEle.previousElementSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> pre = curEle.previousSibling;</span><br><span class="line">    <span class="keyword">if</span> (pre &amp;&amp; pre.nodeType !== <span class="number">1</span>) &#123;</span><br><span class="line">        pre = pre.previousSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pre;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-prevAll-获取元素的所有哥哥元素"><a href="#9-prevAll-获取元素的所有哥哥元素" class="headerlink" title="9. prevAll 获取元素的所有哥哥元素"></a>9. prevAll 获取元素的所有哥哥元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">* prevAll：获取当前元素的所有哥哥元素节点(兼容所有浏览器)</span></span><br><span class="line"><span class="comment">* @parameter</span></span><br><span class="line"><span class="comment">*       curEle:current element 当前操作的元素</span></span><br><span class="line"><span class="comment">* @return</span></span><br><span class="line"><span class="comment">*       所有的哥哥元素节点或者是null(没有返回null)</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-08 11:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prevAll</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ary = [], pre = prev(curEle);</span><br><span class="line">    <span class="keyword">while</span> (pre) &#123;</span><br><span class="line">        ary.push(pre);</span><br><span class="line">        pre = prev(pre);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-next-获取元素的下一个弟弟元素"><a href="#10-next-获取元素的下一个弟弟元素" class="headerlink" title="10. next 获取元素的下一个弟弟元素"></a>10. next 获取元素的下一个弟弟元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* next：获取当前元素的下一个弟弟元素节点(兼容所有浏览器)</span></span><br><span class="line"><span class="comment">* @parameter</span></span><br><span class="line"><span class="comment">*       curEle:current element 当前操作的元素</span></span><br><span class="line"><span class="comment">* @return</span></span><br><span class="line"><span class="comment">*       下一个弟弟元素节点或者是null(没有返回null)</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-08 11:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="keyword">return</span> curEle.nextElementSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> nex = curEle.nextSibling;</span><br><span class="line">    <span class="keyword">if</span> (nex &amp;&amp; nex.nodeType !== <span class="number">1</span>) &#123;</span><br><span class="line">        nex = nex.nextSibling;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="11-nextAll-获取元素的所有弟弟元素"><a href="#11-nextAll-获取元素的所有弟弟元素" class="headerlink" title="11. nextAll 获取元素的所有弟弟元素"></a>11. nextAll 获取元素的所有弟弟元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* nextAll：获取当前元素的所有弟弟元素节点(兼容所有浏览器)</span></span><br><span class="line"><span class="comment">* @parameter</span></span><br><span class="line"><span class="comment">*       curEle:current element 当前操作的元素</span></span><br><span class="line"><span class="comment">* @return</span></span><br><span class="line"><span class="comment">*       所有的弟弟元素节点或者是null(没有返回null)</span></span><br><span class="line"><span class="comment">* By Team on 2017-04-08 11:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nextAll</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ary = [], nex = next(curEle);</span><br><span class="line">    <span class="keyword">while</span> (nex) &#123;</span><br><span class="line">        ary.push(nex);</span><br><span class="line">        nex = next(nex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="12-sibling-获取元素相邻元素"><a href="#12-sibling-获取元素相邻元素" class="headerlink" title="12. sibling 获取元素相邻元素"></a>12. sibling 获取元素相邻元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sibling</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pre = prev(curEle);</span><br><span class="line">    <span class="keyword">var</span> nex = next(curEle);</span><br><span class="line">    <span class="keyword">var</span> ary = [];</span><br><span class="line">    pre ? ary.push(pre) : <span class="literal">null</span>;</span><br><span class="line">    nex ? ary.push(nex) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-siblings-获取元素的所有兄弟元素"><a href="#13-siblings-获取元素的所有兄弟元素" class="headerlink" title="13. siblings 获取元素的所有兄弟元素"></a>13. siblings 获取元素的所有兄弟元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">siblings</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.prevAll(curEle).concat(nextAll(curEle));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-index-获取元素所在的索引"><a href="#14-index-获取元素所在的索引" class="headerlink" title="14. index 获取元素所在的索引"></a>14. index 获取元素所在的索引</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> prevAll(curEle).length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="15-firstChild-获取第一个子节点"><a href="#15-firstChild-获取第一个子节点" class="headerlink" title="15. firstChild 获取第一个子节点"></a>15. firstChild 获取第一个子节点</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">firstChild</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chs = children(curEle);</span><br><span class="line">    <span class="keyword">return</span> chs.length &gt; <span class="number">0</span> ? chs[<span class="number">0</span>] : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="16-lastChild-获取最后一个子节点"><a href="#16-lastChild-获取最后一个子节点" class="headerlink" title="16. lastChild 获取最后一个子节点"></a>16. lastChild 获取最后一个子节点</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lastChild</span>(<span class="params">curEle</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> chs = children(curEle);</span><br><span class="line">        <span class="keyword">return</span> chs.length &gt; <span class="number">0</span> ? chs[chs.length - <span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="17-append-向指定容器的末尾追加元素"><a href="#17-append-向指定容器的末尾追加元素" class="headerlink" title="17. append 向指定容器的末尾追加元素"></a>17. append 向指定容器的末尾追加元素</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params">newEle, container</span>) </span>&#123;</span><br><span class="line">    container.appendChild(newEle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="18-prepend-向指定容器的开头追加元素"><a href="#18-prepend-向指定容器的开头追加元素" class="headerlink" title="18. prepend 向指定容器的开头追加元素"></a>18. prepend 向指定容器的开头追加元素</h3><p>把新的元素添加到容器中第一个子元素节点的前面,如果一个元素子节点都没有,就放在末尾即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prepend</span>(<span class="params">newEle, container</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fir = firstChild(container);</span><br><span class="line">    <span class="keyword">if</span> (fir) &#123;</span><br><span class="line">        container.insertBefore(newEle, fir);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    container.appendChild(curEle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="19-insertBefore-把新元素追加到指定元素的前面"><a href="#19-insertBefore-把新元素追加到指定元素的前面" class="headerlink" title="19. insertBefore 把新元素追加到指定元素的前面"></a>19. insertBefore 把新元素追加到指定元素的前面</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertBefore</span>(<span class="params">newEle, oldEle</span>) </span>&#123;</span><br><span class="line">    oldEle.parentNode.insertBefore(newEle, oldEle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="20-insertAfter-把新元素追加到指定元素的后面"><a href="#20-insertAfter-把新元素追加到指定元素的后面" class="headerlink" title="20. insertAfter 把新元素追加到指定元素的后面"></a>20. insertAfter 把新元素追加到指定元素的后面</h3><p>相当于追加到oldEle弟弟元素的前面,如果弟弟不存在,也就是当前元素已经是最后一个了,我们把新的元素放在最末尾即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">insertAfter</span>(<span class="params">newEle, oldEle</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nex = next(oldEle);</span><br><span class="line">    <span class="keyword">if</span> (nex) &#123;</span><br><span class="line">        oldEle.parentNode.insertBefore(newEle, nex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    oldEle.parentNode.appendChild(newEle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="21-hasClass-判断元素是否有某个class"><a href="#21-hasClass-判断元素是否有某个class" class="headerlink" title="21. hasClass 判断元素是否有某个class"></a>21. hasClass 判断元素是否有某个class</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hasClass</span>(<span class="params">curEle, cName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\\b'</span> + cName + <span class="string">'\\b'</span>).test(curEle.className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="22-addClass-为元素添加class"><a href="#22-addClass-为元素添加class" class="headerlink" title="22. addClass 为元素添加class"></a>22. addClass 为元素添加class</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addClass</span>(<span class="params">curEle, strClass</span>) </span>&#123;</span><br><span class="line">    strClass = strClass.replace(<span class="regexp">/(^ +| +$)/g</span>, <span class="string">""</span>).split(<span class="regexp">/ +/g</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = strClass.length; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> curClass = strClass[i];</span><br><span class="line">        <span class="keyword">if</span> (!hasClass(curEle, curClass)) &#123;</span><br><span class="line">            curEle.className += <span class="string">" "</span> + curClass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="23-removeClass-移除元素中的class"><a href="#23-removeClass-移除元素中的class" class="headerlink" title="23. removeClass 移除元素中的class"></a>23. removeClass 移除元素中的class</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeClass</span>(<span class="params">curEle, strClass</span>) </span>&#123;</span><br><span class="line">    strClass = strClass.replace(<span class="regexp">/(^ +| +$)/g</span>, <span class="string">""</span>).split(<span class="regexp">/ +/g</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = strClass.length; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> curClass = strClass[i];</span><br><span class="line">        <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^| +)"</span> + curClass + <span class="string">"( +|$)"</span>, <span class="string">"g"</span>);</span><br><span class="line">        hasClass(curEle, curClass) ? curEle.className = curEle.className.replace(<span class="regexp">/ /g</span>,<span class="string">'  '</span>).replace(reg, <span class="string">" "</span>) : <span class="literal">null</span>;</span><br><span class="line">        curEle.className = curEle.className.replace(<span class="regexp">/(^ +| +$)/</span>, <span class="string">" "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="24-toggleClass-切换元素的class"><a href="#24-toggleClass-切换元素的class" class="headerlink" title="24. toggleClass 切换元素的class"></a>24. toggleClass 切换元素的class</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toggleClass</span>(<span class="params">curEle, strClass</span>) </span>&#123;</span><br><span class="line">    strClass = strClass.replace(<span class="regexp">/(^ +| +$)/g</span>, <span class="string">""</span>).split(<span class="regexp">/ +/g</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; strClass.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> curClass = strClass[i];</span><br><span class="line">        hasClass(curEle, curClass) ? removeClass(curEle, curClass) : addClass(curEle, curClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="25-getElementsByClass"><a href="#25-getElementsByClass" class="headerlink" title="25. getElementsByClass"></a>25. getElementsByClass</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElementsByClass</span>(<span class="params">strClass, context</span>) </span>&#123;</span><br><span class="line">    context = context || <span class="built_in">document</span>;</span><br><span class="line">    <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">        <span class="keyword">return</span> listToArray(context.getElementsByClassName(strClass));</span><br><span class="line">    &#125;</span><br><span class="line">    strClass = strClass.replace(<span class="regexp">/(^ +| +$)/g</span>, <span class="string">''</span>).replace(<span class="regexp">/ +/g</span>, <span class="string">'@@'</span>).replace(<span class="regexp">/(?:^|@)([\w-]+)(?:@|$)/g</span>, <span class="string">'(?=.*(^| +)$1( +|$).*)'</span>);</span><br><span class="line">    <span class="keyword">var</span> ary = [], reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(strClass),</span><br><span class="line">        nodeList = context.getElementsByTagName(<span class="string">'*'</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; nodeList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> curNode = nodeList[i];</span><br><span class="line">        reg.test(curNode.className) ? ary[ary.length] = curNode : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则的方式比较简单,但是正则不容易写出来,还有其他的方式</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getElementsByClass</span>(<span class="params">strClass, context</span>) </span>&#123;</span><br><span class="line">    context = context || <span class="built_in">document</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'getComputedStyle'</span> <span class="keyword">in</span> <span class="built_in">window</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [].slice.call(context.getElementsByClassName(strClass));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> ary = [], strClassAry = strClass.replace(<span class="regexp">/(^ +| +$)/g</span>, <span class="string">''</span>).split(<span class="regexp">/ +/g</span>);</span><br><span class="line">    <span class="keyword">var</span> nodeList = context.getElementsByTagName(<span class="string">'*'</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; nodeList.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> curNode = nodeList[i];</span><br><span class="line">        <span class="keyword">var</span> isTrue = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; strClassAry.length; j++) &#123;</span><br><span class="line">            <span class="keyword">var</span> curName = strClassAry[j];</span><br><span class="line">            <span class="keyword">if</span> (!hasClass(curNode, curName)) &#123;</span><br><span class="line">                isTrue = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isTrue) &#123;</span><br><span class="line">            ary.push(curNode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>以上实现了大部分的常用的DOM操作的兼容写法,目的不在于去实现<code>jQuery</code>中API,而是从原理上理解<code>jQuery API</code>的实现原理,锻炼个人的编程能力,升华编程思想.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;jQuery&lt;/code&gt; 是一个 &lt;code&gt;“写的更少，但做的更多”&lt;/code&gt; 的轻量级 &lt;code&gt;JavaScript&lt;/code&gt; 库.&lt;/p&gt;
&lt;p&gt;基本上，学习到如何选取 &lt;code&gt;HTML&lt;/code&gt; 元素,以及如何对它们执行类似隐藏、移动以及操作其内容等任务.&lt;/p&gt;
&lt;p&gt;这篇文章用原生JS实现&lt;code&gt;jQuery&lt;/code&gt;中大部分的&lt;code&gt;DOM操作&lt;/code&gt;的方法.&lt;/p&gt;
    
    </summary>
    
      <category term="JavaScript" scheme="/categories/JavaScript/"/>
    
    
      <category term="JS" scheme="/tags/JS/"/>
    
      <category term="jQuery" scheme="/tags/jQuery/"/>
    
      <category term="DOM操作" scheme="/tags/DOM%E6%93%8D%E4%BD%9C/"/>
    
  </entry>
  
</feed>
